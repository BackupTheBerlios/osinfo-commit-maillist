From lamikae at mail.berlios.de  Mon Mar  5 08:24:44 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Mon, 5 Mar 2007 08:24:44 +0100
Subject: [Osinfo-commit] r669 - in trunk/osinfo: lib modules
Message-ID: <200703050724.l257OiHQ009317@sheep.berlios.de>

Author: lamikae
Date: 2007-03-05 08:24:43 +0100 (Mon, 05 Mar 2007)
New Revision: 669

Modified:
   trunk/osinfo/lib/check.functions
   trunk/osinfo/lib/cmdline
   trunk/osinfo/lib/global_variables
   trunk/osinfo/modules/applications
Log:
added an array for missing dependencies

Modified: trunk/osinfo/lib/check.functions
===================================================================
--- trunk/osinfo/lib/check.functions	2006-12-22 13:36:51 UTC (rev 668)
+++ trunk/osinfo/lib/check.functions	2007-03-05 07:24:43 UTC (rev 669)
@@ -49,6 +49,7 @@
 		return 0
 	else
 		info    "Please install ${1} to collect this information"
+		Missing=("${Missing[@]}" "${1}" )
 		flush_values
 		return 1
 	fi
@@ -61,6 +62,7 @@
 CheckReq_lshw() {
 	if [ ! "$(type -p lshw)" ]; then
 		info    "Please install lshw to collect this information"
+		Missing=("${Missing[@]}" "lshw" )
 		flush_values
 		return 1
 	else
@@ -77,6 +79,7 @@
 CheckReq_dmidecode() {
 	if [ ! "$(type -p dmidecode)" ]; then
 		info    "Please install dmidecode to collect this information"
+		Missing=("${Missing[@]}" "dmidecode" )
 		flush_values
 		return 1
 	else
@@ -140,6 +143,7 @@
 			return 0
 		else
 			info	"Please install Smartmontools v5.36 or later."
+			Missing=("${Missing[@]}" "smartmontools" )
 			return 1
 		#fi
 	fi

Modified: trunk/osinfo/lib/cmdline
===================================================================
--- trunk/osinfo/lib/cmdline	2006-12-22 13:36:51 UTC (rev 668)
+++ trunk/osinfo/lib/cmdline	2007-03-05 07:24:43 UTC (rev 669)
@@ -71,7 +71,7 @@
 					fi
 					;;
 
-				'--listen')
+				'--listen'|'daemon')
 					# listen for incoming tcp connections,
 					# receive xml sheet from osinfo clients
 					tcpdaemon=1

Modified: trunk/osinfo/lib/global_variables
===================================================================
--- trunk/osinfo/lib/global_variables	2006-12-22 13:36:51 UTC (rev 668)
+++ trunk/osinfo/lib/global_variables	2007-03-05 07:24:43 UTC (rev 669)
@@ -12,6 +12,7 @@
 usexml=0 # by default, no not make xml 
 tcpsend=0 # by default, no not send via tcp
 
+
 ## GLOBAL USERSPACE VARIABLES
 isverbose=0
 isdebug=0
@@ -23,22 +24,25 @@
 tcpdaemon=0
 no_fancy=0
 
+
 ## chroot / virtual stuff
 prefix="/"  # The root dir. Using a variable allows info on chrooted systems
 
+
 ## Xorg log file ##
 ## this is used by the experimental "video" module
 [ ! "$XORG_LOG" ] && [ -e "/var/log/Xorg.0.log" ] && XORG_LOG="/var/log/Xorg.0.log"
 
-### temp file handling ###
+
+## temp file handling
 # allocate a universal temp file
 osinfo_tmp="$(mktemp /tmp/osinfo.XXXXXX)"
 TempFiles=("${TempFiles[@]}" "$osinfo_tmp")
-
 # Keeps track of open headers, and closes them in the correct order upon flush_values.
 OpenHeaders=()
 TempFiles=()
 Modules=()
+Missing=() # helper applications that aren't installed
 
 ### DAEMON MODE VARIABLES ###
 

Modified: trunk/osinfo/modules/applications
===================================================================
--- trunk/osinfo/modules/applications	2006-12-22 13:36:51 UTC (rev 668)
+++ trunk/osinfo/modules/applications	2007-03-05 07:24:43 UTC (rev 669)
@@ -12,7 +12,7 @@
 	local missing_ERRMSG="if you want to be able to use all modules of ${appname}"
 
 
-	## Applications to look for..
+	## Define the applications to look for
 	if [ "$SYSTEM" == "linux" ] ; then
 
 		APPLICATIONS="Graphical_interface: X kde-config gnome-about xfce4-session \
@@ -163,15 +163,19 @@
 				;;
 			'lspci')
 				info "please install pciutils ${missing_ERRMSG}"
+				Missing=("${Missing[@]}" "lspci" )
 				;;
 			'lshw')
 				info "please install lshw ${missing_ERRMSG}"
+				Missing=("${Missing[@]}" "lshw" )
 				;;
 			'smartctl')
 				info "please install smartmontools ${missing_ERRMSG}"
+				Missing=("${Missing[@]}" "smartmontools" )
 				;;
 			'dmidecode')
 				info "please install dmidecode ${missing_ERRMSG}"
+				Missing=("${Missing[@]}" "dmidecode" )
 				;;
 		esac
 	}



From lamikae at mail.berlios.de  Mon Mar  5 08:49:34 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 5 Mar 2007 08:49:34 +0100
Subject: [Osinfo-commit] r670 - trunk/osinfo
Message-ID: <200703050749.l257nYRZ011392@sheep.berlios.de>

Author: lamikae
Date: 2007-03-05 08:49:06 +0100 (Mon, 05 Mar 2007)
New Revision: 670

Added:
   trunk/osinfo/testi
Log:
testi


Added: trunk/osinfo/testi
===================================================================



From lamikae at mail.berlios.de  Mon Mar  5 08:49:54 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 5 Mar 2007 08:49:54 +0100
Subject: [Osinfo-commit] r671 - trunk/osinfo
Message-ID: <200703050749.l257nsoD011403@sheep.berlios.de>

Author: lamikae
Date: 2007-03-05 08:49:53 +0100 (Mon, 05 Mar 2007)
New Revision: 671

Removed:
   trunk/osinfo/testi
Log:
testi

Deleted: trunk/osinfo/testi
===================================================================



From lamikae at mail.berlios.de  Mon Mar  5 08:57:50 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 5 Mar 2007 08:57:50 +0100
Subject: [Osinfo-commit] r672 - trunk/osinfo/html
Message-ID: <200703050757.l257vo77011742@sheep.berlios.de>

Author: lamikae
Date: 2007-03-05 08:57:48 +0100 (Mon, 05 Mar 2007)
New Revision: 672

Added:
   trunk/osinfo/html/fade.php
   trunk/osinfo/html/index3.php
   trunk/osinfo/html/xml-parseri.php
   trunk/osinfo/html/xmltyyli.css
Log:
php

Added: trunk/osinfo/html/fade.php
===================================================================
--- trunk/osinfo/html/fade.php	2007-03-05 07:49:53 UTC (rev 671)
+++ trunk/osinfo/html/fade.php	2007-03-05 07:57:48 UTC (rev 672)
@@ -0,0 +1,32 @@
+<?php
+
+$uusi_kuva = new Haivytyskuva();
+
+class Haivytyskuva
+{
+	public function __construct()
+    	{
+		$this->nayta_haivytyskuva($_GET['w'], $_GET['h'], $_GET['r'], $_GET['g'], $_GET['b']);
+	}
+
+	private function nayta_haivytyskuva($leveys, $korkeus, $r, $g, $b)
+	{
+		if($leveys > 10) $leveys = 10;
+		if($korkeus > 300) $korkeus = 300;
+
+		//header("Content-type: image/png");
+		$kuva = @imagecreate($leveys, $korkeus);
+		
+		for ($i = 0; $i < 255; $i++) 
+			$vari[$i] = @imagecolorallocatealpha($kuva, $r, $g, $b, $i);
+		
+		for ($i = 0; $i < $leveys; $i++)
+			for ($j = 0; $j < $korkeus; $j++)
+				@imagesetpixel($kuva, $i, $j, $vari[(255/$korkeus) * $j/2]);
+		
+		@imagepng($kuva);
+		@imagedestroy($kuva);
+	}
+}
+
+?>
\ No newline at end of file

Added: trunk/osinfo/html/index3.php
===================================================================
--- trunk/osinfo/html/index3.php	2007-03-05 07:49:53 UTC (rev 671)
+++ trunk/osinfo/html/index3.php	2007-03-05 07:57:48 UTC (rev 672)
@@ -0,0 +1,234 @@
+<?php
+
+$index = new Index();
+
+$index->tulosta_alkukoodi(true);
+$index->nayta_sivuframe();
+$index->nayta_paaframe($_GET['target']);
+$index->tulosta_loppukoodi();
+
+class Index
+{
+	private $_DivResoluutiot = array("SivuFrame" => array('10px', '10px', '20%', '500'),
+					"P??Frame" => array('10px', '10px', '70%', '500'));
+	private $_xmlkansio = "hosts";
+	private $_xmlparseri = "xml-parseri.php";
+	private $_index_view = "index_view.html";
+
+	public function __construct()
+    	{
+
+	}
+
+	public function tulosta_alkukoodi($tyylit = true)
+	{
+		//print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
+
+		print "<html>\n";	
+		print "<head>\n";	
+		print "<title>Osinfo</title>\n\n";
+
+		if($tyylit) $this->tulosta_tyyli();
+
+		print "\n\n</head>\n\n";
+		print "<body>\n\n";
+	}
+
+	public function tulosta_loppukoodi()
+	{
+		print "</body>\n";
+		print "</html>";
+	}
+	
+	private function tulosta_tyyli()
+	{
+		$varit = array(222, 197, 148);
+		$varisyote = "r=" . $varit[0] . "&g=" . $varit[1] . "&b=" . $varit[2];
+
+		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
+		print "<style type=\"text/css\">
+
+		body
+		{
+			background-color: #eddcbc;
+		}
+		
+		div.SivuFrame, div.PaaFrame
+		{ 
+			float: left;
+		}
+		
+		div.SivuFrameSisalto, div.PaaFrame
+		{
+			background-color: rgb(" . $varit[0] . ", " . $varit[1] . ", " . $varit[2] . ");
+		}
+
+		div.SivuFrame
+		{
+			margin-left: " . $this->_DivResoluutiot[SivuFrame][0] . ";
+			margin-top: " . $this->_DivResoluutiot[SivuFrame][1] . ";
+			margin-bottom: " . $this->_DivResoluutiot[SivuFrame][1] . ";
+			width: " . $this->_DivResoluutiot[SivuFrame][2] . ";
+			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
+			min-width: 200;
+			height: auto;
+		}
+
+		div.SivuFrameSisalto
+		{
+			padding: 5px;
+			padding: 10px;
+		}
+
+		div.SivuFrameFade
+		{
+			background-image: url('fade.php?w=1&h=150&" . $varisyote . "');
+			background-repeat: repeat-x;
+			background-position: top;
+			height: 150px;
+		}
+
+		div.PaaFrame
+		{
+			border: 1px solid black;
+			padding: 5px;
+			padding: 10px;
+			margin-left: " . $this->_DivResoluutiot[P??Frame][0] . ";
+			margin-top: " . $this->_DivResoluutiot[P??Frame][1] . ";
+			margin-bottom: " . $this->_DivResoluutiot[P??Frame][1] . ";
+			width: " . $this->_DivResoluutiot[P??Frame][2] . ";
+			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
+			min-width: 600;
+			height: auto;
+			clear: none;
+		}
+
+		p.valitus
+		{
+			color: red;
+		}
+
+		</style>";
+	}
+	
+	private function listaa_tiedostot()
+	{
+		if(file_exists($this->_xmlkansio))
+		{
+			$kansio = opendir($this->_xmlkansio);
+		
+			for($i=0; $tiedosto = readdir($kansio); $i++)
+			{
+				$p_array = explode(".", $tiedosto);
+				$paate = $p_array[sizeof($p_array)-1];
+		
+				if($i > 1 && ($paate == "xml"))
+				{
+					print "<a href=\"?target=". $tiedosto . "\">" .
+						$tiedosto . "</a><br />";
+				}
+			}
+		}
+		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
+	}
+
+	private function hae_viimeksi_paivitetty()
+	{
+		if(file_exists($this->_xmlkansio))
+		{
+			$kansio = opendir($this->_xmlkansio);
+	
+			$suurin = 0;
+		
+			for($i=0; $tiedosto = readdir($kansio); $i++)
+			{
+				$p_array = explode(".", $tiedosto);
+				$paate = $p_array[sizeof($p_array)-1];
+		
+				if($i > 1 && ($paate == "xml"))
+				{
+					$aika = filemtime($this->_xmlkansio . "/" . $tiedosto);
+	
+					if($aika > $suurin)
+						$suurin = $aika;
+				}
+			}
+			
+			return $suurin;
+		}
+	}
+	
+	public function nayta_sivuframe()
+	{
+		print "<div class=\"SivuFrame\">";
+		print "<div class=\"SivuFrameSisalto\">";
+
+		print "<h3>Osinfo</h3>
+			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
+			<hr />";
+
+		$this->listaa_tiedostot();
+	
+		print "<hr />";
+
+		print "<p>Last updated:</p>";
+
+		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
+
+		if($viimeksi_paivitetty > 0)
+			print "<p>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</p>";
+
+		//include("sidebar.html");
+	
+		print "</div>";
+
+		print "<div class=\"SivuFrameFade\"></div>";
+
+		print "</div>";
+	}
+	
+	public function nayta_paaframe($sivu = "")
+	{
+		print "<div class=\"PaaFrame\">";
+		
+		if($sivu != "")
+		{
+			if(file_exists($this->_xmlparseri))
+			{
+				include($this->_xmlparseri);
+	
+				if(file_exists($this->_xmlkansio . "/" . $sivu))
+				{					
+					$parametrit = $_POST['osinfo'];
+				
+					print "<p>
+						<form action=\"" . $PHP_SELF . "\" method=\"post\">
+						Parameters: <input type=\"text\" name=\"osinfo\" value=\"" . $parametrit . "\" />
+							<input type=\"submit\" value=\"ok\" />
+						</form>
+						</p>";
+
+					$parseri = new xmlparseri($this->_xmlkansio . "/" . $sivu);
+		
+					print "<pre>";
+
+					//$parseri->nayta_tietotaulu();
+					$parseri->hae_arvot("osinfo", $parametrit);
+
+					print "</pre>";
+				}
+				else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
+			}
+			else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
+		}
+		else
+		{
+			if(file_exists($this->_index_view))
+				include($this->_index_view);
+		}
+
+		print "</div>";
+	}
+}
+
+?> 
\ No newline at end of file

Added: trunk/osinfo/html/xml-parseri.php
===================================================================
--- trunk/osinfo/html/xml-parseri.php	2007-03-05 07:49:53 UTC (rev 671)
+++ trunk/osinfo/html/xml-parseri.php	2007-03-05 07:57:48 UTC (rev 672)
@@ -0,0 +1,484 @@
+<?php
+
+class xmlparseri
+{
+    private $_parsittava_tiedosto;
+    private $_tiedoston_sisalto;
+    private $_tietotaulu = array();
+    private $_attribuutteja_rivilla = 3;
+
+    // "koodit"
+    private $_nimi = "--nimi--";
+    private $_parametrit = "--parametrit--";
+    private $_tyyppi = "--tyyppi--";
+    private $_sisalto = "--sisalto--";
+
+    // listan tunnistin
+    private $_lista = "lista";
+
+    public function __construct($tiedoston_nimi)
+    {
+	if(file_exists($tiedoston_nimi))
+	{
+		$this->_parsittava_tiedosto = $tiedoston_nimi;
+		$this->lue_tiedoston_sisalto();
+	
+		$this->_tietotaulu = $this->etsi_tagi("", 0);
+	}
+	else
+	{
+		print "<p>File " . $tiedoston_nimi . " not found</p>";
+	}
+    }
+
+    private function lue_tiedoston_sisalto()
+    {
+	$fp = fopen($this->_parsittava_tiedosto, "r");
+	$this->_tiedoston_sisalto = "";
+
+	while(false !== ($char = fgetc($fp))) 
+		$this->_tiedoston_sisalto .= $char;
+    }
+
+    public function nayta_tietotaulu()
+    {
+	print "<p>--------- KOKO TIETOTAULU:---------</p>";
+	print "<pre>";
+	print_r($this->_tietotaulu);
+	print "</pre>";
+    }
+
+    private function etsi_tagi($etsittava, $indeksi, $taso = -1)
+    {	
+	$taulu = array();	
+	$taso++;
+
+	for($i=$indeksi; $i < strlen($this->_tiedoston_sisalto); $i++)
+	{
+	     if($this->_tiedoston_sisalto[$i] == "<")
+	     {		  
+		  $tagi = "";
+	          
+		  for($j=$i+1; $j < strlen($this->_tiedoston_sisalto); $j++)
+		  {
+			if($this->_tiedoston_sisalto[$j] == "<") break;
+			if($this->_tiedoston_sisalto[$j] != ">")
+				$tagi .= $this->_tiedoston_sisalto[$j];
+			else break;
+		  }
+	
+		  $tietue = $this->tarkista_tagi($tagi);
+
+		  switch($tietue[$this->_tyyppi])
+		  {
+		       case 1:
+			    array_push($taulu, $tietue);
+		            break;
+		       case 2:
+			    $paluuarvot = $this->etsi_tagi($tietue[$this->_nimi], $j+1, $taso);
+			    $i = $paluuarvot['indeksi'];
+
+			    $this->array_lisaa_samaan($tietue, $paluuarvot['taulu']);
+			    $sisalto = "";
+	
+			    for($j += 1; $j < strlen($this->_tiedoston_sisalto); $j++)
+			    {
+				$char = ord($this->_tiedoston_sisalto[$j]);
+
+				if($char != 10 && $char != 13 && $char != 9 && 				$this->_tiedoston_sisalto[$j] != "<")
+				   $sisalto .= $this->_tiedoston_sisalto[$j];
+				elseif($this->_tiedoston_sisalto[$j] == "<") break;
+			    }
+				
+			    if(!empty($sisalto))
+			    {
+				$temp_array = array($this->_sisalto => $sisalto);
+				$this->array_lisaa_samaan($tietue, $temp_array);
+	 		    }
+
+			    array_push($taulu, $tietue);
+		            break;
+		       case 3:
+			    if($etsittava != "")
+			    {
+			    	if($tietue[$this->_nimi] == $etsittava)
+				     return array("taulu" => $taulu, "indeksi" => $i);
+			    }
+				
+		            break;
+		       case 4:
+			    array_push($taulu, $tietue);
+		            break;
+		       default:
+			    break;
+		  }
+	     }
+	}
+	return $taulu;
+    }
+
+    private function tarkista_tagi($tagi)
+    {    
+	$tyyppi = 0;
+	$nimi = "";
+	$parametrit = array();
+	$parametritagi = false;
+	
+	// tyypit: 1 = tiedoston tyyppitagi
+	//	   2 = aloitustagi
+	//	   3 = lopetustagi
+	//	   4 = yksin?inen tagi
+
+	for($i=strlen($tagi)-1; $i>0; $i--)
+	{
+	     if($tagi[$i] == "/" && $i > 0) 
+		$parametritagi = true;
+	}
+
+	if($tagi[0] == "!" || $tagi[0] == "?")
+ 	     $tyyppi = 1;
+	else 
+	{
+	     if($tagi[0] == "/") 
+	     {
+  		  $tyyppi = 3;
+
+		  for($i=0; $i < strlen($tagi); $i++)
+		     if($tagi[$i] != "/") $nimi .= $tagi[$i];
+	     }
+	     else
+	     {
+	          if($parametritagi) $tyyppi = 4;
+	          else $tyyppi = 2;
+
+		     for($i=0; $i < strlen($tagi); $i++)
+		     {
+		          if($i == 0)
+			  {
+				for($j=$i; $j < strlen($tagi); $j++)
+				{	
+				     if($tagi[$j] != " " &&
+				   	ord($tagi[$j]) != 9 && ord($tagi[$j]) != 10 &&
+				   	ord($tagi[$j]) != 13) $nimi .= $tagi[$j];
+				     else break;
+
+				     $i = $j;
+				}
+			  }
+
+			  $temp_atrb_nimi = "";
+			  $temp_atrb_arvo = "";
+			
+			  for($j=$i+2; $j < strlen($tagi); $j++)
+			  {	
+				if($j >= strlen($tagi)-1) break;
+				
+			        if($tagi[$j] != "=" && $tagi[$j] != " " &&
+				   	ord($tagi[$j]) != 9 && ord($tagi[$j]) != 10 &&
+				   	ord($tagi[$j]) != 13)
+			             $temp_atrb_nimi .= $tagi[$j];
+			        elseif($tagi[$j] == "=")
+				{
+				     if($tagi[$j+1] == "\"") $indeksi = $j+2;
+				     else $indeksi = $j+1;
+
+				     for($k=$indeksi; $k < strlen($tagi); $k++)
+				     {
+					if($tagi[$k] != "\"")
+					     $temp_atrb_arvo .= $tagi[$k];
+					else
+					{
+				     	     $j = $k - 1;
+					     break;
+					}
+				     }
+
+			             $i = $j;
+				     break;
+				}
+			        $i = $j;
+			  }
+
+			  if($temp_atrb_nimi != "") 
+			  {
+				$temp_array = array($temp_atrb_nimi => $temp_atrb_arvo);
+				$this->array_lisaa_samaan($parametrit, $temp_array);
+			  }
+		     }
+	     }
+	}
+	
+	if(empty($parametrit))
+		return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi);
+	else
+		return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi, 
+				$this->_parametrit => $parametrit);
+    }
+
+    private function array_lisaa_samaan(&$array) 
+    {
+	$argumentit = func_get_args();
+
+	foreach($argumentit as $argumentti) 
+	{
+		if(is_array($argumentti)) 
+		{
+			foreach($argumentti as $avain => $arvo) 
+			{
+				$array[$avain] = $arvo;
+				$paluuarvo++;
+			}
+		}
+	        else $array[$argumentti] = "";
+	}
+
+	return $paluuarvo;
+    }
+
+    public function hae_arvot($kanta, $attribuutit)
+    {
+	  $this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
+	  $this->esita_tiedot($esitettava_array, $attribuutit);
+    }
+
+    private function esita_tiedot($array, $tarkenne = "")
+    {
+	print "<h1>" . $array[$this->_nimi] . "</h1>";
+
+	$this->_attribuutti_avattu = false;
+	$this->_attribuutti_laskuri = 0;
+
+	if(is_array($array))
+	{
+		if($array[$this->_lista] == "true") $listatyyppi = true;
+		else $listatyyppi = false;
+
+		// k?y l?pi p??taulun kannasta l?htien
+		foreach($array as $avain => $arvo)
+		{
+			if(is_array($arvo)) 
+			{
+				if($tarkenne != "") $this->esita_alitiedot($arvo, $listatyyppi, false, $tarkenne);
+				else $this->esita_alitiedot($arvo, $listatyyppi, false);
+			}
+		}
+	}
+    }
+
+    private function esita_alitiedot($array, $listatyyppi = false, $attribuutti_avattu = false, $tarkenne = "", $paasy_alitauluihin = false, $attribuuttilaskuri = 0)
+    {
+	$div_avattu = false;
+	$attribuutti_suljettu = false;
+	$atrb = false;
+
+	if(is_array($array[$this->_parametrit]))
+	{
+		$temp_array = $array[$this->_parametrit];
+		if($temp_array[$this->_lista] == "true")
+			$listatyyppi = true;
+	}
+
+	//$listatyyppi = true;
+
+	foreach($array as $avain => $arvo)
+	{	
+		if($tarkenne != "" && $avain != $this->_tyyppi && $arvo == $tarkenne)
+			$paasy_alitauluihin = true;
+		elseif($tarkenne != "" && is_array($arvo)) 
+			$div = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne);
+
+		if($paasy_alitauluihin || $tarkenne == "")
+		{	
+			if($arvo == "attribute")
+			{
+				if(is_array($array))
+				{
+					if(!$listatyyppi)
+					{
+						if(!$attribuutti_avattu) 
+						{
+							print "<table class=\"attribuutti\" cellspacing=\"10\"><tr>";
+							$attribuutti_avattu = true;
+						}
+				
+						if($attribuuttilaskuri > 0 && 
+						$attribuuttilaskuri % $this->_attribuutteja_rivilla == 0) 
+							print "</tr><tr>";
+						
+						print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . 100 / $this->_attribuutteja_rivilla . "%\">";
+		
+						$this->esita_attribuutit($array, $array);
+
+						$attribuuttilaskuri++;
+		
+						print "</td>";
+		
+						break;
+					}
+					else
+					{
+						if(!$attribuutti_avattu) 
+						{
+							print "<table style=\"width: 100%\" border=\"1\">";
+							$attribuutti_avattu = true;
+						}
+
+						print "<tr>";
+		
+						$this->esita_attribuutit($array, $array, $listatyyppi);
+		
+						print "</tr>";
+		
+						break;
+					}
+				}
+			}
+			else
+			{	
+				if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $avain!= $this->_lista)
+				{	
+					if($avain == $this->_nimi)
+					{	
+						if($attribuutti_avattu) 
+						{
+							$attribuutti_avattu = false;
+							$attribuutti_suljettu = true;
+							$this->sulje_attribuutti($listatyyppi, $attribuuttilaskuri);
+							$attribuuttilaskuri = 0;
+						}
+
+						print "<div class=\"kentta\">";
+						print "<h2>" . $arvo . "</h2>";
+
+						$div_avattu = true;
+					}
+					else
+					{
+						print "<b>" . $avain . ":</b> " . $arvo . "<br />";
+					}
+				}
+
+				$this->esita_sisatiedot($arvo, $avain);	
+				
+				if(is_array($arvo) && $arvo[$this->_nimi] != "value")
+				{
+					if($tarkenne != "") 
+						$atrb = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne, true, $attribuuttilaskuri);
+					else 
+						$atrb = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, "", false, $attribuuttilaskuri);
+							
+					if($atrb) $attribuuttilaskuri++;
+				}
+			}
+			if($atrb) { $attribuutti_avattu = true; $attribuutti_suljettu = true; }
+		}
+	}
+
+	if($atrb && $attribuutti_suljettu) 
+	{ 
+		$this->sulje_attribuutti($listatyyppi, $attribuuttilaskuri);
+		$attribuutti_avattu = false;
+	}
+
+	if($div_avattu) print "</div>";
+
+	if($attribuutti_avattu && !$attribuutti_suljettu) return true;
+	else return false;
+    }
+
+    private function esita_attribuutit(&$palautus_array, $array, $listatyyppi = false)
+    {
+	foreach($array as $avain => $arvo)
+	{
+		if($avain === $this->_parametrit)
+			if(!$listatyyppi)
+				print "<h3>" . $arvo['name'] . "</h3>";
+			else 
+				print "<td><b>" . $arvo['name'] . "</b></td>";
+
+		$this->esita_sisatiedot($arvo, $avain, $listatyyppi);		
+	}
+    }
+
+    private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
+    {
+	if(!$listatyyppi)
+	{
+		for(; $attribuuttilaskuri % $this->_attribuutteja_rivilla != 0; $attribuuttilaskuri++)
+			print "<td>&nbsp;</td>";
+
+		print "</tr></table>";
+	}
+	else
+	{		
+		print "</table>";
+	}
+    }
+
+    private function esita_sisatiedot($array, $avain, $listatyyppi = false)
+    {
+	$sisalto = 0;
+	$desc = false;
+
+	if(is_array($array) && $avain !== $this->_parametrit)
+	{
+		$edellinen_arvo = "";
+
+		foreach($array as $avain2 => $arvo2)
+		{
+			if(!is_array($arvo2))
+			{
+				if($sisalto == 0) $sisalto = 1;
+
+				if(!$listatyyppi)
+				{
+					if($edellinen_arvo == "description")
+					{
+						$desc = true;
+						print "<p><i>" . $arvo2 . "</i></p>";
+					}
+					else
+						if($avain2 == $this->_sisalto)
+						{
+							print "<p>" . $arvo2 . "</p>";
+							$sisalto = 2;
+						}
+				}
+				else
+				{
+					if($edellinen_arvo == "description")
+					{
+						$desc = true;
+						print "<td><i>" . $arvo2 . "</i></td>";
+					}
+					else
+						if($avain2 == $this->_sisalto)
+						{
+							$sisalto = 2;
+							print "<td>" . $arvo2 . "</td>";
+						}
+				}
+				if($listatyyppi) print $sisalto;
+				$edellinen_arvo = $arvo2;
+			}
+		}
+	}
+	//if($listatyyppi) print "loppu";
+	if($desc && $sisalto == 1 && $listatyyppi)
+		print "jep";		
+//print "<td>tyhj?</td>";
+    }
+
+    private function hae_array($array, $etsittava, &$pal_array)
+    {
+   	foreach($array as $avain => $arvo)
+	{
+		if($avain === $this->_nimi && ($avain == $etsittava || $arvo == $etsittava))
+			$pal_array = $array;
+		else
+			if(is_array($arvo)) $this->hae_array($arvo, $etsittava, $pal_array);
+	}
+    }
+}
+
+?>

Added: trunk/osinfo/html/xmltyyli.css
===================================================================
--- trunk/osinfo/html/xmltyyli.css	2007-03-05 07:49:53 UTC (rev 671)
+++ trunk/osinfo/html/xmltyyli.css	2007-03-05 07:57:48 UTC (rev 672)
@@ -0,0 +1,27 @@
+div.kentta
+{
+	border: 1px dashed black;
+	margin-top: 10px;
+	padding: 0px 10px 10px 10px;
+
+	background-color: #e9fbf7;
+}
+
+table.attribuutti
+{
+	width: 100%;	
+}
+
+tr.jepaa
+{
+	border: 1px dashed black;
+	width: 100%;	
+}
+
+td.attribuutti_td
+{
+	margin: 5px 5px 5px 5px;
+	border: 1px dotted black;
+	padding: 7px;
+	background-color: #8db7ae;
+}



From lamikae at mail.berlios.de  Mon Mar  5 10:33:01 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Mon, 5 Mar 2007 10:33:01 +0100
Subject: [Osinfo-commit] r673 - in trunk/osinfo: . lib modules
Message-ID: <200703050933.l259X1vC021346@sheep.berlios.de>

Author: lamikae
Date: 2007-03-05 10:33:00 +0100 (Mon, 05 Mar 2007)
New Revision: 673

Modified:
   trunk/osinfo/lib/helper.functions
   trunk/osinfo/modules/dmi
   trunk/osinfo/osinfo
Log:
some major bugs in dmi module fixed

Modified: trunk/osinfo/lib/helper.functions
===================================================================
--- trunk/osinfo/lib/helper.functions	2007-03-05 07:57:48 UTC (rev 672)
+++ trunk/osinfo/lib/helper.functions	2007-03-05 09:33:00 UTC (rev 673)
@@ -50,6 +50,7 @@
 #	(2) input file
 #	(3) node closer, the end keyword, defaults to 'node id'
 extr_node() {
+
 	local node_id="${1}"
 	local input_file="${2}"
 	local node_closer="${3}"
@@ -78,18 +79,29 @@
 		# and end lines, based on indentation level (xml), echoing
 		# the results out
 		for nr in $(seq 1 1 $node_count); do
-			this_node="$(sed -n "$nr{p;q;}" <<< "${all_nodes}")"
 
+			# this sed gives me headache
+			this_node="$( sed -n "$nr{p;q;}" <<< "${all_nodes}" 2>/dev/null)"
+
 			# this gets the line number of the wanted node
 			local begin="$(awk -F: {'print $1'} <<< ${this_node})"
+
+			# this gets the indentation
 			# debug: the line below should work.
 			#local node_indent="$(awk -F: {'print $2'} <<< "${this_node}" | \
 			#		     grep -o '^[ ]*' | wc -m)"
 			# debug: let's debug this line further
-			local node_indent_dbg="$(awk -F: {'print $2'} <<< "${this_node}")"
-			local node_indent_dbg2="$(grep -o '^[ ]*' <<< "$node_indent_dbg")"
-			local node_indent="$(wc -m <<< "$node_indent_dbg2")"
+			local node_indent_dbg="$(awk -F: {'print $2'} <<< ${this_node})"
+			local node_indent_dbg2="$(grep -o '^[ ]*' <<< ${node_indent_dbg})"
 
+			# if the indentation is zero, the echo | wc -m still gives one.
+			# this line tries to override this bug
+			if [ "$node_indent_dbg2" ]; then
+				local node_indent="$(wc -m <<< ${node_indent_dbg2})"
+			else
+				local node_indent=0
+			fi
+
 			# this loop takes care that all subnodes are included, by comparing
 			# the indentation level. not very elegant..
 			# basically it just searches for $node_closer and gets the line#
@@ -119,7 +131,7 @@
 			# then what's between the first node and the closing id
 			# is echoed to whichever function called this
 			echo "%node $nr%"
-			sed -n "$begin,$nigeb{p;}" $input_file
+			sed -n "$begin,$nigeb{p;}" $input_file 2>/dev/null
 
 		done
 	fi

Modified: trunk/osinfo/modules/dmi
===================================================================
--- trunk/osinfo/modules/dmi	2007-03-05 07:57:48 UTC (rev 672)
+++ trunk/osinfo/modules/dmi	2007-03-05 09:33:00 UTC (rev 673)
@@ -1,9 +1,7 @@
+#!/bin/bash
 #######################
 # DMI / OEM INFORMATION
 #
-# NOTE: the structure is under construction!
-
-#
 # this module uses dmidecode to read BIOS information of OEM info.
 # look below for excerpt from 'man dmidecode':
 #
@@ -23,7 +21,10 @@
 		# 0x0003 or 0x0004 = 'Chassis Information'
 		# 0x0004 or 0x0005 = 'Processor Information'
 		# .... and more
+#
+# NOTE: the structure is under construction!
 
+
 Module_dmi() {
 	local moduleName="DMI information"
 	module_header "${moduleName}"
@@ -41,21 +42,24 @@
 }
 
 ##########################
-## dmi helper functions
+## dmi functions
 #
-# remember to run "dmi_info" before attempting to use these functions!
+# remember to add "extract_dmi" if you create a new function!
 
 	extract_dmi() {
 		# load dmi temp file
 		dmi_info
 
+		handle_desc="${1}"
+
 		# IFS need to be changed because the values are separated by newline
 		local IFS_bak="$IFS" value
 		IFS=$','
 
-		# extract the handle and string the first line
+		# extract the handle and strip the first line
 		# (%node% identifier that is useless here)
-		extr_node ${handle_desc} ${dmi_tmp_file} Handle | \
+
+		extr_node "$handle_desc" "${dmi_tmp_file}" 'Handle' | \
 			sed -n "2,\${p;}" > ${osinfo_tmp}
 
 		# because sometimes there's some extra info, head -n 5
@@ -71,14 +75,14 @@
 		local handle_desc='BIOS Information'
 
 		# extract the handle to a temp file
-		extract_dmi ${handle_desc} > ${osinfo_tmp}
+		extract_dmi "${handle_desc}" > ${osinfo_tmp}
 
 		add_header    "BIOS"
 
 		add_attribute 'Vendor'
 		add_values    "$(grep -i vendor ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Revision'	'bios_version'
@@ -87,14 +91,14 @@
 
 		add_attribute 'Date'	'bios_date'
 		add_values    "$(grep -i date ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Serial number'	'bios_serial_number'
 		add_values    "$(grep -i serial ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 		add_footer
 	}
@@ -109,35 +113,35 @@
 		add_header  "System info"
 
 		add_attribute 'Manufacturer' \
-					  'system_manufacturer'
+				  'system_manufacturer'
 		add_values    "$(grep -i manufacturer ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Model'	'system_model'
 		add_values    "$(grep -i product ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Version number'
 		add_values    "$(grep -i version ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'OEM serial number' \
-					  'computer_product_serial'
+				  'computer_product_serial'
 		add_values    "$(grep -i serial ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'UUID' 	'uuid'
 		add_values    "$(grep -i uuid ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 		add_footer
 	}
@@ -152,27 +156,27 @@
 		add_header    "Motherboard"
 
 		add_attribute 'Manufacturer' \
-					  'mother_board_manufacturer'
+				  'mother_board_manufacturer'
 		add_values    "$(get_mobo_manufacturer)"
 
 
 		add_attribute 'Model' \
-					  'mother_board_model'
+				  'mother_board_model'
 		add_values    "$(get_mobo_model)"
 
 
 		add_attribute 'Version' \
-					  'mother_board_version'
+				  'mother_board_version'
 		add_values    "$(grep -i version ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Serial number' \
-					  'mother_board_serial_number'
+				  'mother_board_serial_number'
 		add_values    "$(grep -i serial ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 		add_footer
 	}
@@ -188,45 +192,45 @@
 
 		add_attribute 'Manufacturer' 	'chassis_manufacturer'
 		add_values    "$(grep -i manufacturer ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Type' 	'chassis_type'
 		add_values    "$(grep -i type ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Version' 	'chassis_version'
 		add_values    "$(grep -i version ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Serial number' \
 					  'chassis_serial_number'
 		add_values    "$(grep -i serial ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 
 		add_attribute 'Lock' 	'chassis_lock'
 		add_values    "$(grep -i lock ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 		add_attribute 'Asset tag' 'chassis_asset_tag'
 		add_values    "$(grep -i asset ${osinfo_tmp} | \
-						 awk -F':' {'print $2'} | \
-						 sed 's/^\ *//')"
+				 awk -F':' {'print $2'} | \
+				 sed 's/^\ *//')"
 
 		add_footer
 	}
 
 		get_mobo_manufacturer() {
 			grep -i manufacturer ${osinfo_tmp} | \
-			awk -F':' {'print $2'} | sed 's/^\ *//'
+			 awk -F':' {'print $2'} | sed 's/^\ *//'
 		}
 
 		get_mobo_model() {
@@ -236,5 +240,5 @@
 
 		get_bios_revision() {
 			grep -i version ${osinfo_tmp} | \
-		    awk -F':' {'print $2'} | sed 's/^\ *//'
+			 awk -F':' {'print $2'} | sed 's/^\ *//'
 		}

Modified: trunk/osinfo/osinfo
===================================================================
--- trunk/osinfo/osinfo	2007-03-05 07:57:48 UTC (rev 672)
+++ trunk/osinfo/osinfo	2007-03-05 09:33:00 UTC (rev 673)
@@ -1,3 +1,4 @@
+#!/bin/bash
 ################################################################################
 ################################################################################
 ## MAIN FUNCTION                                                              ##
@@ -5,7 +6,7 @@
 ################################################################################
 
 ## source the necessary files
-source sources # lines beginning with "source" are removed in the all-in-one package
+source sources # lines beginning with "source" are removed during the Make process
 
 [ -e "/etc/osinfo.conf" ] && \
 . /etc/osinfo.conf                # the configuration file



From lamikae at mail.berlios.de  Tue Mar  6 11:28:07 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 11:28:07 +0100
Subject: [Osinfo-commit] r674 - in trunk/osinfo: lib modules
Message-ID: <200703061028.l26AS7s5018768@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 11:28:06 +0100 (Tue, 06 Mar 2007)
New Revision: 674

Modified:
   trunk/osinfo/lib/infostring.functions
   trunk/osinfo/lib/print.functions
   trunk/osinfo/modules/devices
   trunk/osinfo/modules/hdd
Log:
added the subheader tag ; some work on devices

Modified: trunk/osinfo/lib/infostring.functions
===================================================================
--- trunk/osinfo/lib/infostring.functions	2007-03-05 09:33:00 UTC (rev 673)
+++ trunk/osinfo/lib/infostring.functions	2007-03-06 10:28:06 UTC (rev 674)
@@ -75,17 +75,31 @@
 }
 # same as above, but without color. some modules use this because of
 # a bug in the 'column' program
+function add_nc_header() {
+	infostring[${#infostring[@]}]="%nc_header%${1};${2}"
+	# HACK: As syntax highlighting seems broken in my editor I add this comment hack as a workaround: "
+	OpenHeaders=("${OpenHeaders[@]}" "${1};${2}")
+}
+
+#################################
+# add_subheader, add_nc_subheader
 #
+# similar to add_header, but with indentation++
+#
 # Parameters: (example eth0)
 #   1 the header. will be printed to stdout and without $2 to xml as <eth0>
 #   2 xml syntax modifier. if "iface name", then xml tag will be <iface name="eth0">
-function add_nc_header() {
-	infostring[${#infostring[@]}]="%nc_header%${1};${2}"
+function add_subheader() {
+	infostring[${#infostring[@]}]="%subheader%${1};${2}"
 	# HACK: As syntax highlighting seems broken in my editor I add this comment hack as a workaround: "
 	OpenHeaders=("${OpenHeaders[@]}" "${1};${2}")
 }
+function add_nc_subheader() {
+	infostring[${#infostring[@]}]="%nc_subheader%${1};${2}"
+	# HACK: As syntax highlighting seems broken in my editor I add this comment hack as a workaround: "
+	OpenHeaders=("${OpenHeaders[@]}" "${1};${2}")
+}
 
-
 ##############
 # add_footer
 #

Modified: trunk/osinfo/lib/print.functions
===================================================================
--- trunk/osinfo/lib/print.functions	2007-03-05 09:33:00 UTC (rev 673)
+++ trunk/osinfo/lib/print.functions	2007-03-06 10:28:06 UTC (rev 674)
@@ -103,6 +103,7 @@
 	local header_color="${tcMAGENTA}"
 	local info_color="${tcYELLOW}"
 	local item itemnr value_string=""
+	local indentation=""
 
 	for itemnr in $(seq 1 1 ${#infostring[@]} ); do
 		((itemnr--)) # correct offset to start at zero
@@ -114,7 +115,7 @@
 				# add item to the value string,
 				# leaving the value identifier in
 				value_string="${value_string}${item}";
-			;;
+				;;
 
 			'value_footer')
 				# strip tag and discard the xml code tag
@@ -122,7 +123,8 @@
 				# add item to the value string,
 				# the preceding space is intentional.
 				value_string="${value_string} ${item}";
-			;;
+				indentation=""
+				;;
 
 			'attribute')
 				# strip tag and discard the xml code tag
@@ -130,8 +132,8 @@
 				        awk -F\; {'print $1'})"
 				# add item to the value string,
 				# each attribute starts with a newline
-				value_string="${value_string}\n${item}";
-			;;
+				value_string="${value_string}\n${indentation}${item}";
+				;;
 
 			'header')
 				# strip tag, do not care of the xml modifier
@@ -141,7 +143,7 @@
 				# each header starts with a newline,
 				# and is printed in special color
 				value_string="${value_string}\n${header_color}${item}${tSTD}";
-			;;
+				;;
 
 			'nc_header')
 				# strip tag
@@ -151,8 +153,36 @@
 				# each header starts with a newline,
 				# and is printed in special color
 				value_string="${value_string}\n${item}";
-			;;
+				;;
 
+			'subheader')
+				# strip tag, do not care of the xml modifier
+				item="$(sed 's/%subheader%//' <<< "${item}" | \
+				        awk -F\; {'print $1'} )"
+				# add item to the value string,
+				# each header starts with a newline,
+				# and is printed in special color.
+				# add indentation of two spaces
+				value_string="${value_string}\n \_ ${header_color}${item}${tSTD}";
+				indentation=" \__ "
+				;;
+
+			'nc_subheader')
+				# strip tag
+				item="$(sed s/%nc_subheader%// <<< "${item}" | \
+				        awk -F\; {'print $1'} )"
+				# add item to the value string,
+				# each header starts with a newline,
+				# and is printed in special color.
+				# add indentation of two spaces
+				value_string="${value_string}\n \_ ${item}";
+				indentation=" \__ "
+				;;
+
+			'footer')
+				indentation=""
+				;;
+
 			'info')
 				# strip tag
 				item="$(sed s/%info%// <<< "${item}")"
@@ -160,7 +190,7 @@
 				# each info note starts with a newline,
 				# and is printed in special color
 				value_string="${value_string}\n${info_color}${item}${tSTD}";
-			;;
+				;;
 
 		esac
 	done
@@ -197,6 +227,9 @@
 		item="${infostring[$itemnr]}"
 		idtag="$(awk -F% {'print $2'} <<< ${item})"
 
+		# nice debugging tool
+		#echo $item
+
 		# case by the "%identifier%" tag
 		case $idtag in
 
@@ -245,18 +278,19 @@
 						'attribute')
 							iddesc="$(awk -F% {'print $3'} <<< ${item})"
 							iddesc="$(awk -F\; {'print $1'} <<< ${iddesc})"
+							item="$(validate_xml_item "${item}")"
 							open_attribute_tag "$item"
 
 							add_indentation
 							xml_description "$iddesc"
 						;;
 
-						'header')
+						'header'|'subheader')
 							## add indentation
 							add_indentation
 
 							# strip tag
-							item="$(sed s/%header%// <<< "${item}")"
+							item="$(sed -r s/%\(sub\)?header%// <<< "${item}")"
 							code="$(awk -F\; {'print $2'} <<< "${item}" )"
 							item="$(awk -F\; {'print $1'} <<< "${item}" )"
 							item="$(validate_xml_item "${item}")"
@@ -321,8 +355,9 @@
 	}
 
 	validate_xml_item() {
+		# uppercase to lowercase ; spaces to downscores ; trim all leading spaces
 		awk -F\; {'print $1'} <<< "${1}" | \
-			sed 's/\\[a-z]//g; s/\ \|\//_/g' | tr 'A-Z' 'a-z'
+			sed 's/\\[a-z]//g; s/\ \|\//_/g ; s/^\ *//' | tr 'A-Z' 'a-z'
 	}
 #######
 

Modified: trunk/osinfo/modules/devices
===================================================================
--- trunk/osinfo/modules/devices	2007-03-05 09:33:00 UTC (rev 673)
+++ trunk/osinfo/modules/devices	2007-03-06 10:28:06 UTC (rev 674)
@@ -1,3 +1,4 @@
+#!/bin/bash
 #######################
 # DEVICES
 #
@@ -45,7 +46,7 @@
 	# load lshw xml temp file
 	lshw_xml
 
-	# get entries from lspci to $DEVICE[]
+	# get entries from lspci into the $DEVICE[] array
 	load_lspci_array
 
 	if CheckReq_root "motherboard and BIOS data"; then
@@ -66,7 +67,7 @@
 	#
 	# loads the categories to display
 	load_categories() {
-		CATEGORIES="Controllers Enhancements USB"
+		CATEGORIES="Enhancements USB"
 	}
 
 	#####################
@@ -79,10 +80,10 @@
 		# load the category definitions
 		load_categories
 
-		# print
+		# print each category
 		for categories in $CATEGORIES; do
 
-			add_header "\n$categories"
+			add_header "$categories"
 
 			case $categories in
 				'Controllers')
@@ -90,6 +91,7 @@
 					grep_lspci_array "smb\|bridge\|host\|ide\|isa\|usb"
 					flush_values
 					;;
+
 				'Enhancements')
 					DO_NOT_OUTPUT="^pci\|usb\|smb\|bridge\|ide\|isa\|host"
 					grep_lspci_array "."
@@ -115,12 +117,12 @@
 		add_header    "Motherboard"
 
 		add_attribute ' Manufacturer' \
-					  'mother_board_manufacturer'
+				  'mother_board_manufacturer'
 		add_values    "$(get_mobo_manufacturer)"
 		              # these functions are inherited from module_dmi
 
 		add_attribute ' Model' \
-					  'mother_board_model'
+				  'mother_board_model'
 		add_values    "$(get_mobo_model)"
 
 		# load BIOS info from dmi
@@ -130,11 +132,34 @@
 		add_attribute ' BIOS revision'	'bios_version'
 		add_values    "$(get_bios_revision)"
 
+		print_bridges;
+		print_interfaces;
+		print_controllers;
+
 		add_footer
 	}
 
+	####################
+	## Motherboard subcategories: bridges, controllers, interfaces
 
+	print_bridges(){
+		add_subheader 'Bridges'
+		add_attribute 'foo'
+		add_values 'bar'
+		add_footer 'Bridges'
+	}
 
+	print_controllers(){
+		add_subheader 'Controllers'
+		add_footer 'Controllers'
+	}
+
+	print_interfaces(){
+		add_subheader 'Interfaces'
+		add_footer 'Interfaces'
+
+	}
+
 	#####################
 	## load_lspci_array
 	#

Modified: trunk/osinfo/modules/hdd
===================================================================
--- trunk/osinfo/modules/hdd	2007-03-05 09:33:00 UTC (rev 673)
+++ trunk/osinfo/modules/hdd	2007-03-06 10:28:06 UTC (rev 674)
@@ -1,3 +1,4 @@
+#!/bin/bash
 #######################
 # HARD DISK DRIVES
 #
@@ -14,14 +15,14 @@
 	local moduleDescription="Information of the hard drives in the system"
 	module_header "${moduleName}"
 
-	# developement status:
+	# development status:
 	# -------------------
 	# IDE/PATA is tested
 	# SATA is tested
 	# USB (flash sticks and hard drives) is tested
 	# SCSI is untested, although works probably as SATA
 	# Software RAID is planned (mdadm only), untested
-	# Logical Volume Management support is planned, untested
+	# Logical Volume Management support is preliminary
 	# FreeBSD is untested
 
 



From lamikae at mail.berlios.de  Tue Mar  6 11:49:39 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 11:49:39 +0100
Subject: [Osinfo-commit] r675 - in trunk/osinfo: lib modules
Message-ID: <200703061049.l26Andx5020012@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 11:49:38 +0100 (Tue, 06 Mar 2007)
New Revision: 675

Modified:
   trunk/osinfo/lib/print.functions
   trunk/osinfo/modules/devices
Log:
fixed another ugly bug in module devices

Modified: trunk/osinfo/lib/print.functions
===================================================================
--- trunk/osinfo/lib/print.functions	2007-03-06 10:28:06 UTC (rev 674)
+++ trunk/osinfo/lib/print.functions	2007-03-06 10:49:38 UTC (rev 675)
@@ -228,7 +228,7 @@
 		idtag="$(awk -F% {'print $2'} <<< ${item})"
 
 		# nice debugging tool
-		#echo $item
+		echo $item
 
 		# case by the "%identifier%" tag
 		case $idtag in

Modified: trunk/osinfo/modules/devices
===================================================================
--- trunk/osinfo/modules/devices	2007-03-06 10:28:06 UTC (rev 674)
+++ trunk/osinfo/modules/devices	2007-03-06 10:49:38 UTC (rev 675)
@@ -54,7 +54,7 @@
 	fi
 
 	# output by category
-	print_categories
+#	print_categories
 
 	flush_values
 }
@@ -144,20 +144,20 @@
 
 	print_bridges(){
 		add_subheader 'Bridges'
-		add_attribute 'foo'
-		add_values 'bar'
+		grep_lspci_array "bridge"
 		add_footer 'Bridges'
 	}
 
 	print_controllers(){
 		add_subheader 'Controllers'
+		grep_lspci_array "controller"
 		add_footer 'Controllers'
 	}
 
 	print_interfaces(){
 		add_subheader 'Interfaces'
+		grep_lspci_array "interface"
 		add_footer 'Interfaces'
-
 	}
 
 	#####################
@@ -193,34 +193,22 @@
 		# grep the wanted nodes from the array into another array
 		for arraynr in $(seq 1 1 ${#devices[@]}); do
 
-			# if we have a hit (grep matches the device_id and we don't
-			# match the DO_NOT_PRINT expressions)
-				if [ "$(grep -i $device_id  <<< ${devices[$arraynr]} )" ] &&
-				[ -z "$(grep -i $DO_NOT_OUTPUT <<< ${devices[$arraynr]} )" ]; then
+			# if we have a hit (grep matches the device_id)
+			if [ "$(grep -i $device_id  <<< ${devices[$arraynr]} )" ]; then
 
-				description[${#description[@]}]="$(
-					awk  '{ print $1 }' <<< ${devices[$arraynr]} | \
-					sed 's/^.// ; s/^ *// ; s/_/ /g')"
+				# if the DO_NOT_OUTPUT is defined, go through the array
+				if [ $DO_NOT_OUTPUT ]; then
+					if [ -z "$(grep -i $DO_NOT_OUTPUT <<< ${devices[$arraynr]} )" ]; then
 
-				found_devices[${#found_devices[@]}]="$(
-					awk  '{ print $2" "$3 }' <<< ${devices[$arraynr]} | \
-					tr '_' ' ')"
+						catch_device
+					
+					fi
+				else
 
+					catch_device
 
-#				if [ "$(grep -i 'network\|ethernet' <<< "$description")" ]; then
-#
-#					# these values should not be local,
-#					# older bash fails there
-#					eth_adapter[${#eth_adapter[@]}]="$device"
-#
-#				elif [ "$(grep -i 'vga\|display' <<< "$description")" ]; then
-#
-#					video_adapter[${#video_adapter[@]}]="$device"
-#
-#				else
-#					found_devices[${#found_devices[@]}]="$found_device"
-#					unset found_device
-#				fi
+				fi
+
 			fi
 		done
 
@@ -258,11 +246,40 @@
 #			done
 #		fi
 
-#set -x
-		flush_values
 	}
 
 	#######################
+	# catch_device
+	#
+	# subroutine used by grep_lspci_array
+	catch_device() {
+		description[${#description[@]}]="$(
+			awk  '{ print $1 }' <<< ${devices[$arraynr]} | \
+			sed 's/^.// ; s/^ *// ; s/_/ /g')"
+
+		found_devices[${#found_devices[@]}]="$(
+			awk  '{ print $2" "$3 }' <<< ${devices[$arraynr]} | \
+			tr '_' ' ')"
+
+
+# 		if [ "$(grep -i 'network\|ethernet' <<< "$description")" ]; then
+# 
+# 			# these values should not be local,
+# 			# older bash fails there
+# 			eth_adapter[${#eth_adapter[@]}]="$device"
+# 
+# 		elif [ "$(grep -i 'vga\|display' <<< "$description")" ]; then
+# 
+# 			video_adapter[${#video_adapter[@]}]="$device"
+# 
+# 		else
+# 			found_devices[${#found_devices[@]}]="$found_device"
+# 			unset found_device
+# 		fi
+
+	}
+
+	#######################
 	## print_usb_devices
 	#
 	# prints the usb devices in the system's usb bus seen by lsusb



From lamikae at mail.berlios.de  Tue Mar  6 13:17:48 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 13:17:48 +0100
Subject: [Osinfo-commit] r676 - trunk/osinfo/modules
Message-ID: <200703061217.l26CHmJH005866@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 13:17:48 +0100 (Tue, 06 Mar 2007)
New Revision: 676

Modified:
   trunk/osinfo/modules/distro
Log:
debian version

Modified: trunk/osinfo/modules/distro
===================================================================
--- trunk/osinfo/modules/distro	2007-03-06 10:49:38 UTC (rev 675)
+++ trunk/osinfo/modules/distro	2007-03-06 12:17:48 UTC (rev 676)
@@ -1,3 +1,4 @@
+#!/bin/bash
 #######################
 # DISTRIBUTION
 #
@@ -10,37 +11,13 @@
 	# in other modules
 
 
-
-	# then call the subfunction
+	# call the subfunction
 	identify_Linux_distro
 
 
-	# then output what the was found..
+	# then output what was found..
+	print_distro_id
 
-	add_attribute 'Root dir'
-	add_values    "$root_dir"
-
-	[ "${distro_id}" ] && \
-		add_attribute 'Distro ID'
-		add_values    "${distro_id}"
-
-	[ "${distro_release}" ] && \
-		add_attribute 'Release'
-		add_values    "$distro_release"
-
-	[ "${distro_codename}" ] && \
-		add_attribute 'Codename'
-		add_values    "$distro_codename"
-
-	[ "${distro_description}" ] && \
-		add_attribute 'Description'
-		add_values    "$distro_description"
-
-	[ "$SlackwareBase" ] && \
-		add_values  'Based on Slackware version' \
-		            "$SlackwareBase"
-
-	flush_values
 }
 
 	## DISTRIBUTION SUBFUNCTIONS ##################################
@@ -84,17 +61,26 @@
 			distro_description="$(distro_lsb_release 'description')"
 
 		else
-
+			
 			# Begin searching for distro identifying files
 			local found_files="" myfile
-			for myfile in ${root_dir}etc/{SuSE-release,fedora-release,redhat-release,slackware-version,Topologilinux-version,gentoo-release,issue,rubix-release}; do
+			for myfile in ${root_dir}etc/{SuSE-release,fedora-release,redhat-release,slackware-version,Topologilinux-version,gentoo-release,rubix-release,debian_version,issue}; do
 				[ -e $myfile ] && found_files="$found_files $myfile"
 			done
 
 			# Now make a list of distros from the $found_files list above
 			local found_distros="" distro_ident
 			for distro_ident in $found_files; do
+
 				case $distro_ident in
+					"${root_dir}etc/gentoo-release")
+						found_distros="$found_distros Gentoo"
+						break
+						;;
+					"${root_dir}etc/debian_version")
+						found_distros="$found_distros Debian"
+						break
+						;;
 					"${root_dir}etc/SuSE-release")
 						found_distros="$found_distros SuSE"
 						break
@@ -115,10 +101,6 @@
 						found_distros="$found_distros Topologilinux"
 						break
 						;;
-					"${root_dir}etc/gentoo-release")
-						found_distros="$found_distros Gentoo"
-						break
-						;;
 					"${root_dir}etc/rubix-release")
 						found_distros="$found_distros Rubix"
 						break
@@ -194,29 +176,80 @@
 				esac
 
 
-			# Output distro version
+			# Find distro release version
 			case "${found_distros}" in
+				'Gentoo')
+					# AnMaster: Not sure if readlink is POSIX but it exists on Gentoo,
+					# and we already know this is Gentoo.
+					distro_release="$(readlink /etc/make.profile | grep -Eo '[0-9]{4}\.[0-9]')"
+					;;
+
+				'Debian')
+					distro_release="Debian $(cat ${root_dir}etc/debian_version)"
+					;;
+
 				'SuSE')
-					distro_release="$(grep -F 'VERSION = ' ${root_dir}etc/SuSE-release          | sed 's/VERSION = //'    )" ;;
+					distro_release="$(grep -F 'VERSION = ' ${root_dir}etc/SuSE-release | \
+					                  sed 's/VERSION = //'    )"
+					;;
+
 				'Red Hat')
-					distro_release="$(cat ${root_dir}etc/redhat-release)" ;;
+					distro_release="$(cat ${root_dir}etc/redhat-release)"
+					;;
+
 				'Fedora')
-					distro_release="$(cat ${root_dir}etc/fedora-release)" ;;
+					distro_release="$(cat ${root_dir}etc/fedora-release)"
+					;;
+
 				'Slackware')
-					distro_release="$(grep -F 'Slackware ' ${root_dir}etc/slackware-version     | sed 's/Slackware //'    )" ;;
+					distro_release="$(grep -F 'Slackware ' ${root_dir}etc/slackware-version | \
+					                  sed 's/Slackware //'    )"
+					;;
+
 				'Topologilinux')
-					distro_release="$(grep -F 'Topologilinux ' ${root_dir}etc/Topologilinux-version | sed 's/Topologilinux //')"
-					local  SlackwareBase="$(grep -F 'Slackware  '${root_dir}etc/slackware-version     | sed 's/Slackware //'    )" ;;
-				'Gentoo')
-					# AnMaster: Not sure if readlink is POSIX but it exists on Gentoo and we allready know this is Gentoo.
-					distro_release="$(readlink /etc/make.profile | grep -Eo '[0-9]{4}\.[0-9]')";;
+					distro_release="$(grep -F 'Topologilinux ' ${root_dir}etc/Topologilinux-version | \
+					                  sed 's/Topologilinux //')"
+					local SlackwareBase="$(grep -F 'Slackware  '${root_dir}etc/slackware-version     | \
+					                       sed 's/Slackware //'    )"
+					;;
+
 				'misc')
 					# FIXME: AnMaster: . is a wildcard meaning any single char. Isn't grep -F what you want?
-					distro_release="$(grep '.' "${root_dir}etc/issue" | grep -Eo '([A-Za-z0-9 ."])+' | head -n 1 )";;
 					# TODO: improve the grep
+					distro_release="$(grep '.' "${root_dir}etc/issue" | \
+					                  grep -Eo '([A-Za-z0-9 ."])+' | head -n 1 )"
+					;;
+
 			esac
 
 		fi
 	}
+
+	print_distro_id() {
+		add_attribute 'Root dir'
+		add_values    "$root_dir"
+
+		[ "${distro_id}" ] && \
+			add_attribute 'Distro ID'
+			add_values    "${distro_id}"
+
+		[ "${distro_release}" ] && \
+			add_attribute 'Release'
+			add_values    "$distro_release"
+
+		[ "${distro_codename}" ] && \
+			add_attribute 'Codename'
+			add_values    "$distro_codename"
+
+		[ "${distro_description}" ] && \
+			add_attribute 'Description'
+			add_values    "$distro_description"
+
+		[ "$SlackwareBase" ] && \
+			add_values  'Based on Slackware version' \
+				"$SlackwareBase"
+
+		flush_values
+	}
 	#############################################################
 



From lamikae at mail.berlios.de  Tue Mar  6 13:27:48 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 13:27:48 +0100
Subject: [Osinfo-commit] r677 - trunk/osinfo/modules
Message-ID: <200703061227.l26CRmEr006745@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 13:27:47 +0100 (Tue, 06 Mar 2007)
New Revision: 677

Modified:
   trunk/osinfo/modules/hdd
Log:
fixed a serious bug in module HDD caused by unknown devices

Modified: trunk/osinfo/modules/hdd
===================================================================
--- trunk/osinfo/modules/hdd	2007-03-06 12:17:48 UTC (rev 676)
+++ trunk/osinfo/modules/hdd	2007-03-06 12:27:47 UTC (rev 677)
@@ -36,7 +36,7 @@
 		# allocate a temp file
 		fdisk_info="$(mktemp /tmp/osinfo.XXXXXX)"
 		TempFiles=("${TempFiles[@]}" "$fdisk_info")
-		fdisk -l > $fdisk_info
+		fdisk -l > $fdisk_info 2> /dev/null
 
 		# detect all drives in the system
 		local drives="$(grep -Eo '\/(dev)\/[a-z]+' ${fdisk_info} | uniq )"
@@ -86,13 +86,14 @@
 
 			else
 
-				hdd_type="Unknown drive type"
+				hdd_type="unknown"
 
 			fi
 
 
 			###############################
 			# scan common attributes
+			[ "$hdd_type" != "unknown" ] && \
 			scan_hdd_common ${drvdev}
 
 
@@ -104,11 +105,13 @@
 			# the next run of this function. this would be easily
 			# fixed if bash would support matrices, but no.
 			hdd_pt_ID=0
+			[ "$hdd_type" != "unknown" ] && \
 			scan_hdd_partitions ${drvdev}
 
 
 			##############################################
 			# calculate the total disk capacity of $drvdev
+			[ "$hdd_type" != "unknown" ] && \
 			calculate_hdd_usage
 
 
@@ -154,6 +157,17 @@
 	##############################################
 	# PRINTS DRIVE DATA
 	print_hdd_data() {
+		# if the drive type is unknown, let's get it out of the way first..
+		if [ "$hdd_type" == "unknown" ]; then
+
+			add_header  "${drvdev}"
+			add_attribute "Drive type"
+			add_values    "unknown"
+			add_footer
+
+			break;
+		fi
+		
 		case "$output_mode" in
 			'stdout')	# standard output
 



From lamikae at mail.berlios.de  Tue Mar  6 13:43:37 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 13:43:37 +0100
Subject: [Osinfo-commit] r678 - in trunk/osinfo/modules: . deprecated
	experimental
Message-ID: <200703061243.l26Chbip007834@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 13:43:36 +0100 (Tue, 06 Mar 2007)
New Revision: 678

Added:
   trunk/osinfo/modules/deprecated/
   trunk/osinfo/modules/deprecated/oem
Removed:
   trunk/osinfo/modules/experimental/oem
Log:
moved module oem to deprecated

Copied: trunk/osinfo/modules/deprecated/oem (from rev 675, trunk/osinfo/modules/experimental/oem)
===================================================================
--- trunk/osinfo/modules/experimental/oem	2007-03-06 10:49:38 UTC (rev 675)
+++ trunk/osinfo/modules/deprecated/oem	2007-03-06 12:43:36 UTC (rev 678)
@@ -0,0 +1,223 @@
+#!/bin/bash
+######################
+# OEM INFORMATION
+# this module is deprecated in favor of module_dmi
+#
+# this module collects information from lshw, a somewhat rare package, which
+# tells a lot of interesting information of the system hardware.  it also seems
+# to be the only way to get the serial number of a branded computer, thus 'oem
+# info'. below is an excerpt from 'man lshw'
+#
+# lshw  is a small tool to extract detailed information on the hardware
+# configuration of the machine. It can report exact memory configuration,
+# firmware version, mainboard configuration, CPU version and  speed,  cache
+# configuration,  bus  speed, etc. on DMI-capable x86 or IA-64 systems and on
+# some PowerPC machines (PowerMac G4 is known to work).  It currently supports
+# DMI (x86 and IA-64 only), OpenFirmware device tree (PowerPC only),  PCI/AGP,
+# CPUID  (x86),IDE/ATA/ATAPI, PCMCIA (only tested on x86), SCSI and USB.
+Module_oem() {
+	local moduleName="OEM information"
+	module_header "${moduleName}"
+
+	if lshw_xml && CheckReq_root; then
+
+		# the interesting entries:
+		# $hostname
+		# core
+		# firmware
+
+		local NODES="$(hostname) core firmware"
+		#local NODES="memory"
+
+
+		oem_tmp="$(mktemp /tmp/osinfo.XXXXXX)"
+		TempFiles=("${TempFiles[@]}" "$oem_tmp" )
+
+		# following loop extracts the data under the nodes variable.
+
+		# (1) get the line number where the 'node id=$NODES'
+		# (2) get the line number of the next 'node id'
+		# (3) everything in between those lines contains interesting data
+
+		for myNODE in $NODES; do
+
+			extr_lshw_node $myNODE > $oem_tmp
+
+			local IFSbk="$IFS"
+			IFS=$'\n'
+
+			#for info in $(); do
+			for info in $(cat $oem_tmp); do
+
+				# the data is available here, printed line by line.
+				# usually the fields are:
+
+				# <description>
+				# <product>
+				# <vendor>
+				# <version>
+				# <serial>
+
+				# then there special fields. see 'lshw -xml'
+
+				# parse standard <foo> tags
+				# TODO: add support for capabilities tags
+				local tag="$(grep -o '<[a-z]*>' <<< ${info} | \
+							sed 's/<\([^>]*\)>/\1/')"
+							# matched everything between '<' and '>'
+
+				[ "$tag" ] && \
+				local value="$(grep ${tag} <<< ${info} | \
+							awk -F'<|>' {'print $3'})"
+
+				# here the data is processed
+				case $myNODE in
+
+					"$(hostname)")	# OEM info
+
+						if [ "$printed" != "oem" ]; then
+							add_attribute	"OEM info"
+							local printed="oem"
+						fi
+
+						case $tag in
+
+							'description')
+
+								add_attribute 'System model' \
+								              'system_model'
+								add_values    "$value"
+								;;
+
+							'vendor')
+
+								add_attribute 'System manufacturer' \
+								              'system_manufacturer'
+								add_values    "$value"
+								;;
+
+							'product')
+
+								add_attribute 'System name'
+								add_values    "$value"
+								;;
+
+							'version')
+
+								add_attribute 'System version'
+								add_values    "$value"
+								;;
+
+							'serial')
+
+								add_attribute 'OEM serial number' \
+								              'computer_product_serial'
+								add_values    "$value"
+								;;
+
+							#*)
+
+								#add_attribute "$tag"
+								#add_values    "$value"
+								#;;
+
+						esac
+
+						#value_footer
+						;;
+
+					'core')			# mobo info
+
+						if [ "$printed" != "mobo" ]; then
+							add_attribute	"Motherboard"
+							local printed="mobo"
+						fi
+
+						case $tag in
+
+							'vendor')
+
+								add_attribute 'Make'
+								add_values    "$value"
+								;;
+
+							'product')
+
+								add_attribute 'Model'
+								add_values    "$value"
+								;;
+
+							'version')
+
+								add_attribute 'Revision'
+								add_values    "$value"
+								;;
+
+							'serial')
+								add_attribute 'Serial number' \
+								              'mother_board_serial_number'
+								add_values    "$value"
+								;;
+
+						esac
+
+						#value_footer
+						;;
+
+					'firmware')		# BIOS info
+
+						if [ "$printed" != "bios" ]; then
+							add_attribute	"BIOS"
+							local printed="bios"
+						fi
+
+						case $tag in
+
+							'vendor')
+
+								add_attribute 'Vendor'
+								add_values    "$value"
+								;;
+
+							'version')
+
+								add_attribute 'Revision'	'bios_version'
+								add_values    "$value"
+
+								# trying to extract date from version
+								add_attribute 'Date'	'bios_date'
+								add_values    "$(echo $value | \
+								                 grep -Eo '([0-9]{2,4}[-./][0-9]{2}[-./][0-9]{2,4})+')"
+								;;
+
+							'date')
+
+								add_attribute 'Date'	'bios_date'
+								add_values    "$value"
+
+								;;
+
+							'serial')
+								add_attribute 'Serial number' \
+								              'bios_serial_number'
+								add_values    "$value"
+								;;
+
+						esac
+
+						#value_footer
+						# this produces an eternal loop
+						;;
+
+				esac
+
+			done
+
+			IFS="$IFSbk"
+
+		done
+	fi
+
+	flush_values
+}
+

Deleted: trunk/osinfo/modules/experimental/oem
===================================================================
--- trunk/osinfo/modules/experimental/oem	2007-03-06 12:27:47 UTC (rev 677)
+++ trunk/osinfo/modules/experimental/oem	2007-03-06 12:43:36 UTC (rev 678)
@@ -1,222 +0,0 @@
-######################
-# OEM INFORMATION
-# this module is deprecated in favor of module_dmi
-#
-# this module collects information from lshw, a somewhat rare package, which
-# tells a lot of interesting information of the system hardware.  it also seems
-# to be the only way to get the serial number of a branded computer, thus 'oem
-# info'. below is an excerpt from 'man lshw'
-#
-# lshw  is a small tool to extract detailed information on the hardware
-# configuration of the machine. It can report exact memory configuration,
-# firmware version, mainboard configuration, CPU version and  speed,  cache
-# configuration,  bus  speed, etc. on DMI-capable x86 or IA-64 systems and on
-# some PowerPC machines (PowerMac G4 is known to work).  It currently supports
-# DMI (x86 and IA-64 only), OpenFirmware device tree (PowerPC only),  PCI/AGP,
-# CPUID  (x86),IDE/ATA/ATAPI, PCMCIA (only tested on x86), SCSI and USB.
-Module_oem() {
-	local moduleName="OEM information"
-	module_header "${moduleName}"
-
-	if lshw_xml && CheckReq_root; then
-
-		# the interesting entries:
-		# $hostname
-		# core
-		# firmware
-
-		local NODES="$(hostname) core firmware"
-		#local NODES="memory"
-
-
-		oem_tmp="$(mktemp /tmp/osinfo.XXXXXX)"
-		TempFiles=("${TempFiles[@]}" "$oem_tmp" )
-
-		# following loop extracts the data under the nodes variable.
-
-		# (1) get the line number where the 'node id=$NODES'
-		# (2) get the line number of the next 'node id'
-		# (3) everything in between those lines contains interesting data
-
-		for myNODE in $NODES; do
-
-			extr_lshw_node $myNODE > $oem_tmp
-
-			local IFSbk="$IFS"
-			IFS=$'\n'
-
-			#for info in $(); do
-			for info in $(cat $oem_tmp); do
-
-				# the data is available here, printed line by line.
-				# usually the fields are:
-
-				# <description>
-				# <product>
-				# <vendor>
-				# <version>
-				# <serial>
-
-				# then there special fields. see 'lshw -xml'
-
-				# parse standard <foo> tags
-				# TODO: add support for capabilities tags
-				local tag="$(grep -o '<[a-z]*>' <<< ${info} | \
-							sed 's/<\([^>]*\)>/\1/')"
-							# matched everything between '<' and '>'
-
-				[ "$tag" ] && \
-				local value="$(grep ${tag} <<< ${info} | \
-							awk -F'<|>' {'print $3'})"
-
-				# here the data is processed
-				case $myNODE in
-
-					"$(hostname)")	# OEM info
-
-						if [ "$printed" != "oem" ]; then
-							add_attribute	"OEM info"
-							local printed="oem"
-						fi
-
-						case $tag in
-
-							'description')
-
-								add_attribute 'System model' \
-								              'system_model'
-								add_values    "$value"
-								;;
-
-							'vendor')
-
-								add_attribute 'System manufacturer' \
-								              'system_manufacturer'
-								add_values    "$value"
-								;;
-
-							'product')
-
-								add_attribute 'System name'
-								add_values    "$value"
-								;;
-
-							'version')
-
-								add_attribute 'System version'
-								add_values    "$value"
-								;;
-
-							'serial')
-
-								add_attribute 'OEM serial number' \
-								              'computer_product_serial'
-								add_values    "$value"
-								;;
-
-							#*)
-
-								#add_attribute "$tag"
-								#add_values    "$value"
-								#;;
-
-						esac
-
-						#value_footer
-						;;
-
-					'core')			# mobo info
-
-						if [ "$printed" != "mobo" ]; then
-							add_attribute	"Motherboard"
-							local printed="mobo"
-						fi
-
-						case $tag in
-
-							'vendor')
-
-								add_attribute 'Make'
-								add_values    "$value"
-								;;
-
-							'product')
-
-								add_attribute 'Model'
-								add_values    "$value"
-								;;
-
-							'version')
-
-								add_attribute 'Revision'
-								add_values    "$value"
-								;;
-
-							'serial')
-								add_attribute 'Serial number' \
-								              'mother_board_serial_number'
-								add_values    "$value"
-								;;
-
-						esac
-
-						#value_footer
-						;;
-
-					'firmware')		# BIOS info
-
-						if [ "$printed" != "bios" ]; then
-							add_attribute	"BIOS"
-							local printed="bios"
-						fi
-
-						case $tag in
-
-							'vendor')
-
-								add_attribute 'Vendor'
-								add_values    "$value"
-								;;
-
-							'version')
-
-								add_attribute 'Revision'	'bios_version'
-								add_values    "$value"
-
-								# trying to extract date from version
-								add_attribute 'Date'	'bios_date'
-								add_values    "$(echo $value | \
-								                 grep -Eo '([0-9]{2,4}[-./][0-9]{2}[-./][0-9]{2,4})+')"
-								;;
-
-							'date')
-
-								add_attribute 'Date'	'bios_date'
-								add_values    "$value"
-
-								;;
-
-							'serial')
-								add_attribute 'Serial number' \
-								              'bios_serial_number'
-								add_values    "$value"
-								;;
-
-						esac
-
-						#value_footer
-						# this produces an eternal loop
-						;;
-
-				esac
-
-			done
-
-			IFS="$IFSbk"
-
-		done
-	fi
-
-	flush_values
-}
-



From lamikae at mail.berlios.de  Tue Mar  6 13:48:28 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 13:48:28 +0100
Subject: [Osinfo-commit] r679 - in trunk/osinfo: . modules profiles
Message-ID: <200703061248.l26CmSVh008060@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 13:48:27 +0100 (Tue, 06 Mar 2007)
New Revision: 679

Modified:
   trunk/osinfo/modules/aa_INDEX
   trunk/osinfo/profiles/default
   trunk/osinfo/sources
Log:
module module oem cleared

Modified: trunk/osinfo/modules/aa_INDEX
===================================================================
--- trunk/osinfo/modules/aa_INDEX	2007-03-06 12:43:36 UTC (rev 678)
+++ trunk/osinfo/modules/aa_INDEX	2007-03-06 12:48:27 UTC (rev 679)
@@ -1,3 +1,4 @@
+#!/bin/bash
 ################################################################################
 ################################################################################
 ## OSINFO MODULES                                                             ##
@@ -7,13 +8,13 @@
 
 # these are used to control run access and validify against
 
-MODULES_LINUX='system distro kernel processor ram memory hdd network wlan dmi applications terminal devices cdrom users services battery oem'
+MODULES_LINUX='system distro kernel processor ram memory hdd network wlan dmi applications terminal devices cdrom users services battery'
 MODULES_BSD='system kernel applications terminal network devices dmi'
 MODULES_BROKEN='printers lvm bus sensors nagios samba nfs shares'
-MODULES_REAL_ROOT_ONLY='system memory cdrom processor terminal applications network wlan devices services hdd printers dmi services bus battery oem ram'
-MODULES_SU_ONLY='cdrom hdd dmi oem'
+MODULES_REAL_ROOT_ONLY='system memory cdrom processor terminal applications network wlan devices services hdd printers dmi services bus battery ram'
+MODULES_SU_ONLY='cdrom hdd dmi'
 # MUST contain a list of all modules. This is used to find any invalid modules.
-MODULES_ALL='applications cdrom devices distro dmi env hdd kernel memory network oem printers processor services system terminal users wlan lvm bus sensors nagios battery video ram samba nfs shares'
+MODULES_ALL='applications cdrom devices distro dmi env hdd kernel memory network printers processor services system terminal users wlan lvm bus sensors nagios battery video ram samba nfs shares'
 
 
 ## META-MODULES

Modified: trunk/osinfo/profiles/default
===================================================================
--- trunk/osinfo/profiles/default	2007-03-06 12:43:36 UTC (rev 678)
+++ trunk/osinfo/profiles/default	2007-03-06 12:48:27 UTC (rev 679)
@@ -1,3 +1,4 @@
+#!/bin/bash
 #################################
 ## Default profile
 #

Modified: trunk/osinfo/sources
===================================================================
--- trunk/osinfo/sources	2007-03-06 12:43:36 UTC (rev 678)
+++ trunk/osinfo/sources	2007-03-06 12:48:27 UTC (rev 679)
@@ -1,6 +1,7 @@
 for module in modules/* modules/experimental/*; do
-	[ "$module" != "modules/experimental" ] && \
+	if ( [ "$module" != "modules/experimental" ] && [ "$module" != "modules/deprecated" ] ); then
 		source $module
+	fi
 done
 
 source lib/version                # osinfo version info



From lamikae at mail.berlios.de  Tue Mar  6 14:06:37 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 14:06:37 +0100
Subject: [Osinfo-commit] r680 - in trunk/osinfo: lib modules
Message-ID: <200703061306.l26D6b84009551@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 14:06:37 +0100 (Tue, 06 Mar 2007)
New Revision: 680

Modified:
   trunk/osinfo/lib/PRINT_Version
   trunk/osinfo/lib/print.functions
   trunk/osinfo/lib/xml.functions
   trunk/osinfo/modules/devices
Log:
device xml is now fairly clean

Modified: trunk/osinfo/lib/PRINT_Version
===================================================================
--- trunk/osinfo/lib/PRINT_Version	2007-03-06 12:48:27 UTC (rev 679)
+++ trunk/osinfo/lib/PRINT_Version	2007-03-06 13:06:37 UTC (rev 680)
@@ -2,8 +2,9 @@
 	echo "${tBOLD}${appname}${tSTD}-${major_version}.${minor_version}.${micro_version}-${patch_version} ${dev_status}"
 	#[ "$dev_status" == "stable" ] && \
 	echo "Release date: "$(date -d $release_date +%A\ %e\ %B\ %Y)
-	echo 'Copyright (C) 2005-2006 Arvid Norlander'
-	echo 'Copyright (C) 2006 Mikael Lammentausta'
+	echo 'Copyright (C) 2005, 2006 Arvid Norlander'
+	echo '              2006, 2007 Mikael Lammentausta'
+	echo '                    2007 Lauri Miettinen'
 	echo
 	echo "This is free software; see the source for copying conditions."
 	echo

Modified: trunk/osinfo/lib/print.functions
===================================================================
--- trunk/osinfo/lib/print.functions	2007-03-06 12:48:27 UTC (rev 679)
+++ trunk/osinfo/lib/print.functions	2007-03-06 13:06:37 UTC (rev 680)
@@ -228,7 +228,7 @@
 		idtag="$(awk -F% {'print $2'} <<< ${item})"
 
 		# nice debugging tool
-		echo $item
+		# echo $item
 
 		# case by the "%identifier%" tag
 		case $idtag in
@@ -242,7 +242,7 @@
 				# send the preceding value and the footer to xmlfile.
 				xml_value "$value_item ${item}"
 				unset value_item
-			;;
+				;;
 
 			# add everything else but the footer
 			*)
@@ -264,7 +264,7 @@
 					value_item="$(sed 's/%value%// ; s/\\[a-z]//g;s/^ *//' <<< "${item}")"
 
 					#xml_value "${item}" >> "${XMLFILE}"
-				;;
+					;;
 
 				*)
 
@@ -276,14 +276,15 @@
 					case $idtag in
 
 						'attribute')
+							# extract the XML <description> tag
 							iddesc="$(awk -F% {'print $3'} <<< ${item})"
 							iddesc="$(awk -F\; {'print $1'} <<< ${iddesc})"
-							item="$(validate_xml_item "${item}")"
+
 							open_attribute_tag "$item"
 
 							add_indentation
 							xml_description "$iddesc"
-						;;
+							;;
 
 						'header'|'subheader')
 							## add indentation
@@ -304,7 +305,7 @@
 
 							unset code
 							((XML_INDENT++))
-						;;
+							;;
 
 						'footer')
 							((XML_INDENT--))
@@ -314,7 +315,7 @@
 							item="$(sed s/%footer%// <<< "${item}")"
 							item="$(validate_xml_item "${item}")"
 							xml_tag_stop "${item}"
-						;;
+							;;
 					esac
 				esac
 			;;
@@ -343,21 +344,23 @@
 
 	open_attribute_tag() {
 		add_indentation
-
 		# parse item
 		item="$(sed s/%attribute%// <<< "${item}")"
 		code=$(awk -F\; {'print $2'} <<< "${item}")
+
 		# item validation strips away the code
 		item="$(validate_xml_item "${item}")"
-		xml_attribute_start "${item}" "${code}"
+		local tag="$(awk -F\; {'print $1'} <<< "${item}")"
+
+		xml_attribute_start "${tag}" "${code}"
 		((XML_INDENT++))
 		attrib_status="open"
 	}
 
 	validate_xml_item() {
-		# uppercase to lowercase ; spaces to downscores ; trim all leading spaces
-		awk -F\; {'print $1'} <<< "${1}" | \
-			sed 's/\\[a-z]//g; s/\ \|\//_/g ; s/^\ *//' | tr 'A-Z' 'a-z'
+		# trim all leading spaces ; trim all non-alphabetical characters ;
+		# spaces to downscores ; uppercase to lowercase
+		sed 's/^\ *// ; s/\\[a-z]//g; s/\ \|\//_/g ' <<< "${@}"| tr 'A-Z' 'a-z'
 	}
 #######
 

Modified: trunk/osinfo/lib/xml.functions
===================================================================
--- trunk/osinfo/lib/xml.functions	2007-03-06 12:48:27 UTC (rev 679)
+++ trunk/osinfo/lib/xml.functions	2007-03-06 13:06:37 UTC (rev 680)
@@ -2,7 +2,7 @@
 #######
 # xml.functions - shared functions for XML output.
 # Copyright (C) 2006 Arvid Norlander
-# Copyright (C) 2006 Mikael Lammentausta
+# Copyright (C) 2006, 2007 Mikael Lammentausta
 # All rights reserved.
 #
 # Redistribution and use in source and binary forms, with or without

Modified: trunk/osinfo/modules/devices
===================================================================
--- trunk/osinfo/modules/devices	2007-03-06 12:48:27 UTC (rev 679)
+++ trunk/osinfo/modules/devices	2007-03-06 13:06:37 UTC (rev 680)
@@ -115,21 +115,19 @@
 		extract_dmi ${handle_desc} > ${osinfo_tmp}
 
 		add_header    "Motherboard"
+		add_attribute 'Manufacturer' 'mother_board_manufacturer'
 
-		add_attribute ' Manufacturer' \
-				  'mother_board_manufacturer'
 		add_values    "$(get_mobo_manufacturer)"
 		              # these functions are inherited from module_dmi
 
-		add_attribute ' Model' \
-				  'mother_board_model'
+		add_attribute 'Model' 'mother_board_model'
 		add_values    "$(get_mobo_model)"
 
 		# load BIOS info from dmi
 		local handle_desc='BIOS Information'
 		extract_dmi ${handle_desc} > ${osinfo_tmp}
 
-		add_attribute ' BIOS revision'	'bios_version'
+		add_attribute 'BIOS revision' 'bios_version'
 		add_values    "$(get_bios_revision)"
 
 		print_bridges;



From lamikae at mail.berlios.de  Tue Mar  6 14:18:54 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 14:18:54 +0100
Subject: [Osinfo-commit] r681 - trunk/osinfo/lib
Message-ID: <200703061318.l26DIsoO010858@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 14:18:53 +0100 (Tue, 06 Mar 2007)
New Revision: 681

Modified:
   trunk/osinfo/lib/print.functions
Log:
cleaned out some nuisances from XML

Modified: trunk/osinfo/lib/print.functions
===================================================================
--- trunk/osinfo/lib/print.functions	2007-03-06 13:06:37 UTC (rev 680)
+++ trunk/osinfo/lib/print.functions	2007-03-06 13:18:53 UTC (rev 681)
@@ -233,7 +233,7 @@
 		# case by the "%identifier%" tag
 		case $idtag in
 
-			# adds the footer (value dimension)
+			# adds the value footer (value dimension)
 			'value_footer')
 				add_indentation
 
@@ -313,6 +313,8 @@
 
 							# strip tag
 							item="$(sed s/%footer%// <<< "${item}")"
+							item="$(awk -F\; {'print $1'} <<< "${item}")"
+							
 							item="$(validate_xml_item "${item}")"
 							xml_tag_stop "${item}"
 							;;
@@ -349,8 +351,9 @@
 		code=$(awk -F\; {'print $2'} <<< "${item}")
 
 		# item validation strips away the code
-		item="$(validate_xml_item "${item}")"
 		local tag="$(awk -F\; {'print $1'} <<< "${item}")"
+		tag="$(validate_xml_item "${tag}")"
+		code="$(validate_xml_item "${code}")"
 
 		xml_attribute_start "${tag}" "${code}"
 		((XML_INDENT++))
@@ -360,7 +363,7 @@
 	validate_xml_item() {
 		# trim all leading spaces ; trim all non-alphabetical characters ;
 		# spaces to downscores ; uppercase to lowercase
-		sed 's/^\ *// ; s/\\[a-z]//g; s/\ \|\//_/g ' <<< "${@}"| tr 'A-Z' 'a-z'
+		sed 's/^\ *// ; s/^([a-z]*)//g; s/\ \|\//_/g ' <<< "${@}"| tr 'A-Z' 'a-z'
 	}
 #######
 



From lamikae at mail.berlios.de  Tue Mar  6 16:11:21 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Tue, 6 Mar 2007 16:11:21 +0100
Subject: [Osinfo-commit] r682 - in trunk/osinfo: docs lib modules
	modules/experimental
Message-ID: <200703061511.l26FBLwe022091@sheep.berlios.de>

Author: lamikae
Date: 2007-03-06 16:11:20 +0100 (Tue, 06 Mar 2007)
New Revision: 682

Modified:
   trunk/osinfo/docs/TODO
   trunk/osinfo/lib/print.functions
   trunk/osinfo/modules/devices
   trunk/osinfo/modules/experimental/video
Log:
reworked devices

Modified: trunk/osinfo/docs/TODO
===================================================================
--- trunk/osinfo/docs/TODO	2007-03-06 13:18:53 UTC (rev 681)
+++ trunk/osinfo/docs/TODO	2007-03-06 15:11:20 UTC (rev 682)
@@ -10,7 +10,6 @@
 *	sensors output depends on LC_*, remove [:punct:] dependency
 *	info message from corresponding modules (eg hdd) when a program is missing (smartctl)
 *	complete xsl/html support
-*	add_subheader => intended, blue title
 *	checker to see if netcat is installed
 *	--checkdeps switch
 *	don't leave osinfo.XXXXXX and <hostname>.x?? files around!

Modified: trunk/osinfo/lib/print.functions
===================================================================
--- trunk/osinfo/lib/print.functions	2007-03-06 13:18:53 UTC (rev 681)
+++ trunk/osinfo/lib/print.functions	2007-03-06 15:11:20 UTC (rev 682)
@@ -101,6 +101,7 @@
 # and indentation is formed with the 'column' tool.
 function print_stdout {
 	local header_color="${tcMAGENTA}"
+	local subheader_color="${tcBLUE}"
 	local info_color="${tcYELLOW}"
 	local item itemnr value_string=""
 	local indentation=""
@@ -163,7 +164,7 @@
 				# each header starts with a newline,
 				# and is printed in special color.
 				# add indentation of two spaces
-				value_string="${value_string}\n \_ ${header_color}${item}${tSTD}";
+				value_string="${value_string}\n \_ ${subheader_color}${item}${tSTD}";
 				indentation=" \__ "
 				;;
 

Modified: trunk/osinfo/modules/devices
===================================================================
--- trunk/osinfo/modules/devices	2007-03-06 13:18:53 UTC (rev 681)
+++ trunk/osinfo/modules/devices	2007-03-06 15:11:20 UTC (rev 682)
@@ -47,7 +47,7 @@
 	lshw_xml
 
 	# get entries from lspci into the $DEVICE[] array
-	load_lspci_array
+	load_lspci_arrays
 
 	if CheckReq_root "motherboard and BIOS data"; then
 		print_mobo_info
@@ -159,8 +159,27 @@
 	}
 
 	#####################
-	## load_lspci_array
+	## load_lspci_arrays
 	#
+	load_lspci_arrays() {
+		local IFS_bak="$IFS"
+		IFS=$'\n'
+		
+		for DEVICE in $(lspci); do
+
+			busID[${#busID[@]}]="$(awk {' print $1 '} <<< "${DEVICE}" )"
+	
+			func[${#func[@]}]="$(awk -F'.[0-9] |: '  '{ print $2 }' <<< "${DEVICE}" )"
+
+			device[${#device[@]}]="$(awk -F': ' {' print $2 '} <<< ${DEVICE} )"
+		
+		done
+		IFS="$IFS_bak"
+	}	
+
+	#####################
+	## load_lspci_array (deprecated)
+	#
 	# fill up the lspci array to contain ' ' separated entries from lsmod.
 	# [1] device type		# [2] manufacturer		# [3] device name	etc
 	# ${#devices[@]} # is the number of devices in the array
@@ -189,14 +208,14 @@
 		local found_devices arraynr description
 
 		# grep the wanted nodes from the array into another array
-		for arraynr in $(seq 1 1 ${#devices[@]}); do
+		for arraynr in $(seq 1 1 ${#func[@]}); do
 
 			# if we have a hit (grep matches the device_id)
-			if [ "$(grep -i $device_id  <<< ${devices[$arraynr]} )" ]; then
+			if [ "$(grep -i $device_id  <<< ${func[$arraynr]} )" ]; then
 
 				# if the DO_NOT_OUTPUT is defined, go through the array
 				if [ $DO_NOT_OUTPUT ]; then
-					if [ -z "$(grep -i $DO_NOT_OUTPUT <<< ${devices[$arraynr]} )" ]; then
+					if [ -z "$(grep -i $DO_NOT_OUTPUT <<< ${func[$arraynr]} )" ]; then
 
 						catch_device
 					
@@ -211,24 +230,24 @@
 		done
 
 
-		# print
-		for arraynr in $(seq 1 1 $((${#found_devices[@]}-1)) ); do
+# 		# print (deprecated)
+# 		for arraynr in $(seq 1 1 $((${#found_devices[@]}-1)) ); do
+# 
+# 			# add an xml code for ethernet and display adapters
+# 			if [ "$(grep -i 'network\|ethernet' <<< "${description[$arraynr]}")" ]; then
+# 				add_attribute ' Ethernet controller(s)' "network_adapter"
+# 
+# 			elif [ "$(grep -i 'vga\|display' <<< "${description[$arraynr]}")" ]; then
+# 				add_attribute ' Display adapter(s)' "display_adapter"
+# 
+# 			else
+# 				add_attribute "${busID[$arraynr]}" # ${description[$arraynr]}"
+# 			fi
+# 
+# 			add_values    " ${found_devices[$arraynr]}"
+# 		done
 
-			# add an xml code for ethernet and display adapters
-			if [ "$(grep -i 'network\|ethernet' <<< "${description[$arraynr]}")" ]; then
-				add_attribute ' Ethernet controller(s)'	"network_adapter"
 
-			elif [ "$(grep -i 'vga\|display' <<< "${description[$arraynr]}")" ]; then
-				add_attribute ' Display adapter(s)'		"display_adapter"
-
-			else
-				add_attribute " ${description[$arraynr]}"
-			fi
-
-			add_values    " ${found_devices[$arraynr]}"
-		done
-
-
 #		#then report the eth and video adapters
 #		if [ "$eth_adapter" ]; then
 #			add_attribute 'Ethernet controller(s)'	"network_adapter"
@@ -251,15 +270,32 @@
 	#
 	# subroutine used by grep_lspci_array
 	catch_device() {
-		description[${#description[@]}]="$(
-			awk  '{ print $1 }' <<< ${devices[$arraynr]} | \
-			sed 's/^.// ; s/^ *// ; s/_/ /g')"
 
-		found_devices[${#found_devices[@]}]="$(
-			awk  '{ print $2" "$3 }' <<< ${devices[$arraynr]} | \
-			tr '_' ' ')"
+		# add an xml code for ethernet and display adapters
+		if [ "$(grep -i 'network\|ethernet' <<< "${func[$arraynr]}")" ]; then
+			add_attribute ' Ethernet controller(s)' "network_adapter"
 
+		elif [ "$(grep -i 'vga\|display' <<< "${func[$arraynr]}")" ]; then
+			add_attribute ' Display adapter(s)' "display_adapter"
 
+		else
+			add_attribute "${busID[$arraynr]} ${func[$arraynr]}"
+		fi
+
+		add_values    " ${device[$arraynr]}"
+
+# 		busID[${#busID[@]}]="$(
+# 			awk -F_ '{ print $1 }' <<< ${devices[$arraynr]} )"
+# 	
+# 		description[${#description[@]}]="$(
+# 			awk  '{ print $1 }' <<< ${devices[$arraynr]} | \
+# 			sed 's/^.// ; s/^ *// ; s/_/ /g')"
+# 
+# 		found_devices[${#found_devices[@]}]="$(
+# 			awk  '{ print $2" "$3 }' <<< ${devices[$arraynr]} | \
+# 			tr '_' ' ')"
+# 
+
 # 		if [ "$(grep -i 'network\|ethernet' <<< "$description")" ]; then
 # 
 # 			# these values should not be local,
@@ -305,3 +341,28 @@
 	#	print_scsibusinfo(){}
 	#	print_usbbusinfo(){}
 
+	#######################
+	## get_video_card_info
+	#
+	# to be used by other modules; ie video
+	get_video_card_info() {
+		load_lspci_array
+
+		# grep the wanted nodes from the array into another array
+		for arraynr in $(seq 1 1 ${#devices[@]}); do
+
+			if [ "$(grep -i 'vga\|display' <<< "${devices[$arraynr]}")" ]; then
+
+				local attribute="$(awk  '{ print $1 }' <<< ${devices[$arraynr]} | \
+				                   sed 's/^.// ; s/^ *// ; s/_/ /g')"
+
+				local value="$(awk  '{ print $2" "$3 }' <<< ${devices[$arraynr]} | tr '_' ' ')"
+
+				add_attribute "$attribute"
+				add_values    "$value"
+
+			fi
+
+		done
+	}
+

Modified: trunk/osinfo/modules/experimental/video
===================================================================
--- trunk/osinfo/modules/experimental/video	2007-03-06 13:18:53 UTC (rev 681)
+++ trunk/osinfo/modules/experimental/video	2007-03-06 15:11:20 UTC (rev 682)
@@ -1,3 +1,5 @@
+#!/bin/bash
+
 Module_video() {
 	local moduleName="Video"
 	local moduleDescription="Video components"
@@ -6,55 +8,80 @@
 	#add_attribute     'Video card'
 	#add_attribute     'Video card chipset'
 
-	add_attribute      'X version'
-	add_values         "$(X -version 2>&1 | grep Revision)"
+	print_X_info
+	print_hw_info
+	print_setup
 
-	#add_attribute     'Available X video overlays'
+	flush_values
+}
 
-	add_attribute      '* Found chipset'
-	add_values         "$(get_found_chipset)"
+	print_X_info() {
+		add_header         'Windowing system'
 
-	add_attribute      '* AGP speed'
-	add_values         "$(get_agp_mode)"
+		add_attribute      'X version'
+		add_values         "$(X -version 2>&1 | grep Revision)"
 
-	add_header         'Direct rendering'
+		#add_attribute     'Available X video overlays'
+		
+		add_attribute      'log file'
+		add_values         "${XORG_LOG}"
 
-	add_attribute      "Enabled"
-	add_values         "$(glxinfo 2> /dev/null | grep -i 'direct rendering' | \
-						 awk -F: {'print $2'})"
+		add_attribute      'log date'
+		add_values         "$(ls -l ${XORG_LOG} | awk {'print $6 " " $7'})"
 
-	add_attribute      "OpenGL renderer"
-	add_values         "$(get_opengl_renderer)"
+		add_footer
+	}
 
-	add_attribute      "* Dri vendor"
-	add_values         "$(get_dri_vendor)"
+	print_hw_info() {
+		add_header         'Hardware'
 
-	add_attribute      "* Drm vendor"
-	add_values         "$(get_drm_vendor)"
+		add_subheader      'Display adapter'
+		 get_video_card_info
+		 add_attribute      'Found chipset'
+		 add_values         "$(get_found_chipset)"
+		add_footer
 
-	add_attribute      "* GLX vendor"
-	add_values         "$(get_glx_vendor)"
+		add_subheader      'Capabilities'
+		 add_attribute      'AGP speed'
+		 add_values         "$(get_agp_mode)"
+		add_footer
 
-	add_attribute      "* GLX"
-	add_values         "$(get_glx)"
+		add_footer
+	}
 
-	add_attribute      "* AIGLX"
-	add_values         "$(get_aiglx)"
+	print_setup() {
+		add_header         'Setup'
+		
+		add_attribute      'Direct rendering'
+		add_values         "Enabled: $(glxinfo 2> /dev/null | grep -i 'direct rendering' | \
+		                               awk -F: {'print $2'})"
 
-	add_footer
+		add_attribute      "OpenGL renderer"
+		add_values         "$(get_opengl_renderer)"
 
-	add_header         'Xorg errors'
-	add_values         "$(get_xorg_errors)"
+		add_attribute      "Dri vendor"
+		add_values         "$(get_dri_vendor)"
 
-	info "\nData is based on ${XORG_LOG}"
+		add_attribute      "Drm vendor"
+		add_values         "$(get_drm_vendor)"
 
-	add_attribute      'Xorg log date*'
-	add_values         "$(ls -l ${XORG_LOG} | awk {'print $6 " " $7'})"
+		add_attribute      "GLX vendor"
+		add_values         "$(get_glx_vendor)"
 
+		add_attribute      "GLX"
+		add_values         "$(get_glx)"
 
-	flush_values
-}
+		add_attribute      "AIGLX"
+		add_values         "$(get_aiglx)"
 
+		add_subheader      'Errors'
+		 add_attribute      'X'
+		 #add_values         "$(get_xorg_errors)"
+		add_footer
+
+		add_footer
+	}
+
 	function get_videodev_name () {
 		echo TODO
 



From lamikae at mail.berlios.de  Wed Mar  7 08:17:56 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Wed, 7 Mar 2007 08:17:56 +0100
Subject: [Osinfo-commit] r683 - in trunk/osinfo: lib modules
Message-ID: <200703070717.l277Hurs006562@sheep.berlios.de>

Author: lamikae
Date: 2007-03-07 08:17:56 +0100 (Wed, 07 Mar 2007)
New Revision: 683

Modified:
   trunk/osinfo/lib/global_variables
   trunk/osinfo/modules/devices
   trunk/osinfo/modules/dmi
Log:
fine-tuning devices

Modified: trunk/osinfo/lib/global_variables
===================================================================
--- trunk/osinfo/lib/global_variables	2007-03-06 15:11:20 UTC (rev 682)
+++ trunk/osinfo/lib/global_variables	2007-03-07 07:17:56 UTC (rev 683)
@@ -44,6 +44,7 @@
 Modules=()
 Missing=() # helper applications that aren't installed
 
+
 ### DAEMON MODE VARIABLES ###
 
 # if the conf file is not available..

Modified: trunk/osinfo/modules/devices
===================================================================
--- trunk/osinfo/modules/devices	2007-03-06 15:11:20 UTC (rev 682)
+++ trunk/osinfo/modules/devices	2007-03-07 07:17:56 UTC (rev 683)
@@ -110,30 +110,14 @@
 	####################
 	## print_mobo_info
 	print_mobo_info(){
-		# load MOBO info from dmi
-		local handle_desc='Base Board information'
-		extract_dmi ${handle_desc} > ${osinfo_tmp}
 
 		add_header    "Motherboard"
-		add_attribute 'Manufacturer' 'mother_board_manufacturer'
 
-		add_values    "$(get_mobo_manufacturer)"
-		              # these functions are inherited from module_dmi
+		print_mobo_dmi;
+		 print_bridges;
+		 print_interfaces;
+		 print_controllers;
 
-		add_attribute 'Model' 'mother_board_model'
-		add_values    "$(get_mobo_model)"
-
-		# load BIOS info from dmi
-		local handle_desc='BIOS Information'
-		extract_dmi ${handle_desc} > ${osinfo_tmp}
-
-		add_attribute 'BIOS revision' 'bios_version'
-		add_values    "$(get_bios_revision)"
-
-		print_bridges;
-		print_interfaces;
-		print_controllers;
-
 		add_footer
 	}
 
@@ -273,10 +257,10 @@
 
 		# add an xml code for ethernet and display adapters
 		if [ "$(grep -i 'network\|ethernet' <<< "${func[$arraynr]}")" ]; then
-			add_attribute ' Ethernet controller(s)' "network_adapter"
+			add_attribute "${busID[$arraynr]} Ethernet controller" "network_adapter"
 
 		elif [ "$(grep -i 'vga\|display' <<< "${func[$arraynr]}")" ]; then
-			add_attribute ' Display adapter(s)' "display_adapter"
+			add_attribute "${busID[$arraynr]} Display adapter" "display_adapter"
 
 		else
 			add_attribute "${busID[$arraynr]} ${func[$arraynr]}"

Modified: trunk/osinfo/modules/dmi
===================================================================
--- trunk/osinfo/modules/dmi	2007-03-06 15:11:20 UTC (rev 682)
+++ trunk/osinfo/modules/dmi	2007-03-07 07:17:56 UTC (rev 683)
@@ -31,10 +31,21 @@
 
 	if CheckReq_dmidecode && CheckReq_root; then
 
-		print_bios_info
-		print_oem_info
-		print_mobo_dmi
-		print_chassis_info
+		add_header    "BIOS"
+		 print_bios_info
+		add_footer
+		
+		add_header    "System info"
+		 print_oem_info
+		add_footer
+		
+		add_header    "Motherboard"
+		 print_mobo_dmi
+		add_footer
+		
+		add_header    'Chassis'
+		 print_chassis_info
+		add_footer
 
 	fi
 
@@ -77,8 +88,6 @@
 		# extract the handle to a temp file
 		extract_dmi "${handle_desc}" > ${osinfo_tmp}
 
-		add_header    "BIOS"
-
 		add_attribute 'Vendor'
 		add_values    "$(grep -i vendor ${osinfo_tmp} | \
 				 awk -F':' {'print $2'} | \
@@ -99,8 +108,6 @@
 		add_values    "$(grep -i serial ${osinfo_tmp} | \
 				 awk -F':' {'print $2'} | \
 				 sed 's/^\ *//')"
-
-		add_footer
 	}
 
 
@@ -110,8 +117,6 @@
 		# extract the handle to a temp file
 		extract_dmi ${handle_desc} > ${osinfo_tmp}
 
-		add_header  "System info"
-
 		add_attribute 'Manufacturer' \
 				  'system_manufacturer'
 		add_values    "$(grep -i manufacturer ${osinfo_tmp} | \
@@ -142,8 +147,6 @@
 		add_values    "$(grep -i uuid ${osinfo_tmp} | \
 				 awk -F':' {'print $2'} | \
 				 sed 's/^\ *//')"
-
-		add_footer
 	}
 
 
@@ -153,8 +156,6 @@
 		# extract the handle to a temp file
 		extract_dmi ${handle_desc} > ${osinfo_tmp}
 
-		add_header    "Motherboard"
-
 		add_attribute 'Manufacturer' \
 				  'mother_board_manufacturer'
 		add_values    "$(get_mobo_manufacturer)"
@@ -177,8 +178,6 @@
 		add_values    "$(grep -i serial ${osinfo_tmp} | \
 				 awk -F':' {'print $2'} | \
 				 sed 's/^\ *//')"
-
-		add_footer
 	}
 
 
@@ -188,8 +187,6 @@
 		# extract the handle to a temp file
 		extract_dmi ${handle_desc} > ${osinfo_tmp}
 
-		add_header    'Chassis'
-
 		add_attribute 'Manufacturer' 	'chassis_manufacturer'
 		add_values    "$(grep -i manufacturer ${osinfo_tmp} | \
 				 awk -F':' {'print $2'} | \
@@ -224,8 +221,6 @@
 		add_values    "$(grep -i asset ${osinfo_tmp} | \
 				 awk -F':' {'print $2'} | \
 				 sed 's/^\ *//')"
-
-		add_footer
 	}
 
 		get_mobo_manufacturer() {



From lamikae at mail.berlios.de  Wed Mar  7 08:34:47 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Wed, 7 Mar 2007 08:34:47 +0100
Subject: [Osinfo-commit] r684 - trunk/osinfo/modules
Message-ID: <200703070734.l277YlRw007837@sheep.berlios.de>

Author: lamikae
Date: 2007-03-07 08:34:47 +0100 (Wed, 07 Mar 2007)
New Revision: 684

Modified:
   trunk/osinfo/modules/devices
   trunk/osinfo/modules/ram
Log:
some specifics to ram and devices

Modified: trunk/osinfo/modules/devices
===================================================================
--- trunk/osinfo/modules/devices	2007-03-07 07:17:56 UTC (rev 683)
+++ trunk/osinfo/modules/devices	2007-03-07 07:34:47 UTC (rev 684)
@@ -43,24 +43,27 @@
 		return 1
 	fi
 
-	# load lshw xml temp file
-	lshw_xml
+	if CheckReq_root "motherboard and BIOS data"; then
+	
+		# load lshw xml temp file
+		lshw_xml
 
-	# get entries from lspci into the $DEVICE[] array
-	load_lspci_arrays
+		# get entries from lspci into the $DEVICE[] array
+		load_lspci_arrays
 
-	if CheckReq_root "motherboard and BIOS data"; then
-		print_mobo_info
-	fi
+		# print
+		print_internal
+		print_external
 
-	# output by category
-#	print_categories
+		# output by category (deprecated)
+		#print_categories
 
-	flush_values
+		flush_values
+	fi
 }
 
 ############################################
-# helper functions for to get device data
+# helper functions for to get and display device data
 #
 	###################
 	## load_categories
@@ -71,7 +74,7 @@
 	}
 
 	#####################
-	## print_categories
+	## print_categories (deprecated)
 	#
 	# this function defines all categories
 	# and prints the selected ones
@@ -108,8 +111,8 @@
 	}
 
 	####################
-	## print_mobo_info
-	print_mobo_info(){
+	## print_internal
+	print_internal(){
 
 		add_header    "Motherboard"
 
@@ -122,6 +125,17 @@
 	}
 
 	####################
+	## print_external
+	print_external(){
+
+		add_header    "External devices"
+
+		print_usbbusinfo;
+
+		add_footer
+	}
+	
+	####################
 	## Motherboard subcategories: bridges, controllers, interfaces
 
 	print_bridges(){
@@ -142,6 +156,18 @@
 		add_footer 'Interfaces'
 	}
 
+	# some possible future functios
+	#	print_mobobusinfo(){}
+	#	print_pciinfo(){}
+	#	print_apginfo(){}
+	#	print_idebusinfo(){}
+	#	print_scsibusinfo(){}
+	
+
+	#################################
+	### DATA ACQUISATION ROUTINES ###
+	#################################
+	
 	#####################
 	## load_lspci_arrays
 	#
@@ -296,7 +322,22 @@
 # 		fi
 
 	}
+	
+	#######################
+	## print_usbbusinfo
+	#
+	# prints information of the USB bus (speed)
+	print_usbbusinfo(){
+		add_subheader      'USB'
+		
+		 add_attribute     'Standard'
+		 add_values        "n/a"
 
+		 print_usb_devices
+
+		add_footer 'USB'
+	}
+
 	#######################
 	## print_usb_devices
 	#
@@ -317,13 +358,9 @@
 		IFS="$IFS_bak"
 	}
 
-	# some possible future functios
-	#	print_mobobusinfo(){}
-	#	print_pciinfo(){}
-	#	print_apginfo(){}
-	#	print_idebusinfo(){}
-	#	print_scsibusinfo(){}
-	#	print_usbbusinfo(){}
+	print_power_supply(){
+		echo "TODO"
+	}
 
 	#######################
 	## get_video_card_info

Modified: trunk/osinfo/modules/ram
===================================================================
--- trunk/osinfo/modules/ram	2007-03-07 07:17:56 UTC (rev 683)
+++ trunk/osinfo/modules/ram	2007-03-07 07:34:47 UTC (rev 684)
@@ -1,3 +1,4 @@
+#!/bin/bash
 #######################
 # RAM
 #
@@ -62,32 +63,48 @@
 
 					add_attribute     "RAM bank$bank description"
 					add_values        "$(extr_xml_value \
-					                  $(grep description $banknode))"
+					                   $(grep description $banknode))"
 
 					add_attribute     "RAM bank$bank size"
 					add_values        "$(extr_xml_value \
-					                  $(grep size $banknode))"
+					                   $(grep size $banknode))"
 
-					add_attribute     "RAM bank$bank vendor"
+					add_attribute     "RAM bank$bank type" # DDR
 					add_values        "$(extr_xml_value \
-					                  $(grep vendor $banknode))"
+					                   $(grep type $banknode))" # check DMI
 
-					add_attribute     "RAM bank$bank serial"
+					add_attribute     "RAM bank$bank form factor" # DIMM
 					add_values        "$(extr_xml_value \
-					                  $(grep serial $banknode))"
+					                   $(grep 'form factor' $banknode))" # check DMI
 
-					add_attribute     "RAM bank$bank slot"
+					add_attribute     "RAM bank$bank detail" # syncronous
 					add_values        "$(extr_xml_value \
-					                  $(grep slot $banknode))"
+					                   $(grep 'detail' $banknode))" # check DMI
 
-					add_attribute     "RAM bank$bank width"
+					add_attribute     "RAM bank$bank bit width"
 					add_values        "$(extr_xml_value \
-					                  $(grep width $banknode))"
+					                   $(grep width $banknode))"
 
 					add_attribute     "RAM bank$bank speed"
 					add_values        "$(extr_xml_value \
-					                  $(grep speed $banknode))"
+					                   $(grep speed $banknode))"
 
+					add_attribute     "RAM bank$bank slot"
+					add_values        "$(extr_xml_value \
+					                   $(grep slot $banknode))"
+
+					add_attribute     "RAM bank$bank vendor"
+					add_values        "$(extr_xml_value \
+					                   $(grep vendor $banknode))"
+
+					add_attribute     "RAM bank$bank serial"
+					add_values        "$(extr_xml_value \
+					                   $(grep serial $banknode))"
+
+					add_attribute     "RAM bank$bank asset tag"
+					add_values        "$(extr_xml_value \
+					                   $(grep 'asset tag' $banknode))"
+
 					add_footer        "Bank"
 
 					[ $usexml -ne 1 ] && flush_values



From lamikae at mail.berlios.de  Wed Mar  7 08:42:15 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Wed, 7 Mar 2007 08:42:15 +0100
Subject: [Osinfo-commit] r685 - in trunk/osinfo: docs html lib
Message-ID: <200703070742.l277gFEl008264@sheep.berlios.de>

Author: lamikae
Date: 2007-03-07 08:42:15 +0100 (Wed, 07 Mar 2007)
New Revision: 685

Modified:
   trunk/osinfo/docs/README
   trunk/osinfo/html/index3.php
   trunk/osinfo/html/xml-parseri.php
   trunk/osinfo/lib/infostring.functions
Log:
fixed a stupid mistake that made empty values to print out

Modified: trunk/osinfo/docs/README
===================================================================
--- trunk/osinfo/docs/README	2007-03-07 07:34:47 UTC (rev 684)
+++ trunk/osinfo/docs/README	2007-03-07 07:42:15 UTC (rev 685)
@@ -0,0 +1,5 @@
+Random tidbits for developers:
+
+Q: how can I control whether attributes with no values show up in the list?
+A: check out add_values()
+

Modified: trunk/osinfo/html/index3.php
===================================================================
--- trunk/osinfo/html/index3.php	2007-03-07 07:34:47 UTC (rev 684)
+++ trunk/osinfo/html/index3.php	2007-03-07 07:42:15 UTC (rev 685)
@@ -13,20 +13,27 @@
 					"P??Frame" => array('10px', '10px', '70%', '500'));
 	private $_xmlkansio = "hosts";
 	private $_xmlparseri = "xml-parseri.php";
-	private $_index_view = "index_view.html";
+	private $_parseri;
+	private $_clientteja_rivilla = 3;
 
 	public function __construct()
     	{
+		if(file_exists($this->_xmlparseri))
+		{
+			include($this->_xmlparseri);
 
+			$this->_parseri = new xmlparseri();
+		}
+		else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
 	}
 
 	public function tulosta_alkukoodi($tyylit = true)
 	{
-		//print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
+		print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
 
 		print "<html>\n";	
 		print "<head>\n";	
-		print "<title>Osinfo</title>\n\n";
+		print "<title>OS info</title>\n\n";
 
 		if($tyylit) $this->tulosta_tyyli();
 
@@ -76,7 +83,6 @@
 
 		div.SivuFrameSisalto
 		{
-			padding: 5px;
 			padding: 10px;
 		}
 
@@ -108,14 +114,39 @@
 			color: red;
 		}
 
+		ul.hostit
+		{
+			padding: 0px;
+			padding-left: 10px;
+		}
+
+		li.kuvaus
+		{
+			font-size: 12px;
+		}
+
+		a:link
+		{
+			color: rgb(0,0,255);
+		}
+
+		a:visited
+		{
+			color: rgb(0,0,200);
+		}
+
 		</style>";
 	}
 	
-	private function listaa_tiedostot()
+	private function listaa_tiedostot($valikko = false)
 	{
 		if(file_exists($this->_xmlkansio))
 		{
 			$kansio = opendir($this->_xmlkansio);
+
+			$ul_avattu = false;
+
+			$xml_array = array();
 		
 			for($i=0; $tiedosto = readdir($kansio); $i++)
 			{
@@ -124,14 +155,183 @@
 		
 				if($i > 1 && ($paate == "xml"))
 				{
-					print "<a href=\"?target=". $tiedosto . "\">" .
-						$tiedosto . "</a><br />";
+					$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $tiedosto);
+
+					if($valikko)
+					{
+					$temp_array = array("tiedosto" => $tiedosto,
+						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
+						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
+						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
+						"os" => $this->_parseri->hae_tieto("computer", "os"),
+						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"));
+					}
+					else
+					{
+					$temp_array = array("tiedosto" => $tiedosto,
+						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
+						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
+						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
+						"os" => $this->_parseri->hae_tieto("computer", "os"),
+						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"),
+						"script_version" => $this->_parseri->hae_tieto("script", "version"),
+						"ram" => $this->_parseri->hae_tieto("ram", "Physical RAM"),
+						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive")
+						);
+					}
+
+					array_push($xml_array, $temp_array);
+
 				}
 			}
+
+			$domainit = $this->lajittele_array($xml_array, "domain");
+			$profilet = array();
+
+			foreach($domainit as $domain => $arvo)
+			{
+				$temp_array = array($domain => $this->lajittele_array($arvo, "profile"));
+				$this->array_lisaa_samaan($profilet, $temp_array);
+			}
+
+			ksort($profilet);
+
+			//print "<pre>";
+			//print_r($domainit);
+			//print_r($profilet);
+			//print "</pre>";
+			
+			if($valikko)
+			{
+				foreach($profilet as $domain => $profiles)
+				{
+					ksort($profiles);
+					print "<ul class=\"hostit\"><li>Domain: <i>" . $domain . "</i>";
+	
+					foreach($profiles as $profile => $hostnames)
+					{
+						print "<ul class=\"hostit\"><li>Profile: <i>" . $profile . 
+							"</i><ul class=\"hostit\">";
+	
+						foreach($hostnames as $hostname => $arvot)
+						{
+							print "<li><b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
+								$arvot["hostname"] . "</a></b><ul class=\"hostit\">
+								<li class=\"kuvaus\">" . $arvot["os"] . "</li>
+								<li class=\"kuvaus\">" . $arvot["cpu"] . "</li>
+								</ul></li>";
+	
+						}
+	
+						print "</ul></li></ul>";
+					}
+	
+					print "</li></ul>";
+				}
+			}
+			else
+			{
+				foreach($profilet as $domain => $profiles)
+				{
+					ksort($profiles);
+					print "<div class=\"kentta\"><h3>Domain: <i>" . $domain . "</i>";
+	
+					foreach($profiles as $profile => $hostnames)
+					{
+						print "<div class=\"kentta\"><h3>Profile: <i>" . $profile . 
+							"</i><table class=\"attribuutti\" cellspacing=\"10\">";
+
+						$laskuri = 0;
+	
+						foreach($hostnames as $hostname => $arvot)
+						{
+							if($laskuri == 0) 
+								print "<tr>";
+							elseif($laskuri % $this->_clientteja_rivilla == 0)
+ 								print "</tr><tr>";
+
+							print "<td class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
+
+							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
+								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
+
+							foreach($arvot as $tyyppi => $arvo)
+							{
+								if($tyyppi != "hostname" && $tyyppi != "domain" && $tyyppi != "profile" && $tyyppi != "tiedosto" && $arvo != "")
+								{
+									print "<li class=\"kuvaus\">" . $arvo . "</li>";
+								}
+							}
+
+							print "</ul></td>";
+
+							$laskuri++;
+						}
+
+						while($laskuri % $this->_clientteja_rivilla != 0)
+						{
+							print "<td>&nbsp;</td>";
+							$laskuri++;
+						}
+	
+						print "</table></h3></div>";
+					}
+	
+					print "</h3></div>";
+				}
+			}
 		}
 		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
 	}
 
+	private function lajittele_array($array, $nimi)
+	{
+		$nimet = array(" ");
+		$nimet_lajiteltuna = array();
+
+		foreach($array as $avain => $arvo)
+		{
+			if(is_array($arvo))
+			{
+				$loytyi = false;
+
+				for($i=0; $i < sizeof($nimet); $i++)
+					if($arvo[$nimi] == $nimet[$i]) $loytyi = true;
+
+				if(!$loytyi)
+				{
+					$temp_array = array($arvo[$nimi] => array());
+					$this->array_lisaa_samaan($nimet_lajiteltuna, $temp_array);
+					array_push($nimet, $arvo[$nimi]);
+				}
+				
+				array_push($nimet_lajiteltuna[$arvo[$nimi]], $arvo);
+			}
+		}
+
+		return $nimet_lajiteltuna;
+	}
+
+	private function array_lisaa_samaan(&$array) 
+	{
+		$argumentit = func_get_args();
+	
+		foreach($argumentit as $argumentti) 
+		{
+			if(is_array($argumentti)) 
+			{
+				foreach($argumentti as $avain => $arvo) 
+				{
+					$array[$avain] = $arvo;
+					$paluuarvo++;
+				}
+			}
+			else $array[$argumentti] = "";
+		}
+	
+		return $paluuarvo;
+	}
+
 	private function hae_viimeksi_paivitetty()
 	{
 		if(file_exists($this->_xmlkansio))
@@ -163,20 +363,20 @@
 		print "<div class=\"SivuFrame\">";
 		print "<div class=\"SivuFrameSisalto\">";
 
-		print "<h3>Osinfo</h3>
+		print "<h3>OS info</h3>
 			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
 			<hr />";
 
-		$this->listaa_tiedostot();
+		$this->listaa_tiedostot(true);
 	
 		print "<hr />";
 
-		print "<p>Last updated:</p>";
+		print "<p>Last update:</p>";
 
 		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
 
 		if($viimeksi_paivitetty > 0)
-			print "<p>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</p>";
+			print "<p><i>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</i></p>";
 
 		//include("sidebar.html");
 	
@@ -193,42 +393,47 @@
 		
 		if($sivu != "")
 		{
-			if(file_exists($this->_xmlparseri))
+			if(file_exists($this->_xmlkansio . "/" . $sivu))
 			{
-				include($this->_xmlparseri);
+				/*
+				$parametrit = $_POST['osinfo'];
+			
+				print "<p>
+					<form action=\"" . $PHP_SELF . "\" method=\"post\">
+					Parameters: <input type=\"text\" name=\"osinfo\" value=\"" . $parametrit . "\" />
+						<input type=\"submit\" value=\"ok\" />
+					</form>
+					</p>";
+				*/
 	
-				if(file_exists($this->_xmlkansio . "/" . $sivu))
-				{					
-					$parametrit = $_POST['osinfo'];
+				//print "<pre>";
+
+				$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $sivu);
 				
-					print "<p>
-						<form action=\"" . $PHP_SELF . "\" method=\"post\">
-						Parameters: <input type=\"text\" name=\"osinfo\" value=\"" . $parametrit . "\" />
-							<input type=\"submit\" value=\"ok\" />
-						</form>
-						</p>";
+				//$this->_parseri->nayta_tietotaulu();
+				$this->_parseri->hae_arvot("osinfo");
 
-					$parseri = new xmlparseri($this->_xmlkansio . "/" . $sivu);
-		
-					print "<pre>";
+				//print "</pre>";
+			}
+			else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
 
-					//$parseri->nayta_tietotaulu();
-					$parseri->hae_arvot("osinfo", $parametrit);
-
-					print "</pre>";
-				}
-				else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
-			}
-			else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
 		}
 		else
 		{
-			if(file_exists($this->_index_view))
-				include($this->_index_view);
+			//if(file_exists($this->_index_view))
+			//	include($this->_index_view);
+			$this->nayta_index_view();
 		}
 
 		print "</div>";
 	}
+
+	private function nayta_index_view()
+	{
+		print "index view";
+
+		$this->listaa_tiedostot(false);
+	}
 }
 
 ?> 
\ No newline at end of file

Modified: trunk/osinfo/html/xml-parseri.php
===================================================================
--- trunk/osinfo/html/xml-parseri.php	2007-03-07 07:34:47 UTC (rev 684)
+++ trunk/osinfo/html/xml-parseri.php	2007-03-07 07:42:15 UTC (rev 685)
@@ -16,8 +16,9 @@
     // listan tunnistin
     private $_lista = "lista";
 
-    public function __construct($tiedoston_nimi)
+    public function __construct()
     {
+/*
 	if(file_exists($tiedoston_nimi))
 	{
 		$this->_parsittava_tiedosto = $tiedoston_nimi;
@@ -29,14 +30,30 @@
 	{
 		print "<p>File " . $tiedoston_nimi . " not found</p>";
 	}
+*/
     }
 
+    public function parsi_tiedosto($tiedoston_nimi)
+    {
+	if(file_exists($tiedoston_nimi))
+	{
+		$this->_parsittava_tiedosto = $tiedoston_nimi;
+		$this->lue_tiedoston_sisalto();
+	
+		$this->_tietotaulu = $this->etsi_tagi("", 0);
+	}
+	else
+	{
+		print "<p class=\"valitus\">File " . $tiedoston_nimi . " not found</p>";
+	}
+    }
+
     private function lue_tiedoston_sisalto()
     {
 	$fp = fopen($this->_parsittava_tiedosto, "r");
 	$this->_tiedoston_sisalto = "";
 
-	while(false !== ($char = fgetc($fp))) 
+	while(false !== ($char = fgetc($fp)))
 		$this->_tiedoston_sisalto .= $char;
     }
 
@@ -50,15 +67,15 @@
 
     private function etsi_tagi($etsittava, $indeksi, $taso = -1)
     {	
-	$taulu = array();	
+	$taulu = array();
 	$taso++;
 
 	for($i=$indeksi; $i < strlen($this->_tiedoston_sisalto); $i++)
 	{
 	     if($this->_tiedoston_sisalto[$i] == "<")
-	     {		  
+	     {
 		  $tagi = "";
-	          
+
 		  for($j=$i+1; $j < strlen($this->_tiedoston_sisalto); $j++)
 		  {
 			if($this->_tiedoston_sisalto[$j] == "<") break;
@@ -89,7 +106,7 @@
 				   $sisalto .= $this->_tiedoston_sisalto[$j];
 				elseif($this->_tiedoston_sisalto[$j] == "<") break;
 			    }
-				
+
 			    if(!empty($sisalto))
 			    {
 				$temp_array = array($this->_sisalto => $sisalto);
@@ -104,7 +121,7 @@
 			    	if($tietue[$this->_nimi] == $etsittava)
 				     return array("taulu" => $taulu, "indeksi" => $i);
 			    }
-				
+
 		            break;
 		       case 4:
 			    array_push($taulu, $tietue);
@@ -235,7 +252,7 @@
 	return $paluuarvo;
     }
 
-    public function hae_arvot($kanta, $attribuutit)
+    public function hae_arvot($kanta, $attribuutit = "")
     {
 	  $this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
 	  $this->esita_tiedot($esitettava_array, $attribuutit);
@@ -243,8 +260,18 @@
 
     private function esita_tiedot($array, $tarkenne = "")
     {
-	print "<h1>" . $array[$this->_nimi] . "</h1>";
+	print "<table style=\"width: 100%\">
+		<tr>
+		<td><h2>" . $this->parsi_nimi($this->hae_tieto("computer", "hostname")) . "</h2></td>
+		<td>Quick jump: ";
 
+	$this->nayta_quick_jump_valikko();
+
+	print "</td><td><p>Script version: <i>" . $this->hae_tieto("script", "version") . "</i><br />" .
+		"Scanning date: <i>" . $this->hae_tieto("scanning", "date") . "</i></p></td>";
+
+	print "</td></tr></table>";
+
 	$this->_attribuutti_avattu = false;
 	$this->_attribuutti_laskuri = 0;
 
@@ -278,7 +305,7 @@
 			$listatyyppi = true;
 	}
 
-	//$listatyyppi = true;
+	$listatyyppi = true;
 
 	foreach($array as $avain => $arvo)
 	{	
@@ -305,7 +332,7 @@
 						$attribuuttilaskuri % $this->_attribuutteja_rivilla == 0) 
 							print "</tr><tr>";
 						
-						print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . 100 / $this->_attribuutteja_rivilla . "%\">";
+						print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_attribuutteja_rivilla, 1) . "%\">";
 		
 						$this->esita_attribuutit($array, $array);
 
@@ -319,7 +346,7 @@
 					{
 						if(!$attribuutti_avattu) 
 						{
-							print "<table style=\"width: 100%\" border=\"1\">";
+							print "<table class=\"lista_attribuutti\">";
 							$attribuutti_avattu = true;
 						}
 
@@ -335,7 +362,7 @@
 			}
 			else
 			{	
-				if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $avain!= $this->_lista)
+				if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $avain!= $this->_lista && $arvo != "scanning" && $arvo != "script")
 				{	
 					if($avain == $this->_nimi)
 					{	
@@ -347,8 +374,8 @@
 							$attribuuttilaskuri = 0;
 						}
 
-						print "<div class=\"kentta\">";
-						print "<h2>" . $arvo . "</h2>";
+						print "<div class=\"kentta\" id=\"" . $arvo . "\">";
+						print "<h2>" . $this->parsi_nimi($arvo) . "</h2>";
 
 						$div_avattu = true;
 					}
@@ -357,8 +384,9 @@
 						print "<b>" . $avain . ":</b> " . $arvo . "<br />";
 					}
 				}
+				elseif($arvo == "scanning" || $arvo == "script") break;
 
-				$this->esita_sisatiedot($arvo, $avain);	
+				$this->esita_sisatiedot($arvo, $avain);
 				
 				if(is_array($arvo) && $arvo[$this->_nimi] != "value")
 				{
@@ -388,16 +416,37 @@
 
     private function esita_attribuutit(&$palautus_array, $array, $listatyyppi = false)
     {
+	$description = false;
+	$sisalto = false;
+
 	foreach($array as $avain => $arvo)
 	{
 		if($avain === $this->_parametrit)
+			if($arvo['code'] != "") print "koodi";
+			else
+			{
 			if(!$listatyyppi)
 				print "<h3>" . $arvo['name'] . "</h3>";
 			else 
-				print "<td><b>" . $arvo['name'] . "</b></td>";
+				print "<td><b>" . $arvo['name'] . "</b></td>"; }
 
-		$this->esita_sisatiedot($arvo, $avain, $listatyyppi);		
+		$value = $this->esita_sisatiedot($arvo, $avain, $listatyyppi);
+
+		if($value == 2) $sisalto = true;
+		elseif($value == 1) $description = true;
+
+		if($listatyyppi && $description && !$sisalto)
+		{
+			print "<td class=\"lista_value\"><table class=\"value\">";
+		}
+
 	}
+
+	//if(!$sisalto) print "<td>nbsp;</td>";
+	
+	if($listatyyppi && $description && !$sisalto) print "<tr><td>&nbsp;</td></tr>";
+
+	if($listatyyppi && $description) print "</table></td>";
     }
 
     private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
@@ -417,8 +466,7 @@
 
     private function esita_sisatiedot($array, $avain, $listatyyppi = false)
     {
-	$sisalto = 0;
-	$desc = false;
+	$arvo = 0;
 
 	if(is_array($array) && $avain !== $this->_parametrit)
 	{
@@ -428,45 +476,36 @@
 		{
 			if(!is_array($arvo2))
 			{
-				if($sisalto == 0) $sisalto = 1;
-
 				if(!$listatyyppi)
 				{
 					if($edellinen_arvo == "description")
-					{
-						$desc = true;
-						print "<p><i>" . $arvo2 . "</i></p>";
-					}
+						//print "<p><i>" . $arvo2 . "</i></p>";
+						print "<h3>" . $arvo2 . "</h3>";
 					else
 						if($avain2 == $this->_sisalto)
-						{
 							print "<p>" . $arvo2 . "</p>";
-							$sisalto = 2;
-						}
 				}
 				else
 				{
 					if($edellinen_arvo == "description")
 					{
-						$desc = true;
-						print "<td><i>" . $arvo2 . "</i></td>";
+						print "<td valign=\"top\" class=\"lista_description\"><b>" . $arvo2 . "</b></td>";
+						$arvo = 1;
 					}
 					else
 						if($avain2 == $this->_sisalto)
 						{
-							$sisalto = 2;
-							print "<td>" . $arvo2 . "</td>";
+							print "<tr><td>" . $arvo2 . "</td></tr>";
+							$arvo = 2;
 						}
 				}
-				if($listatyyppi) print $sisalto;
+
 				$edellinen_arvo = $arvo2;
 			}
 		}
 	}
-	//if($listatyyppi) print "loppu";
-	if($desc && $sisalto == 1 && $listatyyppi)
-		print "jep";		
-//print "<td>tyhj?</td>";
+
+	return $arvo;
     }
 
     private function hae_array($array, $etsittava, &$pal_array)
@@ -474,11 +513,126 @@
    	foreach($array as $avain => $arvo)
 	{
 		if($avain === $this->_nimi && ($avain == $etsittava || $arvo == $etsittava))
+		{
 			$pal_array = $array;
+			break;
+		}
 		else
 			if(is_array($arvo)) $this->hae_array($arvo, $etsittava, $pal_array);
 	}
     }
+
+    private function parsi_nimi($nimi)
+    {
+	$palautus = "";
+	for($i=0; $i < strlen($nimi); $i++)
+	{
+		if($nimi[$i] == "_") $palautus .= " ";
+		else $palautus .= $nimi[$i];
+	}
+	
+	return ucfirst($palautus);
+    }
+
+    public function hae_tieto($ryhma, $nimi)
+    {
+	return $this->hae_array2($this->_tietotaulu, $ryhma, $nimi);
+    }
+
+    private function hae_array2($array, $etsittava_nimi, $etsittava_arvo)
+    {
+	$haettava_paikallistettu = false;
+
+   	foreach($array as $avain => $arvo)
+	{
+		if($haettava_paikallistettu)
+		{
+			$loytyi = 0;
+
+			if(is_array($arvo))
+				foreach($arvo as $avain2 => $arvo2)
+				{
+					$edellinen = "";
+
+					if(is_array($arvo2))
+						foreach($arvo2 as $avain3 => $arvo3)
+						{
+							if($edellinen == "value" && $avain3 == $this->_sisalto)
+								if($loytyi) return $arvo3;
+
+							if($avain3 == $this->_sisalto && $arvo3 == $etsittava_arvo)
+								$loytyi = 1;
+
+							$edellinen = $arvo3;
+						}
+				}
+		}
+
+		if($avain === $this->_nimi && $arvo == $etsittava_nimi)
+		{
+			$haettava_paikallistettu = true;
+
+			if(is_array($array[$this->_parametrit]))
+				foreach($array[$this->_parametrit] as $avain2 => $arvo2)
+					if(strtolower($avain2)  == strtolower($etsittava_arvo)) return $arvo2;
+		}
+		else
+		{
+			$haettava_paikallistettu = false;
+
+			if(is_array($arvo)) 
+			{
+				$palautus = $this->hae_array2($arvo, $etsittava_nimi, $etsittava_arvo);
+				if($palautus != "") return $palautus;
+			}
+		}
+	}
+    }
+
+    private function hae_paataulut()
+    {
+	$taulut = array();
+
+	// k?y l?pi p??taulun kannasta l?htien
+	foreach($this->_tietotaulu as $avain => $arvo)
+		if(is_array($arvo))
+			foreach($arvo as $avain2 => $arvo2)
+				if(is_array($arvo2))
+					foreach($arvo2 as $avain3 => $arvo3)
+						if($avain3 == $this->_nimi && !is_array($arvo3))
+							array_push($taulut, $arvo3);
+
+	return $taulut;
+    }
+
+    private function nayta_quick_jump_valikko()
+    {
+	$taulut = $this->hae_paataulut();
+	
+	print "<script type=\"text/javascript\">
+		<!--
+
+		function loadPage(pageURL)
+		{
+			if(pageURL.selectedIndex > 0)
+			{
+				sivu = \"" . $_SERVER['SCRIPT_NAME'] . "?" . $_SERVER['QUERY_STRING'] . "#\";
+				location.href = sivu + pageURL.options[pageURL.selectedIndex].value;
+			}
+		}
+
+		//-->
+		</script>";
+
+	print "<form name=\"qj_form\">
+		<select name=\"quick_jump\">";
+
+	foreach($taulut as $avain => $arvo)
+		print "<option name=\"quick_jump_header\" onclick=\"loadPage(document.qj_form.quick_jump); \" value=\"" . $arvo . "\">" . $this->parsi_nimi($arvo) . "</option>";
+
+	print "</select>
+		</form>";
+    }
 }
 
 ?>

Modified: trunk/osinfo/lib/infostring.functions
===================================================================
--- trunk/osinfo/lib/infostring.functions	2007-03-07 07:34:47 UTC (rev 684)
+++ trunk/osinfo/lib/infostring.functions	2007-03-07 07:42:15 UTC (rev 685)
@@ -146,13 +146,12 @@
 	   [ ! "$(grep '[^\ *]' <<< "${@}")" ]; then
 
 		# but only if verbosity does not require extreme explicity (-vv)
-		if [ $isverbose -ge 2 ]; then
+		if [ $isverbose -lt 2 ]; then
 
 			# if the last non-empty item (second to last)
 			# is an attribute or a header, unset it
-			if [ "$(grep 'attribute\|header' <<< ${infostring[$((${#infostring[@]}-1))]} )" ]; then
-				unset infostring[$((${#infostring[@]}-1))]
-				# HACK: As syntax highlighting seems broken in my editor I add this comment hack as a workaround: "
+			if [ "$(grep 'attribute\|header' <<< "${infostring[$((${#infostring[@]}-1))]}" )" ]; then
+				unset infostring[$((${#infostring[@]}-1))];
 			fi
 		fi
 	else # there is an input value



From lamikae at mail.berlios.de  Thu Mar  8 08:10:44 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:10:44 +0100
Subject: [Osinfo-commit] r686 - in trunk/osinfo: html lib
	modules/experimental
Message-ID: <200703080710.l287Aius025896@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:10:43 +0100 (Thu, 08 Mar 2007)
New Revision: 686

Modified:
   trunk/osinfo/html/index3.php
   trunk/osinfo/html/xml-parseri.php
   trunk/osinfo/html/xmltyyli.css
   trunk/osinfo/lib/daemon.functions
   trunk/osinfo/modules/experimental/video
Log:
netcat -q strikes again

Modified: trunk/osinfo/html/index3.php
===================================================================
--- trunk/osinfo/html/index3.php	2007-03-07 07:42:15 UTC (rev 685)
+++ trunk/osinfo/html/index3.php	2007-03-08 07:10:43 UTC (rev 686)
@@ -98,7 +98,7 @@
 		{
 			border: 1px solid black;
 			padding: 5px;
-			padding: 10px;
+			padding: 0px 10px 10px 10px;
 			margin-left: " . $this->_DivResoluutiot[P??Frame][0] . ";
 			margin-top: " . $this->_DivResoluutiot[P??Frame][1] . ";
 			margin-bottom: " . $this->_DivResoluutiot[P??Frame][1] . ";
@@ -176,7 +176,9 @@
 						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"),
 						"script_version" => $this->_parseri->hae_tieto("script", "version"),
 						"ram" => $this->_parseri->hae_tieto("ram", "Physical RAM"),
-						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive")
+						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive"),
+						"device" => $this->_parseri->hae_tieto("iface", "Device"),
+						"ip" => $this->_parseri->hae_tieto("iface", "IPv4")
 						);
 					}
 
@@ -250,7 +252,7 @@
 							elseif($laskuri % $this->_clientteja_rivilla == 0)
  								print "</tr><tr>";
 
-							print "<td class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
+							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
 
 							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
 								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
@@ -420,8 +422,6 @@
 		}
 		else
 		{
-			//if(file_exists($this->_index_view))
-			//	include($this->_index_view);
 			$this->nayta_index_view();
 		}
 
@@ -430,7 +430,7 @@
 
 	private function nayta_index_view()
 	{
-		print "index view";
+		print "<h3>index view</h3>";
 
 		$this->listaa_tiedostot(false);
 	}

Modified: trunk/osinfo/html/xml-parseri.php
===================================================================
--- trunk/osinfo/html/xml-parseri.php	2007-03-07 07:42:15 UTC (rev 685)
+++ trunk/osinfo/html/xml-parseri.php	2007-03-08 07:10:43 UTC (rev 686)
@@ -13,24 +13,9 @@
     private $_tyyppi = "--tyyppi--";
     private $_sisalto = "--sisalto--";
 
-    // listan tunnistin
-    private $_lista = "lista";
-
     public function __construct()
     {
-/*
-	if(file_exists($tiedoston_nimi))
-	{
-		$this->_parsittava_tiedosto = $tiedoston_nimi;
-		$this->lue_tiedoston_sisalto();
-	
-		$this->_tietotaulu = $this->etsi_tagi("", 0);
-	}
-	else
-	{
-		print "<p>File " . $tiedoston_nimi . " not found</p>";
-	}
-*/
+
     }
 
     public function parsi_tiedosto($tiedoston_nimi)
@@ -263,11 +248,11 @@
 	print "<table style=\"width: 100%\">
 		<tr>
 		<td><h2>" . $this->parsi_nimi($this->hae_tieto("computer", "hostname")) . "</h2></td>
-		<td>Quick jump: ";
+		<td>";
 
 	$this->nayta_quick_jump_valikko();
 
-	print "</td><td><p>Script version: <i>" . $this->hae_tieto("script", "version") . "</i><br />" .
+	print "</td><td style=\"text-align: right\"><p>Script version: <i>" . $this->hae_tieto("script", "version") . "</i><br />" .
 		"Scanning date: <i>" . $this->hae_tieto("scanning", "date") . "</i></p></td>";
 
 	print "</td></tr></table>";
@@ -277,8 +262,7 @@
 
 	if(is_array($array))
 	{
-		if($array[$this->_lista] == "true") $listatyyppi = true;
-		else $listatyyppi = false;
+		$listatyyppi = false;
 
 		// k?y l?pi p??taulun kannasta l?htien
 		foreach($array as $avain => $arvo)
@@ -297,14 +281,14 @@
 	$div_avattu = false;
 	$attribuutti_suljettu = false;
 	$atrb = false;
-
+/*
 	if(is_array($array[$this->_parametrit]))
 	{
 		$temp_array = $array[$this->_parametrit];
 		if($temp_array[$this->_lista] == "true")
 			$listatyyppi = true;
 	}
-
+*/
 	$listatyyppi = true;
 
 	foreach($array as $avain => $arvo)
@@ -362,7 +346,7 @@
 			}
 			else
 			{	
-				if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $avain!= $this->_lista && $arvo != "scanning" && $arvo != "script")
+				if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $arvo != "scanning" && $arvo != "script")
 				{	
 					if($avain == $this->_nimi)
 					{	
@@ -386,7 +370,8 @@
 				}
 				elseif($arvo == "scanning" || $arvo == "script") break;
 
-				$this->esita_sisatiedot($arvo, $avain);
+				if($arvo[$this->_nimi] == "value")
+					$this->esita_sisatiedot($listatyyppi, false, $arvo[$this->_sisalto]);
 				
 				if(is_array($arvo) && $arvo[$this->_nimi] != "value")
 				{
@@ -416,57 +401,87 @@
 
     private function esita_attribuutit(&$palautus_array, $array, $listatyyppi = false)
     {
-	$description = false;
-	$sisalto = false;
+	$description_str = "";
+	$code_str = "";
+	$name_str = "";
+	$values = array();
 
 	foreach($array as $avain => $arvo)
 	{
 		if($avain === $this->_parametrit)
-			if($arvo['code'] != "") print "koodi";
-			else
-			{
-			if(!$listatyyppi)
-				print "<h3>" . $arvo['name'] . "</h3>";
-			else 
-				print "<td><b>" . $arvo['name'] . "</b></td>"; }
+		{
+			if($arvo['code'] != "") $code_str = $arvo['code'];
+			if($arvo['name'] != "") $name_str = $arvo['name'];
+		}
 
-		$value = $this->esita_sisatiedot($arvo, $avain, $listatyyppi);
+		$paluutaulu = $this->hae_sisatiedot($arvo, $avain);
+		if($paluutaulu['description'] != "") 
+			$description_str = $paluutaulu['description'];
 
-		if($value == 2) $sisalto = true;
-		elseif($value == 1) $description = true;
+		if($paluutaulu['value'] != "") {
+			array_push($values, $paluutaulu['value']);
+		}
+	}
 
-		if($listatyyppi && $description && !$sisalto)
-		{
-			print "<td class=\"lista_value\"><table class=\"value\">";
+	if($code_str != "")
+		$this->esita_sisatiedot($listatyyppi, $code_str, $values);
+	else {
+		if($description_str != "")
+			$this->esita_sisatiedot($listatyyppi, $description_str, $values);
+		else {
+			if($name_str != "")
+				$this->esita_sisatiedot($listatyyppi, $name_str, $values);
 		}
-
 	}
+    }
 
-	//if(!$sisalto) print "<td>nbsp;</td>";
+    private function esita_sisatiedot($listatyyppi, $eka_kentta = false, $arvot)
+    {
+	if($listatyyppi)
+	{	
+		if(is_array($arvot))
+		{
+			if($eka_kentta)
+				print "<td valign=\"top\" class=\"lista_description\"><b>" . $eka_kentta . "</b></td>";
 	
-	if($listatyyppi && $description && !$sisalto) print "<tr><td>&nbsp;</td></tr>";
+			print "<td class=\"lista_value\">";
 
-	if($listatyyppi && $description) print "</table></td>";
-    }
+			if(sizeof($arvot) > 0) 
+			{
+				print "<table class=\"value\">";
+	
+				foreach($arvot as $avain => $arvo)
+					print "<tr><td>" . $arvo . "</td></tr>";
+	
+				print "</table>";
+			}
+			else print "&nbsp;";
+		}
+		else print "<table><tr><td>" . $arvot . "</td></tr></table>";
 
-    private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
-    {
-	if(!$listatyyppi)
-	{
-		for(; $attribuuttilaskuri % $this->_attribuutteja_rivilla != 0; $attribuuttilaskuri++)
-			print "<td>&nbsp;</td>";
-
-		print "</tr></table>";
+		if($eka_kentta) print "</td>";
 	}
 	else
-	{		
-		print "</table>";
+	{	
+		if(is_array($arvot))
+		{
+			if($eka_kentta)
+				print "<h3>" . $eka_kentta . "</h3>";
+	
+			foreach($arvot as $avain => $arvo)
+				print "<p>" . $arvo . "</p>";
+	
+		}
+		else print "<p>" . $arvot . "</p>";
+
+		if($eka_kentta) print "</td>";
 	}
     }
 
-    private function esita_sisatiedot($array, $avain, $listatyyppi = false)
+    private function hae_sisatiedot($array, $avain)
     {
-	$arvo = 0;
+	$description = "";
+	$value = "";
 
 	if(is_array($array) && $avain !== $this->_parametrit)
 	{
@@ -476,28 +491,12 @@
 		{
 			if(!is_array($arvo2))
 			{
-				if(!$listatyyppi)
-				{
-					if($edellinen_arvo == "description")
-						//print "<p><i>" . $arvo2 . "</i></p>";
-						print "<h3>" . $arvo2 . "</h3>";
-					else
-						if($avain2 == $this->_sisalto)
-							print "<p>" . $arvo2 . "</p>";
-				}
+				if($edellinen_arvo == "description")
+					$description = $arvo2;
 				else
 				{
-					if($edellinen_arvo == "description")
-					{
-						print "<td valign=\"top\" class=\"lista_description\"><b>" . $arvo2 . "</b></td>";
-						$arvo = 1;
-					}
-					else
-						if($avain2 == $this->_sisalto)
-						{
-							print "<tr><td>" . $arvo2 . "</td></tr>";
-							$arvo = 2;
-						}
+					if($avain2 == $this->_sisalto)
+						$value = $arvo2;
 				}
 
 				$edellinen_arvo = $arvo2;
@@ -505,9 +504,26 @@
 		}
 	}
 
-	return $arvo;
+	$palautus = array("value" => $value, "description" => $description);
+
+	return $palautus;
     }
 
+    private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
+    {
+	if(!$listatyyppi)
+	{
+		for(; $attribuuttilaskuri % $this->_attribuutteja_rivilla != 0; $attribuuttilaskuri++)
+			print "<td>&nbsp;</td>";
+
+		print "</tr></table>";
+	}
+	else
+	{		
+		print "</table>";
+	}
+    }
+
     private function hae_array($array, $etsittava, &$pal_array)
     {
    	foreach($array as $avain => $arvo)
@@ -560,7 +576,7 @@
 							if($edellinen == "value" && $avain3 == $this->_sisalto)
 								if($loytyi) return $arvo3;
 
-							if($avain3 == $this->_sisalto && $arvo3 == $etsittava_arvo)
+							if($avain3 == $this->_sisalto && $arvo3 === $etsittava_arvo)
 								$loytyi = 1;
 
 							$edellinen = $arvo3;
@@ -578,8 +594,6 @@
 		}
 		else
 		{
-			$haettava_paikallistettu = false;
-
 			if(is_array($arvo)) 
 			{
 				$palautus = $this->hae_array2($arvo, $etsittava_nimi, $etsittava_arvo);
@@ -608,10 +622,12 @@
     private function nayta_quick_jump_valikko()
     {
 	$taulut = $this->hae_paataulut();
-	
+		
 	print "<script type=\"text/javascript\">
 		<!--
 
+		document.write(\"Quick jump:\")
+
 		function loadPage(pageURL)
 		{
 			if(pageURL.selectedIndex > 0)
@@ -622,7 +638,10 @@
 		}
 
 		//-->
-		</script>";
+		</script>
+		<noscript>	
+		This feature requires JavaScript.
+		</noscript>";
 
 	print "<form name=\"qj_form\">
 		<select name=\"quick_jump\">";

Modified: trunk/osinfo/html/xmltyyli.css
===================================================================
--- trunk/osinfo/html/xmltyyli.css	2007-03-07 07:42:15 UTC (rev 685)
+++ trunk/osinfo/html/xmltyyli.css	2007-03-08 07:10:43 UTC (rev 686)
@@ -1,27 +1,40 @@
-div.kentta
+td.lista_description, td.lista_value, div.kentta
 {
-	border: 1px dashed black;
-	margin-top: 10px;
-	padding: 0px 10px 10px 10px;
-
 	background-color: #e9fbf7;
 }
 
-table.attribuutti
+td.attribuutti_td, table.lista_attribuutti
 {
-	width: 100%;	
+	background-color: #8db7ae;
 }
 
-tr.jepaa
+div.kentta
 {
+	font-size: 13px;
 	border: 1px dashed black;
-	width: 100%;	
+	margin-top: 10px;
+	padding: 0px 10px 10px 10px;
 }
 
+table.attribuutti, table.lista_attribuutti
+{
+	width: 100%;
+}
+
 td.attribuutti_td
 {
 	margin: 5px 5px 5px 5px;
 	border: 1px dotted black;
 	padding: 7px;
-	background-color: #8db7ae;
 }
+
+td.lista_description
+{
+	width: 30%;
+}
+
+table.value
+{
+	padding: 0px;
+	margin: 0px;
+}

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-07 07:42:15 UTC (rev 685)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 07:10:43 UTC (rev 686)
@@ -1,3 +1,4 @@
+#!/bin/bash
 ################################################################################
 ################################################################################
 ## osinfo daemon functions                                                    ##

Modified: trunk/osinfo/modules/experimental/video
===================================================================
--- trunk/osinfo/modules/experimental/video	2007-03-07 07:42:15 UTC (rev 685)
+++ trunk/osinfo/modules/experimental/video	2007-03-08 07:10:43 UTC (rev 686)
@@ -15,6 +15,9 @@
 	flush_values
 }
 
+	# list of known graphics drivers
+	KNOWN_GPU_DRIVERS="nvidia\|nv\|fglrx\|radeon\|ati"
+
 	print_X_info() {
 		add_header         'Windowing system'
 
@@ -42,8 +45,7 @@
 		add_footer
 
 		add_subheader      'Capabilities'
-		 add_attribute      'AGP speed'
-		 add_values         "$(get_agp_mode)"
+		 get_agp_rate
 		add_footer
 
 		add_footer
@@ -51,10 +53,37 @@
 
 	print_setup() {
 		add_header         'Setup'
-		
+
+		# print GPU driver info
+		add_subheader      'GPU driver for X11'
+		 # vendor string
+		 add_attribute      "Vendor"
+		 add_values         "$(grep ' Module' ${XORG_LOG} | \
+		                       grep ${KNOWN_GPU_DRIVERS}: | \
+		                       sed 's/[^\"]*\"\([^\"]*\)\"[^.]*/\1/')"
+		add_footer         'GPU driver'
+
+		print_extensions
+
+
+		add_subheader      'Errors'
+		 add_attribute      'X'
+		 #add_values         "$(get_xorg_errors)"
+		add_footer
+
+		add_footer
+	}
+
+	print_extensions(){
+		add_subheader      'Extensions'
+		#print_glx_info
+		add_attribute      "GLX extension"
+		add_values         "$(get_glx)"
+
+		#print_dri
 		add_attribute      'Direct rendering'
 		add_values         "Enabled: $(glxinfo 2> /dev/null | grep -i 'direct rendering' | \
-		                               awk -F: {'print $2'})"
+					awk -F: {'print $2'})"
 
 		add_attribute      "OpenGL renderer"
 		add_values         "$(get_opengl_renderer)"
@@ -68,18 +97,10 @@
 		add_attribute      "GLX vendor"
 		add_values         "$(get_glx_vendor)"
 
-		add_attribute      "GLX"
-		add_values         "$(get_glx)"
-
 		add_attribute      "AIGLX"
 		add_values         "$(get_aiglx)"
-
-		add_subheader      'Errors'
-		 add_attribute      'X'
-		 #add_values         "$(get_xorg_errors)"
-		add_footer
-
-		add_footer
+		
+		add_footer         'Extensions'
 	}
 
 	function get_videodev_name () {
@@ -105,11 +126,11 @@
 		}
 
 	function get_aiglx () {
-		grep ') AIGLX' ${XORG_LOG}
+		grep ') AIGLX' ${XORG_LOG} | awk -F':' {'print $2'}
 		}
 
 	function get_glx () {
-		grep ') GLX' ${XORG_LOG}
+		grep ') GLX' ${XORG_LOG} | awk -F':' {'print $2'}
 		}
 
 	function get_found_chipset () {
@@ -124,8 +145,9 @@
 		echo ${found_chipsets[0]}
 		}
 
-	function get_agp_mode () {
-		grep 'Using AGP [0-9]*x mode' ${XORG_LOG}
+	function get_agp_rate () {
+		add_attribute "$(grep 'AGP' ${XORG_LOG} | awk -F':' {'print $2'} )"
+		add_values    "$(grep 'AGP' ${XORG_LOG} | awk -F':' {'print $3'} )"
 		}
 
 	function get_xorg_errors () {



From lamikae at mail.berlios.de  Thu Mar  8 08:11:20 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:11:20 +0100
Subject: [Osinfo-commit] r687 - trunk/osinfo
Message-ID: <200703080711.l287BKok025958@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:11:20 +0100 (Thu, 08 Mar 2007)
New Revision: 687

Modified:
   trunk/osinfo/osinfo
Log:
netcat -q strikes again

Modified: trunk/osinfo/osinfo
===================================================================
--- trunk/osinfo/osinfo	2007-03-08 07:10:43 UTC (rev 686)
+++ trunk/osinfo/osinfo	2007-03-08 07:11:20 UTC (rev 687)
@@ -29,7 +29,7 @@
 	# send the resulted xml to the host if the option is set
 	# or generate the html page of the resulted xml file
 	if [ $tcpsend -eq 1 ]; then
-		cat "${XMLFILE}" | netcat "$HOST" "$PORT" -q 1
+		cat "${XMLFILE}" | netcat "$HOST" "$PORT"
 	elif [ $usexml -eq 1 ] && [ $quiet -ne 1 ]; then
 		cat "${XMLFILE}"
 	elif [ $makehtml -eq 1 ]; then



From lamikae at mail.berlios.de  Thu Mar  8 08:27:50 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:27:50 +0100
Subject: [Osinfo-commit] r688 - trunk/osinfo/lib
Message-ID: <200703080727.l287RokZ026556@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:27:50 +0100 (Thu, 08 Mar 2007)
New Revision: 688

Modified:
   trunk/osinfo/lib/daemon.functions
Log:
some verbosity

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 07:11:20 UTC (rev 687)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 07:27:50 UTC (rev 688)
@@ -30,15 +30,15 @@
 
 	# allocate a temp file
 	inputxml_tmp="$(mktemp /tmp/osinfo.XXXXXX)"
+	echo "XML will be saved to $inputxml_tmp"
 	TempFiles=("${TempFiles[@]}" "$inputxml_tmp")
 
 	# kill other netcat instances (nc often hangs)
 	killall -9 nc 2>/dev/null
 
+	# in an eternal loop listen to incoming data
+	while (true); do
 
-	# in an eternal loop...
-	while [ a = a ]; do
-
 		netcat_instance	> "${inputxml_tmp}"	# which breaks after EOF
 
 		# notify the user of the received file



From lamikae at mail.berlios.de  Thu Mar  8 08:35:14 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:35:14 +0100
Subject: [Osinfo-commit] r689 - trunk/osinfo/lib
Message-ID: <200703080735.l287ZEsb026867@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:35:14 +0100 (Thu, 08 Mar 2007)
New Revision: 689

Modified:
   trunk/osinfo/lib/daemon.functions
Log:
some verbosity

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 07:27:50 UTC (rev 688)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 07:35:14 UTC (rev 689)
@@ -30,7 +30,13 @@
 
 	# allocate a temp file
 	inputxml_tmp="$(mktemp /tmp/osinfo.XXXXXX)"
-	echo "XML will be saved to $inputxml_tmp"
+
+	# debug output
+	if [ $isdebug -eq 1 ]; then
+		echo "XML will be saved to $inputxml_tmp"
+		chmod 644 $inputxml_tmp
+	fi
+	
 	TempFiles=("${TempFiles[@]}" "$inputxml_tmp")
 
 	# kill other netcat instances (nc often hangs)



From lamikae at mail.berlios.de  Thu Mar  8 08:40:19 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:40:19 +0100
Subject: [Osinfo-commit] r690 - trunk/osinfo/lib
Message-ID: <200703080740.l287eJRs027087@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:40:19 +0100 (Thu, 08 Mar 2007)
New Revision: 690

Modified:
   trunk/osinfo/lib/daemon.functions
Log:
some verbosity for debugging

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 07:35:14 UTC (rev 689)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 07:40:19 UTC (rev 690)
@@ -31,13 +31,15 @@
 	# allocate a temp file
 	inputxml_tmp="$(mktemp /tmp/osinfo.XXXXXX)"
 
-	# debug output
+	# verbose output for debugging
 	if [ $isdebug -eq 1 ]; then
 		echo "XML will be saved to $inputxml_tmp"
 		chmod 644 $inputxml_tmp
+	else
+		# don't add this temp file to the list, because
+		# we don't want to delete this one!
+		TempFiles=("${TempFiles[@]}" "$inputxml_tmp")
 	fi
-	
-	TempFiles=("${TempFiles[@]}" "$inputxml_tmp")
 
 	# kill other netcat instances (nc often hangs)
 	killall -9 nc 2>/dev/null



From lamikae at mail.berlios.de  Thu Mar  8 08:46:28 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:46:28 +0100
Subject: [Osinfo-commit] r691 - trunk/osinfo/lib
Message-ID: <200703080746.l287kS0w027317@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:46:28 +0100 (Thu, 08 Mar 2007)
New Revision: 691

Modified:
   trunk/osinfo/lib/daemon.functions
Log:
debugging

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 07:40:19 UTC (rev 690)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 07:46:28 UTC (rev 691)
@@ -53,7 +53,7 @@
 		info "$(date)"
 		info "$(wc -l $inputxml_tmp | grep -Eo '^[0-9]*') lines caught!"
 		flush_values
-
+exit 0
 		# if the input is (not) valid osinfo xml..
 		if [ ! "$(grep -i '<!doctype osinfo' ${inputxml_tmp})" ]; then
 			info "Input is not valid osinfo xml!"



From lamikae at mail.berlios.de  Thu Mar  8 08:56:27 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 08:56:27 +0100
Subject: [Osinfo-commit] r692 - in trunk/osinfo: conf lib
Message-ID: <200703080756.l287uRsv027928@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 08:56:27 +0100 (Thu, 08 Mar 2007)
New Revision: 692

Modified:
   trunk/osinfo/conf/osinfo.conf
   trunk/osinfo/lib/daemon.functions
   trunk/osinfo/lib/global_variables
Log:
changed the default run directory to /var/www/osinfo

Modified: trunk/osinfo/conf/osinfo.conf
===================================================================
--- trunk/osinfo/conf/osinfo.conf	2007-03-08 07:46:28 UTC (rev 691)
+++ trunk/osinfo/conf/osinfo.conf	2007-03-08 07:56:27 UTC (rev 692)
@@ -4,7 +4,7 @@
 
 timestamp="$(date +%Y-%m-%d_%H:%M:%S)"
 logpath="/var/log/osinfo"
-rundir="/var/run/osinfo"
+rundir="/var/www/osinfo"
 
 [ ! -e "${logpath}" ] && mkdir -p "${logpath}"
 [ ! -e "${rundir}" ] && mkdir -p "${rundir}"

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 07:46:28 UTC (rev 691)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 07:56:27 UTC (rev 692)
@@ -53,7 +53,7 @@
 		info "$(date)"
 		info "$(wc -l $inputxml_tmp | grep -Eo '^[0-9]*') lines caught!"
 		flush_values
-exit 0
+
 		# if the input is (not) valid osinfo xml..
 		if [ ! "$(grep -i '<!doctype osinfo' ${inputxml_tmp})" ]; then
 			info "Input is not valid osinfo xml!"

Modified: trunk/osinfo/lib/global_variables
===================================================================
--- trunk/osinfo/lib/global_variables	2007-03-08 07:46:28 UTC (rev 691)
+++ trunk/osinfo/lib/global_variables	2007-03-08 07:56:27 UTC (rev 692)
@@ -49,7 +49,7 @@
 
 # if the conf file is not available..
 [ ! "$error_log" ] && error_log="/var/log/osinfo.log"
-[ ! "$rundir" ] && rundir="/var/www/localhost/htdocs/osinfo"
+[ ! "$rundir" ] && rundir="/var/www/osinfo"
 
 #XMLFILE="$(get_hostname)_$(get_mac_address).xml"
 INDEXXMLFILE="${rundir}/index.xml"



From lamikae at mail.berlios.de  Thu Mar  8 09:07:31 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 09:07:31 +0100
Subject: [Osinfo-commit] r693 - trunk/osinfo/lib
Message-ID: <200703080807.l2887VrA028464@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 09:07:30 +0100 (Thu, 08 Mar 2007)
New Revision: 693

Modified:
   trunk/osinfo/lib/cmdline
   trunk/osinfo/lib/daemon.functions
Log:
fixed a bug in daemon functions (not foolproof)

Modified: trunk/osinfo/lib/cmdline
===================================================================
--- trunk/osinfo/lib/cmdline	2007-03-08 07:56:27 UTC (rev 692)
+++ trunk/osinfo/lib/cmdline	2007-03-08 08:07:30 UTC (rev 693)
@@ -75,7 +75,6 @@
 					# listen for incoming tcp connections,
 					# receive xml sheet from osinfo clients
 					tcpdaemon=1
-					makehtml=1
 
 					if [ "$2" ]; then
 						tcp_listening_port="$2"

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 07:56:27 UTC (rev 692)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 08:07:30 UTC (rev 693)
@@ -207,7 +207,7 @@
 
 	# extract hostname from the xml
 	[ ! "$client_hostname" ] && \
-	client_hostname="$(extract 'computer hostname' ${1} )"
+	client_hostname="$(extract 'hostname' ${1} )"
 
 	# create or update the xml file for the host
 	cat "$inputxml_tmp" > "${hostdir}/${client_hostname}.xml"
@@ -227,7 +227,7 @@
 	for clients in ${hostdir}/*.xml; do
 
 		# extract hostname from the xml
-		client_hostname="$(extract 'computer hostname' ${clients} )"
+		client_hostname="$(extract 'hostname' ${clients} )"
 
 		# create or update <hostname>.html.
 		# if the specific <hostname>.xsl is not found, use 'generic-host.xsl'
@@ -255,9 +255,9 @@
 
 
 extract() {
-	# $1 is the extract string
+	# $1 is the extract method
 	# $2 is the input file
-	grep -i "${1}" "${2}" | \
+	grep -oi "${1}=\"[a-zA-Z0-9.]*\"" "${2}" | \
 	   sed 's/[^\"]*\"\([^\"]*\)\"[^.]*/\1/'
 }
 



From lamikae at mail.berlios.de  Thu Mar  8 09:16:32 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 09:16:32 +0100
Subject: [Osinfo-commit] r694 - in trunk/osinfo: lib modules
Message-ID: <200703080816.l288GW3u028936@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 09:16:31 +0100 (Thu, 08 Mar 2007)
New Revision: 694

Modified:
   trunk/osinfo/lib/daemon.functions
   trunk/osinfo/lib/print.functions
   trunk/osinfo/modules/users
Log:
more precise xml cleaner/validator

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 08:07:30 UTC (rev 693)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 08:16:31 UTC (rev 694)
@@ -47,7 +47,7 @@
 	# in an eternal loop listen to incoming data
 	while (true); do
 
-		netcat_instance	> "${inputxml_tmp}"	# which breaks after EOF
+		netcat_instance > "${inputxml_tmp}" # which breaks after EOF
 
 		# notify the user of the received file
 		info "$(date)"
@@ -254,6 +254,10 @@
 }
 
 
+# this extracts a value from an attribute in XML, used for hostname detection.
+# may be buggy!! BE WARNED!!
+# example: extract 'hostname' $input_file
+# where $input_file may contain line: <computer profile="desktop" hostname="mayhem"/>
 extract() {
 	# $1 is the extract method
 	# $2 is the input file

Modified: trunk/osinfo/lib/print.functions
===================================================================
--- trunk/osinfo/lib/print.functions	2007-03-08 08:07:30 UTC (rev 693)
+++ trunk/osinfo/lib/print.functions	2007-03-08 08:16:31 UTC (rev 694)
@@ -363,8 +363,8 @@
 
 	validate_xml_item() {
 		# trim all leading spaces ; trim all non-alphabetical characters ;
-		# spaces to downscores ; uppercase to lowercase
-		sed 's/^\ *// ; s/^([a-z]*)//g; s/\ \|\//_/g ' <<< "${@}"| tr 'A-Z' 'a-z'
+		# spaces to downscores ; clear all escape characters ; uppercase to lowercase
+		sed 's/^\ *// ; s/^([a-z]*)//g; s/\ \|\//_/g ; s/\\[nt]//g' <<< "${@}"| tr 'A-Z' 'a-z'
 	}
 #######
 

Modified: trunk/osinfo/modules/users
===================================================================
--- trunk/osinfo/modules/users	2007-03-08 08:07:30 UTC (rev 693)
+++ trunk/osinfo/modules/users	2007-03-08 08:16:31 UTC (rev 694)
@@ -1,3 +1,4 @@
+#!/bin/bash
 #######################
 # USERS
 #



From lamikae at mail.berlios.de  Thu Mar  8 09:28:55 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 09:28:55 +0100
Subject: [Osinfo-commit] r695 - in trunk/osinfo: html lib
Message-ID: <200703080828.l288StPV029850@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 09:28:55 +0100 (Thu, 08 Mar 2007)
New Revision: 695

Modified:
   trunk/osinfo/html/xml-parseri.php
   trunk/osinfo/lib/daemon.functions
Log:
breaked some deamon functions into two, some comments, and added an xml validator

Modified: trunk/osinfo/html/xml-parseri.php
===================================================================
--- trunk/osinfo/html/xml-parseri.php	2007-03-08 08:16:31 UTC (rev 694)
+++ trunk/osinfo/html/xml-parseri.php	2007-03-08 08:28:55 UTC (rev 695)
@@ -13,6 +13,8 @@
     private $_tyyppi = "--tyyppi--";
     private $_sisalto = "--sisalto--";
 
+    private $_virheet = array();
+
     public function __construct()
     {
 
@@ -20,6 +22,8 @@
 
     public function parsi_tiedosto($tiedoston_nimi)
     {
+	unset($this->_virheet);
+
 	if(file_exists($tiedoston_nimi))
 	{
 		$this->_parsittava_tiedosto = $tiedoston_nimi;
@@ -44,6 +48,8 @@
 
     public function nayta_tietotaulu()
     {
+	if(sizeof($this->_virheet) > 0) return 0;
+
 	print "<p>--------- KOKO TIETOTAULU:---------</p>";
 	print "<pre>";
 	print_r($this->_tietotaulu);
@@ -239,8 +245,10 @@
 
     public function hae_arvot($kanta, $attribuutit = "")
     {
-	  $this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
-	  $this->esita_tiedot($esitettava_array, $attribuutit);
+	if(sizeof($this->_virheet) > 0) return 0;
+
+	$this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
+	$this->esita_tiedot($esitettava_array, $attribuutit);
     }
 
     private function esita_tiedot($array, $tarkenne = "")
@@ -551,7 +559,9 @@
     }
 
     public function hae_tieto($ryhma, $nimi)
-    {
+    {	
+	if(sizeof($this->_virheet) > 0) return 0;
+
 	return $this->hae_array2($this->_tietotaulu, $ryhma, $nimi);
     }
 

Modified: trunk/osinfo/lib/daemon.functions
===================================================================
--- trunk/osinfo/lib/daemon.functions	2007-03-08 08:16:31 UTC (rev 694)
+++ trunk/osinfo/lib/daemon.functions	2007-03-08 08:28:55 UTC (rev 695)
@@ -54,48 +54,57 @@
 		info "$(wc -l $inputxml_tmp | grep -Eo '^[0-9]*') lines caught!"
 		flush_values
 
-		# if the input is (not) valid osinfo xml..
+		# if the input is not osinfo xml, don't go any futher
 		if [ ! "$(grep -i '<!doctype osinfo' ${inputxml_tmp})" ]; then
 			info "Input is not valid osinfo xml!"
 
-		else
-
-			update_hostxml "${inputxml_tmp}" # save input to correct location
-			if [ $makehtml -eq 1 ]; then     # if we want html ...
-
-				# update all host html pages
-				update_hosthtmls
-
-				# update the sidebar html
-				update_sidebar > "${rundir}/sidebar.html"
-
-				# create/update the index (overview) xml
-				create_indexxml > "${INDEXXMLFILE}"
-
-				# update the overview html (the right hand panel)
-				update_index >  "${rundir}/overview.html"
-
-				# inform the user of the generated files
-				if [ $isverbose -ge 1 ]; then
-				    if [ -e "${INDEXXMLFILE}" ]; then
-						info "File '$INDEXXMLFILE' created"
-					fi
-					flush_values
-				fi
+		else # validate xml
+			xmllint -valid ${inputxml_tmp}
+			if [ $? -ne 0 ]; then
+				info "Input is not valid xml!"
+			#else # since the DTD cannot yet be properly always loaded, don't die here
+				process_input_xml
 			fi
 		fi
 
 		flush_values
 		unset client_hostname
 
-		# :)
-
 	done
 
 	cleanup_temp_files
 }
 
+######################
+# process_input_xml ##
+######################
+#
+process_input_xml() {
+	update_hostxml "${inputxml_tmp}" # save input to correct location
+	if [ $makehtml -eq 1 ]; then     # if we want html ...
 
+		# update all host html pages
+		update_hosthtmls
+
+		# update the sidebar html
+		update_sidebar > "${rundir}/sidebar.html"
+
+		# create/update the index (overview) xml
+		create_indexxml > "${INDEXXMLFILE}"
+
+		# update the overview html (the right hand panel)
+		update_index >  "${rundir}/overview.html"
+
+		# inform the user of the generated files
+		if [ $isverbose -ge 1 ]; then
+			if [ -e "${INDEXXMLFILE}" ]; then
+				info "File '$INDEXXMLFILE' created"
+			fi
+			flush_values
+		fi
+	fi
+}
+	
 ####################
 # create_indexxml ##
 ####################



From lamikae at mail.berlios.de  Thu Mar  8 09:35:17 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 09:35:17 +0100
Subject: [Osinfo-commit] r696 - trunk/osinfo/modules
Message-ID: <200703080835.l288ZHU4030418@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 09:35:17 +0100 (Thu, 08 Mar 2007)
New Revision: 696

Modified:
   trunk/osinfo/modules/ram
Log:
problems with RAM XML

Modified: trunk/osinfo/modules/ram
===================================================================
--- trunk/osinfo/modules/ram	2007-03-08 08:28:55 UTC (rev 695)
+++ trunk/osinfo/modules/ram	2007-03-08 08:35:17 UTC (rev 696)
@@ -105,7 +105,7 @@
 					add_values        "$(extr_xml_value \
 					                   $(grep 'asset tag' $banknode))"
 
-					add_footer        "Bank"
+					add_footer        "Bank $bank"
 
 					[ $usexml -ne 1 ] && flush_values
 					# xml cannot flush here, as add_footer is defined below



From lamikae at mail.berlios.de  Thu Mar  8 09:41:01 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Thu, 8 Mar 2007 09:41:01 +0100
Subject: [Osinfo-commit] r697 - trunk/osinfo/modules
Message-ID: <200703080841.l288f1Xi030720@sheep.berlios.de>

Author: lamikae
Date: 2007-03-08 09:41:01 +0100 (Thu, 08 Mar 2007)
New Revision: 697

Modified:
   trunk/osinfo/modules/ram
Log:
problems with RAM XML fixed

Modified: trunk/osinfo/modules/ram
===================================================================
--- trunk/osinfo/modules/ram	2007-03-08 08:35:17 UTC (rev 696)
+++ trunk/osinfo/modules/ram	2007-03-08 08:41:01 UTC (rev 697)
@@ -114,7 +114,7 @@
 
 			fi
 
-			[ $usexml -eq 1 ] && add_footer # RAM
+			[ $usexml -eq 1 ] && add_footer 'RAM'
 			flush_values
 		fi
 	}



From lamikae at mail.berlios.de  Fri Mar  9 13:31:26 2007
From: lamikae at mail.berlios.de (lamikae at BerliOS)
Date: Fri, 9 Mar 2007 13:31:26 +0100
Subject: [Osinfo-commit] r698 - in trunk/osinfo/modules: . experimental
Message-ID: <200703091231.l29CVQFo003826@sheep.berlios.de>

Author: lamikae
Date: 2007-03-09 13:31:26 +0100 (Fri, 09 Mar 2007)
New Revision: 698

Added:
   trunk/osinfo/modules/experimental/firewall
Modified:
   trunk/osinfo/modules/aa_INDEX
   trunk/osinfo/modules/experimental/iptables
   trunk/osinfo/modules/ram
Log:
added a new experimental module firewall

Modified: trunk/osinfo/modules/aa_INDEX
===================================================================
--- trunk/osinfo/modules/aa_INDEX	2007-03-08 08:41:01 UTC (rev 697)
+++ trunk/osinfo/modules/aa_INDEX	2007-03-09 12:31:26 UTC (rev 698)
@@ -8,13 +8,13 @@
 
 # these are used to control run access and validify against
 
-MODULES_LINUX='system distro kernel processor ram memory hdd network wlan dmi applications terminal devices cdrom users services battery'
+MODULES_LINUX='system distro kernel processor ram memory hdd network wlan dmi applications terminal devices cdrom users services battery firewall'
 MODULES_BSD='system kernel applications terminal network devices dmi'
 MODULES_BROKEN='printers lvm bus sensors nagios samba nfs shares'
-MODULES_REAL_ROOT_ONLY='system memory cdrom processor terminal applications network wlan devices services hdd printers dmi services bus battery ram'
-MODULES_SU_ONLY='cdrom hdd dmi'
+MODULES_REAL_ROOT_ONLY='system memory cdrom processor terminal applications network wlan devices services hdd printers dmi services bus battery ram firewall'
+MODULES_SU_ONLY='cdrom hdd dmi firewall'
 # MUST contain a list of all modules. This is used to find any invalid modules.
-MODULES_ALL='applications cdrom devices distro dmi env hdd kernel memory network printers processor services system terminal users wlan lvm bus sensors nagios battery video ram samba nfs shares'
+MODULES_ALL='applications cdrom devices distro dmi env hdd kernel memory network printers processor services system terminal users wlan lvm bus sensors nagios battery video ram samba nfs shares firewall'
 
 
 ## META-MODULES

Added: trunk/osinfo/modules/experimental/firewall
===================================================================
--- trunk/osinfo/modules/experimental/firewall	2007-03-08 08:41:01 UTC (rev 697)
+++ trunk/osinfo/modules/experimental/firewall	2007-03-09 12:31:26 UTC (rev 698)
@@ -0,0 +1,11 @@
+#!/bin/bash
+##########
+# FIREWALL
+#
+
+Module_firewall() {
+	local moduleName="Firewall"
+	local moduleDescription="Firewall setup"
+	module_header   "${moduleName}"
+
+}
\ No newline at end of file

Modified: trunk/osinfo/modules/experimental/iptables
===================================================================
--- trunk/osinfo/modules/experimental/iptables	2007-03-08 08:41:01 UTC (rev 697)
+++ trunk/osinfo/modules/experimental/iptables	2007-03-09 12:31:26 UTC (rev 698)
@@ -1,3 +1,8 @@
+#!/bin/bash
+##########
+# IPTABLES
+#
+
 Module_iptables() {
 	local moduleName="Iptables"
 	local moduleDescription="Linux kernel iptables rule parser"
@@ -3,7 +8,30 @@
 	module_header   "${moduleName}"
 
-	iptables -L -v -n
+	add_header  'Prerouting'
+	add_footer  'Prerouting'
 
+	add_header  'Input'
+	get_input_iptables;
+	add_footer  'Input'
+	
+	add_header  'Forward'
+	add_footer  'Forward'
+
+	add_header  'Output'
+	add_footer  'Output'
+
+	add_header  'Postrouting'
+	add_footer  'Postrouting'
+	
+	#iptables -L -v -n
+
 	flush_values
 }
 
+	# helpers
+	get_input_iptables() {
+		add_attribute ''
+		add_values    ""
+
+	}
+

Modified: trunk/osinfo/modules/ram
===================================================================
--- trunk/osinfo/modules/ram	2007-03-08 08:41:01 UTC (rev 697)
+++ trunk/osinfo/modules/ram	2007-03-09 12:31:26 UTC (rev 698)
@@ -111,7 +111,6 @@
 					# xml cannot flush here, as add_footer is defined below
 
 				done
-
 			fi
 
 			[ $usexml -eq 1 ] && add_footer 'RAM'



From lamikae at mail.berlios.de  Mon Mar 12 08:57:30 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 08:57:30 +0100
Subject: [Osinfo-commit] r700 - trunk/osinfo/html
Message-ID: <200703120757.l2C7vUK3010894@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 08:57:29 +0100 (Mon, 12 Mar 2007)
New Revision: 700

Removed:
   trunk/osinfo/html/index3.php
Log:
p?\195?\164ivitys

Deleted: trunk/osinfo/html/index3.php
===================================================================
--- trunk/osinfo/html/index3.php	2007-03-12 07:55:07 UTC (rev 699)
+++ trunk/osinfo/html/index3.php	2007-03-12 07:57:29 UTC (rev 700)
@@ -1,439 +0,0 @@
-<?php
-
-$index = new Index();
-
-$index->tulosta_alkukoodi(true);
-$index->nayta_sivuframe();
-$index->nayta_paaframe($_GET['target']);
-$index->tulosta_loppukoodi();
-
-class Index
-{
-	private $_DivResoluutiot = array("SivuFrame" => array('10px', '10px', '20%', '500'),
-					"P??Frame" => array('10px', '10px', '70%', '500'));
-	private $_xmlkansio = "hosts";
-	private $_xmlparseri = "xml-parseri.php";
-	private $_parseri;
-	private $_clientteja_rivilla = 3;
-
-	public function __construct()
-    	{
-		if(file_exists($this->_xmlparseri))
-		{
-			include($this->_xmlparseri);
-
-			$this->_parseri = new xmlparseri();
-		}
-		else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
-	}
-
-	public function tulosta_alkukoodi($tyylit = true)
-	{
-		print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
-
-		print "<html>\n";	
-		print "<head>\n";	
-		print "<title>OS info</title>\n\n";
-
-		if($tyylit) $this->tulosta_tyyli();
-
-		print "\n\n</head>\n\n";
-		print "<body>\n\n";
-	}
-
-	public function tulosta_loppukoodi()
-	{
-		print "</body>\n";
-		print "</html>";
-	}
-	
-	private function tulosta_tyyli()
-	{
-		$varit = array(222, 197, 148);
-		$varisyote = "r=" . $varit[0] . "&g=" . $varit[1] . "&b=" . $varit[2];
-
-		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
-		print "<style type=\"text/css\">
-
-		body
-		{
-			background-color: #eddcbc;
-		}
-		
-		div.SivuFrame, div.PaaFrame
-		{ 
-			float: left;
-		}
-		
-		div.SivuFrameSisalto, div.PaaFrame
-		{
-			background-color: rgb(" . $varit[0] . ", " . $varit[1] . ", " . $varit[2] . ");
-		}
-
-		div.SivuFrame
-		{
-			margin-left: " . $this->_DivResoluutiot[SivuFrame][0] . ";
-			margin-top: " . $this->_DivResoluutiot[SivuFrame][1] . ";
-			margin-bottom: " . $this->_DivResoluutiot[SivuFrame][1] . ";
-			width: " . $this->_DivResoluutiot[SivuFrame][2] . ";
-			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
-			min-width: 200;
-			height: auto;
-		}
-
-		div.SivuFrameSisalto
-		{
-			padding: 10px;
-		}
-
-		div.SivuFrameFade
-		{
-			background-image: url('fade.php?w=1&h=150&" . $varisyote . "');
-			background-repeat: repeat-x;
-			background-position: top;
-			height: 150px;
-		}
-
-		div.PaaFrame
-		{
-			border: 1px solid black;
-			padding: 5px;
-			padding: 0px 10px 10px 10px;
-			margin-left: " . $this->_DivResoluutiot[P??Frame][0] . ";
-			margin-top: " . $this->_DivResoluutiot[P??Frame][1] . ";
-			margin-bottom: " . $this->_DivResoluutiot[P??Frame][1] . ";
-			width: " . $this->_DivResoluutiot[P??Frame][2] . ";
-			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
-			min-width: 600;
-			height: auto;
-			clear: none;
-		}
-
-		p.valitus
-		{
-			color: red;
-		}
-
-		ul.hostit
-		{
-			padding: 0px;
-			padding-left: 10px;
-		}
-
-		li.kuvaus
-		{
-			font-size: 12px;
-		}
-
-		a:link
-		{
-			color: rgb(0,0,255);
-		}
-
-		a:visited
-		{
-			color: rgb(0,0,200);
-		}
-
-		</style>";
-	}
-	
-	private function listaa_tiedostot($valikko = false)
-	{
-		if(file_exists($this->_xmlkansio))
-		{
-			$kansio = opendir($this->_xmlkansio);
-
-			$ul_avattu = false;
-
-			$xml_array = array();
-		
-			for($i=0; $tiedosto = readdir($kansio); $i++)
-			{
-				$p_array = explode(".", $tiedosto);
-				$paate = $p_array[sizeof($p_array)-1];
-		
-				if($i > 1 && ($paate == "xml"))
-				{
-					$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $tiedosto);
-
-					if($valikko)
-					{
-					$temp_array = array("tiedosto" => $tiedosto,
-						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
-						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
-						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
-						"os" => $this->_parseri->hae_tieto("computer", "os"),
-						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"));
-					}
-					else
-					{
-					$temp_array = array("tiedosto" => $tiedosto,
-						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
-						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
-						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
-						"os" => $this->_parseri->hae_tieto("computer", "os"),
-						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"),
-						"script_version" => $this->_parseri->hae_tieto("script", "version"),
-						"ram" => $this->_parseri->hae_tieto("ram", "Physical RAM"),
-						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive"),
-						"device" => $this->_parseri->hae_tieto("iface", "Device"),
-						"ip" => $this->_parseri->hae_tieto("iface", "IPv4")
-						);
-					}
-
-					array_push($xml_array, $temp_array);
-
-				}
-			}
-
-			$domainit = $this->lajittele_array($xml_array, "domain");
-			$profilet = array();
-
-			foreach($domainit as $domain => $arvo)
-			{
-				$temp_array = array($domain => $this->lajittele_array($arvo, "profile"));
-				$this->array_lisaa_samaan($profilet, $temp_array);
-			}
-
-			ksort($profilet);
-
-			//print "<pre>";
-			//print_r($domainit);
-			//print_r($profilet);
-			//print "</pre>";
-			
-			if($valikko)
-			{
-				foreach($profilet as $domain => $profiles)
-				{
-					ksort($profiles);
-					print "<ul class=\"hostit\"><li>Domain: <i>" . $domain . "</i>";
-	
-					foreach($profiles as $profile => $hostnames)
-					{
-						print "<ul class=\"hostit\"><li>Profile: <i>" . $profile . 
-							"</i><ul class=\"hostit\">";
-	
-						foreach($hostnames as $hostname => $arvot)
-						{
-							print "<li><b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
-								$arvot["hostname"] . "</a></b><ul class=\"hostit\">
-								<li class=\"kuvaus\">" . $arvot["os"] . "</li>
-								<li class=\"kuvaus\">" . $arvot["cpu"] . "</li>
-								</ul></li>";
-	
-						}
-	
-						print "</ul></li></ul>";
-					}
-	
-					print "</li></ul>";
-				}
-			}
-			else
-			{
-				foreach($profilet as $domain => $profiles)
-				{
-					ksort($profiles);
-					print "<div class=\"kentta\"><h3>Domain: <i>" . $domain . "</i>";
-	
-					foreach($profiles as $profile => $hostnames)
-					{
-						print "<div class=\"kentta\"><h3>Profile: <i>" . $profile . 
-							"</i><table class=\"attribuutti\" cellspacing=\"10\">";
-
-						$laskuri = 0;
-	
-						foreach($hostnames as $hostname => $arvot)
-						{
-							if($laskuri == 0) 
-								print "<tr>";
-							elseif($laskuri % $this->_clientteja_rivilla == 0)
- 								print "</tr><tr>";
-
-							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
-
-							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
-								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
-
-							foreach($arvot as $tyyppi => $arvo)
-							{
-								if($tyyppi != "hostname" && $tyyppi != "domain" && $tyyppi != "profile" && $tyyppi != "tiedosto" && $arvo != "")
-								{
-									print "<li class=\"kuvaus\">" . $arvo . "</li>";
-								}
-							}
-
-							print "</ul></td>";
-
-							$laskuri++;
-						}
-
-						while($laskuri % $this->_clientteja_rivilla != 0)
-						{
-							print "<td>&nbsp;</td>";
-							$laskuri++;
-						}
-	
-						print "</table></h3></div>";
-					}
-	
-					print "</h3></div>";
-				}
-			}
-		}
-		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
-	}
-
-	private function lajittele_array($array, $nimi)
-	{
-		$nimet = array(" ");
-		$nimet_lajiteltuna = array();
-
-		foreach($array as $avain => $arvo)
-		{
-			if(is_array($arvo))
-			{
-				$loytyi = false;
-
-				for($i=0; $i < sizeof($nimet); $i++)
-					if($arvo[$nimi] == $nimet[$i]) $loytyi = true;
-
-				if(!$loytyi)
-				{
-					$temp_array = array($arvo[$nimi] => array());
-					$this->array_lisaa_samaan($nimet_lajiteltuna, $temp_array);
-					array_push($nimet, $arvo[$nimi]);
-				}
-				
-				array_push($nimet_lajiteltuna[$arvo[$nimi]], $arvo);
-			}
-		}
-
-		return $nimet_lajiteltuna;
-	}
-
-	private function array_lisaa_samaan(&$array) 
-	{
-		$argumentit = func_get_args();
-	
-		foreach($argumentit as $argumentti) 
-		{
-			if(is_array($argumentti)) 
-			{
-				foreach($argumentti as $avain => $arvo) 
-				{
-					$array[$avain] = $arvo;
-					$paluuarvo++;
-				}
-			}
-			else $array[$argumentti] = "";
-		}
-	
-		return $paluuarvo;
-	}
-
-	private function hae_viimeksi_paivitetty()
-	{
-		if(file_exists($this->_xmlkansio))
-		{
-			$kansio = opendir($this->_xmlkansio);
-	
-			$suurin = 0;
-		
-			for($i=0; $tiedosto = readdir($kansio); $i++)
-			{
-				$p_array = explode(".", $tiedosto);
-				$paate = $p_array[sizeof($p_array)-1];
-		
-				if($i > 1 && ($paate == "xml"))
-				{
-					$aika = filemtime($this->_xmlkansio . "/" . $tiedosto);
-	
-					if($aika > $suurin)
-						$suurin = $aika;
-				}
-			}
-			
-			return $suurin;
-		}
-	}
-	
-	public function nayta_sivuframe()
-	{
-		print "<div class=\"SivuFrame\">";
-		print "<div class=\"SivuFrameSisalto\">";
-
-		print "<h3>OS info</h3>
-			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
-			<hr />";
-
-		$this->listaa_tiedostot(true);
-	
-		print "<hr />";
-
-		print "<p>Last update:</p>";
-
-		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
-
-		if($viimeksi_paivitetty > 0)
-			print "<p><i>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</i></p>";
-
-		//include("sidebar.html");
-	
-		print "</div>";
-
-		print "<div class=\"SivuFrameFade\"></div>";
-
-		print "</div>";
-	}
-	
-	public function nayta_paaframe($sivu = "")
-	{
-		print "<div class=\"PaaFrame\">";
-		
-		if($sivu != "")
-		{
-			if(file_exists($this->_xmlkansio . "/" . $sivu))
-			{
-				/*
-				$parametrit = $_POST['osinfo'];
-			
-				print "<p>
-					<form action=\"" . $PHP_SELF . "\" method=\"post\">
-					Parameters: <input type=\"text\" name=\"osinfo\" value=\"" . $parametrit . "\" />
-						<input type=\"submit\" value=\"ok\" />
-					</form>
-					</p>";
-				*/
-	
-				//print "<pre>";
-
-				$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $sivu);
-				
-				//$this->_parseri->nayta_tietotaulu();
-				$this->_parseri->hae_arvot("osinfo");
-
-				//print "</pre>";
-			}
-			else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
-
-		}
-		else
-		{
-			$this->nayta_index_view();
-		}
-
-		print "</div>";
-	}
-
-	private function nayta_index_view()
-	{
-		print "<h3>index view</h3>";
-
-		$this->listaa_tiedostot(false);
-	}
-}
-
-?> 
\ No newline at end of file



From lamikae at mail.berlios.de  Mon Mar 12 08:55:09 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 08:55:09 +0100
Subject: [Osinfo-commit] r699 - trunk/osinfo/html
Message-ID: <200703120755.l2C7t9IM010645@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 08:55:07 +0100 (Mon, 12 Mar 2007)
New Revision: 699

Modified:
   trunk/osinfo/html/index.php
   trunk/osinfo/html/xml-parseri.php
   trunk/osinfo/html/xmltyyli.css
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-09 12:31:26 UTC (rev 698)
+++ trunk/osinfo/html/index.php	2007-03-12 07:55:07 UTC (rev 699)
@@ -1,269 +1,412 @@
-<?php 
-// osinfo
-// http://osinfo.berlios.de/
-// This program is free software; you can redistribute it and/or
-// modify it under the terms of the GNU General Public License
-// as published by the Free Software Foundation; either version 2
-// of the License, or (at your option) any later version.
-// This program is distributed in the hope that it will be useful,
-// but WITHOUT ANY WARRANTY; without even the implied warranty of
-// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-// GNU General Public License for more details.
-// You should have received a copy of the GNU General Public License
-// along with this program; if not, write to the Free Software
-// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
-// osinfo release version number
-$VERSION = "2.5.1";
+<?php
 
-define('APP_ROOT', dirname(__FILE__));
-define('IN_PHPSYSINFO', true);
+$index = new Index();
 
-ini_set('magic_quotes_runtime', 'off');
-ini_set('register_globals', 'off');
+$index->tulosta_alkukoodi(true);
+$index->nayta_sivuframe();
+$index->nayta_paaframe($_GET['target']);
+$index->tulosta_loppukoodi();
 
-if (!file_exists(APP_ROOT . '/index.html')) {
-  echo '<center><b>Error: index.html does not exist.</b></center>';
-  exit;
-} 
+class Index
+{
+	private $_DivResoluutiot = array("SivuFrame" => array('10px', '10px', '20%', '500'),
+					"P??Frame" => array('10px', '10px', '70%', '500'));
+	private $_xmlkansio = "hosts";
+	private $_xmlparseri = "xml-parseri.php";
+	private $_parseri;
+	private $_clientteja_rivilla = 3;
 
-osinfo --listen 7776
+	public function __construct()
+    	{
+		if(file_exists($this->_xmlparseri))
+		{
+			include($this->_xmlparseri);
 
+			$this->_parseri = new xmlparseri();
+		}
+		else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
+	}
 
-require_once(APP_ROOT . '/config.php'); // get the config file
+	public function tulosta_alkukoodi($tyylit = true)
+	{
+		print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
 
-if (!extension_loaded('xml')) {
-  echo '<center><b>Error: phpsysinfo requires xml module.</b></center>';
-  exit;
-} 
+		print "<html>\n";	
+		print "<head>\n";	
+		print "<title>OS info</title>\n\n";
 
-if (!extension_loaded('pcre')) {
-  echo '<center><b>Error: phpsysinfo requires pcre module.</b></center>';
-  exit;
-} 
+		if($tyylit) $this->tulosta_tyyli();
 
-// Check to see if where running inside of phpGroupWare
-if (file_exists("../header.inc.php") && isset($_REQUEST['sessionid']) && $_REQUEST['sessionid'] && $_REQUEST['kp3'] && $_REQUEST['domain']) {
-  define('PHPGROUPWARE', 1);
-  $phpgw_info['flags'] = array('currentapp' => 'phpsysinfo-dev');
-  include('../header.inc.php');
-} else {
-  define('PHPGROUPWARE', 0);
-}
+		print "\n\n</head>\n\n";
+		print "<body>\n\n";
+	}
 
-// DEFINE TEMPLATE_SET
-if (isset($_POST['template'])) {
-  $template = $_POST['template'];
-} elseif (isset($_GET['template'])) {
-  $template = $_GET['template'];
-} elseif (isset($_COOKIE['template'])) {
-  $template = $_COOKIE['template'];
-} else {
-  $template = $default_template; 
-}
+	public function tulosta_loppukoodi()
+	{
+		print "</body>\n";
+		print "</html>";
+	}
+	
+	private function tulosta_tyyli()
+	{
+		$varit = array(222, 197, 148);
+		$varisyote = "r=" . $varit[0] . "&g=" . $varit[1] . "&b=" . $varit[2];
 
-// check to see if we have a random
-if ($template == 'random') {
-  $dir = opendir(APP_ROOT . "/templates/");
-  while (($file = readdir($dir)) != false) {
-    if ($file != 'CVS' && $file != '.' && $file != '..') {
-      $buf[] = $file;
-    } 
-  } 
-  $template = $buf[array_rand($buf, 1)];
-} 
+		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
+		print "<style type=\"text/css\">
 
-if ($template != 'xml' && $template != 'random') {
-  // figure out if the template exists
-  $template = basename($template);
-  if (!file_exists(APP_ROOT . "/templates/" . $template)) {
-    // use default if not exists.
-    $template = $default_template;
-  }
-}
+		body
+		{
+			background-color: #eddcbc;
+		}
+		
+		div.SivuFrame, div.PaaFrame
+		{ 
+			float: left;
+		}
+		
+		div.SivuFrameSisalto, div.PaaFrame
+		{
+			background-color: rgb(" . $varit[0] . ", " . $varit[1] . ", " . $varit[2] . ");
+		}
 
-// Store the current template name in a cookie, set expire date to 30 days later
-// if template is xml then skip
-if ($template != 'xml') {
-  setcookie("template", $template, (time() + 60 * 60 * 24 * 30));
-  $_COOKIE['template'] = $template; //update COOKIE Var
-}
+		div.SivuFrame
+		{
+			margin-left: " . $this->_DivResoluutiot[SivuFrame][0] . ";
+			margin-top: " . $this->_DivResoluutiot[SivuFrame][1] . ";
+			margin-bottom: " . $this->_DivResoluutiot[SivuFrame][1] . ";
+			width: " . $this->_DivResoluutiot[SivuFrame][2] . ";
+			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
+			min-width: 200;
+			height: auto;
+		}
 
+		div.SivuFrameSisalto
+		{
+			padding: 10px;
+		}
 
-define('TEMPLATE_SET', $template);
-// get our current language
-// default to english, but this is negotiable.
-if (isset($_POST['lng'])) {
-  $lng = $_POST['lng'];
-} elseif (isset($_GET['lng'])) {
-  $lng = $_GET['lng'];
-  if (!file_exists(APP_ROOT . '/includes/lang/' . $lng . '.php')) {
-    $lng = 'browser';
-  } 
-} elseif (isset($_COOKIE['lng'])) {
-  $lng = $_COOKIE['lng'];
-} else {
-  $lng = $default_lng;
-} 
-// Store the current language selection in a cookie, set expire date to 30 days later
-setcookie("lng", $lng, (time() + 60 * 60 * 24 * 30));
-$_COOKIE['lng'] = $lng; //update COOKIE Var
+		div.SivuFrameFade
+		{
+			background-image: url('fade.php?w=1&h=150&" . $varisyote . "');
+			background-repeat: repeat-x;
+			background-position: top;
+			height: 150px;
+		}
 
-if ($lng == 'browser') {
-  // see if the browser knows the right languange.
-  if (isset($_SERVER['HTTP_ACCEPT_LANGUAGE'])) {
-    $plng = split(',', $_SERVER['HTTP_ACCEPT_LANGUAGE']);
-    if (count($plng) > 0) {
-      while (list($k, $v) = each($plng)) {
-        $k = split(';', $v, 1);
-        $k = split('-', $k[0]);
-        if (file_exists(APP_ROOT . '/includes/lang/' . $k[0] . '.php')) {
-          $lng = $k[0];
-          break;
-        }
-      }
-    }
-  }
-}
+		div.PaaFrame
+		{
+			border: 1px solid black;
+			padding: 5px;
+			padding: 0px 10px 10px 10px;
+			margin-left: " . $this->_DivResoluutiot[P??Frame][0] . ";
+			margin-top: " . $this->_DivResoluutiot[P??Frame][1] . ";
+			margin-bottom: " . $this->_DivResoluutiot[P??Frame][1] . ";
+			width: " . $this->_DivResoluutiot[P??Frame][2] . ";
+			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
+			min-width: 600;
+			height: auto;
+			clear: none;
+		}
 
-$charset = 'iso-8859-1';
-$lng = basename($lng);
-if (file_exists(APP_ROOT . '/includes/lang/' . $lng . '.php')) {
-    require_once(APP_ROOT . '/includes/lang/' . $lng . '.php'); // get our language include
-} else {
-    echo "Sorry, we don't support this language.";
-    exit;
-}
+		p.valitus
+		{
+			color: red;
+		}
 
-// Figure out which OS where running on, and detect support
-if (file_exists(APP_ROOT . '/includes/os/class.' . PHP_OS . '.inc.php')) {
-  require_once(APP_ROOT . '/includes/os/class.' . PHP_OS . '.inc.php');
-  $sysinfo = new sysinfo;
-} else {
-  echo '<center><b>Error: ' . PHP_OS . ' is not currently supported</b></center>';
-  exit;
-}
+		ul.hostit
+		{
+			padding: 0px;
+			padding-left: 10px;
+		}
 
-if (!empty($sensor_program)) {
-  $sensor_program = basename($sensor_program);
-  if (file_exists(APP_ROOT . '/includes/mb/class.' . $sensor_program . '.inc.php')) {
-    require_once(APP_ROOT . '/includes/mb/class.' . $sensor_program . '.inc.php');
-    $mbinfo = new mbinfo;
-  } else {
-    echo '<center><b>Error: ' . htmlspecialchars($sensor_program, ENT_QUOTES) . ' is not currently supported</b></center>';
-    exit;
-  } 
-} 
+		li.kuvaus
+		{
+			font-size: 12px;
+		}
 
-require_once(APP_ROOT . '/includes/common_functions.php'); // Set of common functions used through out the app
-require_once(APP_ROOT . '/includes/xml/vitals.php');
-require_once(APP_ROOT . '/includes/xml/network.php');
-require_once(APP_ROOT . '/includes/xml/hardware.php');
-require_once(APP_ROOT . '/includes/xml/memory.php');
-require_once(APP_ROOT . '/includes/xml/filesystems.php');
-require_once(APP_ROOT . '/includes/xml/mbinfo.php');
-require_once(APP_ROOT . '/includes/xml/hddtemp.php');
+		a:link
+		{
+			color: rgb(0,0,255);
+		}
 
-$xml = "<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>\n";
-$xml .= "<!DOCTYPE phpsysinfo SYSTEM \"phpsysinfo.dtd\">\n\n";
-$xml .= created_by();
-$xml .= "<phpsysinfo>\n";
-$xml .= "  <Generation version=\"$VERSION\" timestamp=\"" . time() . "\"/>\n";
-$xml .= xml_vitals();
-$xml .= xml_network();
-$xml .= xml_hardware($hddtemp_devices);
-$xml .= xml_memory();
-$xml .= xml_filesystems();
-if (!empty($sensor_program)) {
-  $xml .= xml_mbtemp();
-  $xml .= xml_mbfans();
-  $xml .= xml_mbvoltage();
-};
-if (isset($hddtemp_avail)) {
-  require_once(APP_ROOT . "/includes/mb/class.hddtemp.inc.php");
-  $hddtemp = new hddtemp($hddtemp_devices);
-  $xml .= xml_hddtemp($hddtemp);
-}
-$xml .= "</phpsysinfo>";
+		a:visited
+		{
+			color: rgb(0,0,200);
+		}
 
-if (TEMPLATE_SET == 'xml') {
-  // just printout the XML and exit
-  Header("Content-Type: text/xml\n\n");
-  print $xml;
-} else {
-  $image_height = get_gif_image_height(APP_ROOT . '/templates/' . TEMPLATE_SET . '/images/bar_middle.gif');
-  define('BAR_HEIGHT', $image_height);
+		</style>";
+	}
+	
+	private function listaa_tiedostot($valikko = false)
+	{
+		if(file_exists($this->_xmlkansio))
+		{
+			$kansio = opendir($this->_xmlkansio);
 
-  if (PHPGROUPWARE != 1) {
-    require_once(APP_ROOT . '/includes/class.Template.inc.php'); // template library
-  } 
-  // fire up the template engine
-  $tpl = new Template(APP_ROOT . '/templates/' . TEMPLATE_SET);
-  $tpl->set_file(array('form' => 'form.tpl')); 
-  // print out a box of information
-  function makebox ($title, $content)
-  {
-    if (empty($content)) {
-      return "";
-    } else {
-      global $webpath;
-      $textdir = direction();
-      $t = new Template(APP_ROOT . '/templates/' . TEMPLATE_SET);
-      $t->set_file(array('box' => 'box.tpl'));
-      $t->set_var('title', $title);
-      $t->set_var('content', $content);
-      $t->set_var('webpath', $webpath);
-      $t->set_var('text_dir', $textdir['direction']);
-      return $t->parse('out', 'box');
-    } 
-  } 
-  // Fire off the XPath class
-  require_once(APP_ROOT . '/includes/XPath.class.php');
-  $XPath = new XPath();
-  $XPath->importFromString($xml); 
-  // let the page begin.
-  require_once(APP_ROOT . '/includes/system_header.php');
+			$ul_avattu = false;
 
-  $tpl->set_var('title', $text['title'] . ': ' . $XPath->getData('/phpsysinfo/Vitals/Hostname') . ' (' . $XPath->getData('/phpsysinfo/Vitals/IPAddr') . ')');
-  $tpl->set_var('vitals', makebox($text['vitals'], html_vitals()));
-  $tpl->set_var('network', makebox($text['netusage'], html_network()));
-  $tpl->set_var('hardware', makebox($text['hardware'], html_hardware()));
-  $tpl->set_var('memory', makebox($text['memusage'], html_memory()));
-  $tpl->set_var('filesystems', makebox($text['fs'], html_filesystems()));
-  // Timo van Roermund: change the condition for showing the temperature, voltage and fans section
-  $html_temp = "";
-  if (!empty($sensor_program)) {
-    if ($XPath->match("/phpsysinfo/MBinfo/Temperature/Item")) {
-      $html_temp = html_mbtemp();
-    }
-    if ($XPath->match("/phpsysinfo/MBinfo/Fans/Item")) {
-      $tpl->set_var('mbfans', makebox($text['fans'], html_mbfans()));
-    } else {
-      $tpl->set_var('mbfans', '');
-    };
-    if ($XPath->match("/phpsysinfo/MBinfo/Voltage/Item")) {
-      $tpl->set_var('mbvoltage', makebox($text['voltage'], html_mbvoltage()));
-    } else {
-      $tpl->set_var('mbvoltage', '');
-    };
-  }
-  if (isset($hddtemp_avail) && $hddtemp_avail) {
-    if ($XPath->match("/phpsysinfo/HDDTemp/Item")) {
-      $html_temp .= html_hddtemp();
-    };
-  }
-  if (strlen($html_temp) > 0) {
-    $tpl->set_var('mbtemp', makebox($text['temperature'], "\n<table width=\"100%\">\n" . $html_temp . "</table>\n"));
-  }
-  
-  // parse our the template
-  $tpl->pfp('out', 'form'); 
- 
-  // finally our print our footer
-  if (PHPGROUPWARE == 1) {
-    $phpgw->common->phpgw_footer();
-  } else {
-    require_once(APP_ROOT . '/includes/system_footer.php');
-  } 
-} 
+			$xml_array = array();
+		
+			for($i=0; $tiedosto = readdir($kansio); $i++)
+			{
+				$p_array = explode(".", $tiedosto);
+				$paate = $p_array[sizeof($p_array)-1];
+		
+				if($i > 1 && ($paate == "xml"))
+				{
+					$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $tiedosto);
 
-?>
+					if($valikko)
+					{
+						$temp_array = array("tiedosto" => $tiedosto,
+						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
+						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
+						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
+						"os" => $this->_parseri->hae_tieto("computer", "os"),
+						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"));
+					}
+					else
+					{
+						$temp_array = array("tiedosto" => $tiedosto,
+						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
+						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
+						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
+						"os" => $this->_parseri->hae_tieto("computer", "os"),
+						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"),
+						"script_version" => $this->_parseri->hae_tieto("script", "version"),
+						"ram" => $this->_parseri->hae_tieto("ram", "Physical RAM"),
+						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive"),
+						"device" => $this->_parseri->hae_tieto("iface", "Device"),
+						"ip" => $this->_parseri->hae_tieto("iface", "IPv4")
+						);
+					}
+
+					array_push($xml_array, $temp_array);
+				}
+			}
+
+			$domainit = $this->lajittele_array($xml_array, "domain");
+			$profilet = array();
+
+			foreach($domainit as $domain => $arvo)
+			{
+				$temp_array = array($domain => $this->lajittele_array($arvo, "profile"));
+				$this->array_lisaa_samaan($profilet, $temp_array);
+			}
+
+			ksort($profilet);
+			
+			if($valikko)
+			{
+				foreach($profilet as $domain => $profiles)
+				{
+					ksort($profiles);
+					print "<ul class=\"hostit\"><li>Domain: <i>" . $domain . "</i>";
+	
+					foreach($profiles as $profile => $hostnames)
+					{
+						print "<ul class=\"hostit\"><li>Profile: <i>" . $profile . 
+							"</i><ul class=\"hostit\">";
+	
+						foreach($hostnames as $hostname => $arvot)
+						{
+							print "<li><b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
+								$arvot["hostname"] . "</a></b><ul class=\"hostit\">
+								<li class=\"kuvaus\">" . $arvot["os"] . "</li>
+								<li class=\"kuvaus\">" . $arvot["cpu"] . "</li>
+								</ul></li>";
+	
+						}
+	
+						print "</ul></li></ul>";
+					}
+	
+					print "</li></ul>";
+				}
+			}
+			else
+			{
+				foreach($profilet as $domain => $profiles)
+				{
+					ksort($profiles);
+					print "<div class=\"kentta2\"><h3>Domain: <i>" . $domain . "</i>";
+	
+					foreach($profiles as $profile => $hostnames)
+					{
+						print "<div class=\"kentta2\"><h3>Profile: <i>" . $profile . 
+							"</i><table class=\"attribuutti\" cellspacing=\"10\">";
+
+						$laskuri = 0;
+	
+						foreach($hostnames as $hostname => $arvot)
+						{
+							if($laskuri == 0) 
+								print "<tr>";
+							elseif($laskuri % $this->_clientteja_rivilla == 0)
+ 								print "</tr><tr>";
+
+							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
+
+							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
+								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
+
+							foreach($arvot as $tyyppi => $arvo)
+							{
+								if($tyyppi != "hostname" && $tyyppi != "domain" && $tyyppi != "profile" && $tyyppi != "tiedosto" && $arvo != "")
+								{
+									print "<li class=\"kuvaus\">" . $arvo . "</li>";
+								}
+							}
+
+							print "</ul></td>";
+
+							$laskuri++;
+						}
+
+						while($laskuri % $this->_clientteja_rivilla != 0)
+						{
+							print "<td>&nbsp;</td>";
+							$laskuri++;
+						}
+	
+						print "</table></h3></div>";
+					}
+	
+					print "</h3></div>";
+				}
+			}
+		}
+		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
+	}
+
+	private function lajittele_array($array, $nimi)
+	{
+		$nimet = array(" ");
+		$nimet_lajiteltuna = array();
+
+		foreach($array as $avain => $arvo)
+		{
+			if(is_array($arvo))
+			{
+				$loytyi = false;
+
+				for($i=0; $i < sizeof($nimet); $i++)
+					if($arvo[$nimi] == $nimet[$i]) $loytyi = true;
+
+				if(!$loytyi)
+				{
+					$temp_array = array($arvo[$nimi] => array());
+					$this->array_lisaa_samaan($nimet_lajiteltuna, $temp_array);
+					array_push($nimet, $arvo[$nimi]);
+				}
+				
+				array_push($nimet_lajiteltuna[$arvo[$nimi]], $arvo);
+			}
+		}
+
+		return $nimet_lajiteltuna;
+	}
+
+	private function array_lisaa_samaan(&$array) 
+	{
+		$argumentit = func_get_args();
+	
+		foreach($argumentit as $argumentti) 
+		{
+			if(is_array($argumentti)) 
+			{
+				foreach($argumentti as $avain => $arvo) 
+				{
+					$array[$avain] = $arvo;
+					$paluuarvo++;
+				}
+			}
+			else $array[$argumentti] = "";
+		}
+	
+		return $paluuarvo;
+	}
+
+	private function hae_viimeksi_paivitetty()
+	{
+		if(file_exists($this->_xmlkansio))
+		{
+			$kansio = opendir($this->_xmlkansio);
+	
+			$suurin = 0;
+		
+			for($i=0; $tiedosto = readdir($kansio); $i++)
+			{
+				$p_array = explode(".", $tiedosto);
+				$paate = $p_array[sizeof($p_array)-1];
+		
+				if($i > 1 && ($paate == "xml"))
+				{
+					$aika = filemtime($this->_xmlkansio . "/" . $tiedosto);
+	
+					if($aika > $suurin)
+						$suurin = $aika;
+				}
+			}
+			
+			return $suurin;
+		}
+	}
+	
+	public function nayta_sivuframe()
+	{
+		print "<div class=\"SivuFrame\">";
+		print "<div class=\"SivuFrameSisalto\">";
+
+		print "<h3>OS info</h3>
+			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
+			<hr />";
+
+		$this->listaa_tiedostot(true);
+	
+		print "<hr />";
+
+		print "<p>Last update:</p>";
+
+		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
+
+		if($viimeksi_paivitetty > 0)
+			print "<p><i>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</i></p>";
+	
+		print "</div>";
+
+		print "<div class=\"SivuFrameFade\"></div>";
+
+		print "</div>";
+	}
+	
+	public function nayta_paaframe($sivu = "")
+	{
+		print "<div class=\"PaaFrame\">";
+		
+		if($sivu != "")
+		{
+			if(file_exists($this->_xmlkansio . "/" . $sivu))
+			{
+				$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $sivu);
+				
+				$this->_parseri->hae_arvot("osinfo");
+			}
+			else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
+		}
+		else
+			$this->nayta_index_view();
+
+		print "</div>";
+	}
+
+	private function nayta_index_view()
+	{
+		print "<h3>index view</h3>";
+
+		$this->listaa_tiedostot(false);
+	}
+}
+
+?> 
\ No newline at end of file

Modified: trunk/osinfo/html/xml-parseri.php
===================================================================
--- trunk/osinfo/html/xml-parseri.php	2007-03-09 12:31:26 UTC (rev 698)
+++ trunk/osinfo/html/xml-parseri.php	2007-03-12 07:55:07 UTC (rev 699)
@@ -2,666 +2,668 @@
 
 class xmlparseri
 {
-    private $_parsittava_tiedosto;
-    private $_tiedoston_sisalto;
-    private $_tietotaulu = array();
-    private $_attribuutteja_rivilla = 3;
+	private $_parsittava_tiedosto;
+	private $_tiedoston_sisalto;
+	private $_tietotaulu = array();
+	private $_attribuutteja_rivilla = 3;
 
-    // "koodit"
-    private $_nimi = "--nimi--";
-    private $_parametrit = "--parametrit--";
-    private $_tyyppi = "--tyyppi--";
-    private $_sisalto = "--sisalto--";
+	// "koodit"
+	private $_nimi = "--nimi--";
+	private $_parametrit = "--parametrit--";
+	private $_tyyppi = "--tyyppi--";
+	private $_sisalto = "--sisalto--";
 
-    private $_virheet = array();
+	private $_virheet = array();
 
-    public function __construct()
-    {
+	public function __construct()
+	{
 
-    }
+	}
 
-    public function parsi_tiedosto($tiedoston_nimi)
-    {
-	unset($this->_virheet);
+	public function parsi_tiedosto($tiedoston_nimi)
+	{
+		$this->_virheet = array();
 
-	if(file_exists($tiedoston_nimi))
-	{
-		$this->_parsittava_tiedosto = $tiedoston_nimi;
-		$this->lue_tiedoston_sisalto();
-	
-		$this->_tietotaulu = $this->etsi_tagi("", 0);
+		if(file_exists($tiedoston_nimi))
+		{
+			$this->_parsittava_tiedosto = $tiedoston_nimi;
+			$this->lue_tiedoston_sisalto();
+		
+			$this->_tietotaulu = $this->etsi_tagi("", 0);
+		}
+		else
+			print "<p class=\"valitus\">File " . $tiedoston_nimi . " not found</p>";
 	}
-	else
+
+	public function hae_arvot($kanta, $attribuutit = "")
 	{
-		print "<p class=\"valitus\">File " . $tiedoston_nimi . " not found</p>";
+		$this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
+		$this->esita_tiedot($esitettava_array, $attribuutit);
 	}
-    }
 
-    private function lue_tiedoston_sisalto()
-    {
-	$fp = fopen($this->_parsittava_tiedosto, "r");
-	$this->_tiedoston_sisalto = "";
-
-	while(false !== ($char = fgetc($fp)))
-		$this->_tiedoston_sisalto .= $char;
-    }
-
-    public function nayta_tietotaulu()
-    {
-	if(sizeof($this->_virheet) > 0) return 0;
-
-	print "<p>--------- KOKO TIETOTAULU:---------</p>";
-	print "<pre>";
-	print_r($this->_tietotaulu);
-	print "</pre>";
-    }
-
-    private function etsi_tagi($etsittava, $indeksi, $taso = -1)
-    {	
-	$taulu = array();
-	$taso++;
-
-	for($i=$indeksi; $i < strlen($this->_tiedoston_sisalto); $i++)
+	public function hae_tieto($ryhma, $nimi)
 	{
-	     if($this->_tiedoston_sisalto[$i] == "<")
-	     {
-		  $tagi = "";
-
-		  for($j=$i+1; $j < strlen($this->_tiedoston_sisalto); $j++)
-		  {
-			if($this->_tiedoston_sisalto[$j] == "<") break;
-			if($this->_tiedoston_sisalto[$j] != ">")
-				$tagi .= $this->_tiedoston_sisalto[$j];
-			else break;
-		  }
-	
-		  $tietue = $this->tarkista_tagi($tagi);
-
-		  switch($tietue[$this->_tyyppi])
-		  {
-		       case 1:
-			    array_push($taulu, $tietue);
-		            break;
-		       case 2:
-			    $paluuarvot = $this->etsi_tagi($tietue[$this->_nimi], $j+1, $taso);
-			    $i = $paluuarvot['indeksi'];
-
-			    $this->array_lisaa_samaan($tietue, $paluuarvot['taulu']);
-			    $sisalto = "";
-	
-			    for($j += 1; $j < strlen($this->_tiedoston_sisalto); $j++)
-			    {
-				$char = ord($this->_tiedoston_sisalto[$j]);
-
-				if($char != 10 && $char != 13 && $char != 9 && 				$this->_tiedoston_sisalto[$j] != "<")
-				   $sisalto .= $this->_tiedoston_sisalto[$j];
-				elseif($this->_tiedoston_sisalto[$j] == "<") break;
-			    }
-
-			    if(!empty($sisalto))
-			    {
-				$temp_array = array($this->_sisalto => $sisalto);
-				$this->array_lisaa_samaan($tietue, $temp_array);
-	 		    }
-
-			    array_push($taulu, $tietue);
-		            break;
-		       case 3:
-			    if($etsittava != "")
-			    {
-			    	if($tietue[$this->_nimi] == $etsittava)
-				     return array("taulu" => $taulu, "indeksi" => $i);
-			    }
-
-		            break;
-		       case 4:
-			    array_push($taulu, $tietue);
-		            break;
-		       default:
-			    break;
-		  }
-	     }
+		return $this->hae_array2($this->_tietotaulu, $ryhma, $nimi);
 	}
-	return $taulu;
-    }
 
-    private function tarkista_tagi($tagi)
-    {    
-	$tyyppi = 0;
-	$nimi = "";
-	$parametrit = array();
-	$parametritagi = false;
-	
-	// tyypit: 1 = tiedoston tyyppitagi
-	//	   2 = aloitustagi
-	//	   3 = lopetustagi
-	//	   4 = yksin?inen tagi
-
-	for($i=strlen($tagi)-1; $i>0; $i--)
+	public function nayta_tietotaulu()
 	{
-	     if($tagi[$i] == "/" && $i > 0) 
-		$parametritagi = true;
+		print "<p>--------- KOKO TIETOTAULU:---------</p>";
+		print "<pre>";
+		print_r($this->_tietotaulu);
+		print "</pre>";
 	}
 
-	if($tagi[0] == "!" || $tagi[0] == "?")
- 	     $tyyppi = 1;
-	else 
+	private function lue_tiedoston_sisalto()
 	{
-	     if($tagi[0] == "/") 
-	     {
-  		  $tyyppi = 3;
+		$fp = fopen($this->_parsittava_tiedosto, "r");
 
-		  for($i=0; $i < strlen($tagi); $i++)
-		     if($tagi[$i] != "/") $nimi .= $tagi[$i];
-	     }
-	     else
-	     {
-	          if($parametritagi) $tyyppi = 4;
-	          else $tyyppi = 2;
+		$this->_tiedoston_sisalto = "";
 
-		     for($i=0; $i < strlen($tagi); $i++)
-		     {
-		          if($i == 0)
-			  {
-				for($j=$i; $j < strlen($tagi); $j++)
-				{	
-				     if($tagi[$j] != " " &&
-				   	ord($tagi[$j]) != 9 && ord($tagi[$j]) != 10 &&
-				   	ord($tagi[$j]) != 13) $nimi .= $tagi[$j];
-				     else break;
+		while(false !== ($char = fgetc($fp)))
+			$this->_tiedoston_sisalto .= $char;
+	}
 
-				     $i = $j;
+	private function etsi_tagi($etsittava, $indeksi, $taso = -1)
+	{
+		$taulu = array();
+		$taso++;
+
+		for($i=$indeksi; $i < strlen($this->_tiedoston_sisalto); $i++)
+		{
+			if($this->_tiedoston_sisalto[$i] == "<")
+			{
+				$tagi = "";
+		
+				for($j=$i+1; $j < strlen($this->_tiedoston_sisalto); $j++)
+				{
+					if($this->_tiedoston_sisalto[$j] == "<") break;
+					if($this->_tiedoston_sisalto[$j] != ">")
+						$tagi .= $this->_tiedoston_sisalto[$j];
+					else break;
 				}
-			  }
-
-			  $temp_atrb_nimi = "";
-			  $temp_atrb_arvo = "";
 			
-			  for($j=$i+2; $j < strlen($tagi); $j++)
-			  {	
-				if($j >= strlen($tagi)-1) break;
-				
-			        if($tagi[$j] != "=" && $tagi[$j] != " " &&
-				   	ord($tagi[$j]) != 9 && ord($tagi[$j]) != 10 &&
-				   	ord($tagi[$j]) != 13)
-			             $temp_atrb_nimi .= $tagi[$j];
-			        elseif($tagi[$j] == "=")
+				$tietue = $this->tarkista_tagi($tagi);
+		
+				switch($tietue[$this->_tyyppi])
 				{
-				     if($tagi[$j+1] == "\"") $indeksi = $j+2;
-				     else $indeksi = $j+1;
+				case 1:
+					array_push($taulu, $tietue);
+					break;
+				case 2:
+					$paluuarvot = $this->etsi_tagi($tietue[$this->_nimi], $j+1, $taso);
+					
+					if($paluuarvot['indeksi'] > $i)
+						$i = $paluuarvot['indeksi'];
 
-				     for($k=$indeksi; $k < strlen($tagi); $k++)
-				     {
-					if($tagi[$k] != "\"")
-					     $temp_atrb_arvo .= $tagi[$k];
-					else
+					$this->array_lisaa_samaan($tietue, $paluuarvot['taulu']);
+					$sisalto = "";
+			
+					for($j += 1; $j < strlen($this->_tiedoston_sisalto); $j++)
 					{
-				     	     $j = $k - 1;
-					     break;
+						$char = ord($this->_tiedoston_sisalto[$j]);
+		
+						if($char != 10 && $char != 13 && $char != 9 && 				$this->_tiedoston_sisalto[$j] != "<")
+							$sisalto .= $this->_tiedoston_sisalto[$j];
+						elseif($this->_tiedoston_sisalto[$j] == "<") break;
 					}
-				     }
-
-			             $i = $j;
-				     break;
+		
+					if(!empty($sisalto))
+					{
+						$temp_array = array($this->_sisalto => $sisalto);
+						$this->array_lisaa_samaan($tietue, $temp_array);
+					}
+		
+					array_push($taulu, $tietue);
+					break;
+				case 3:
+					if($etsittava != "")
+					{
+						if($tietue[$this->_nimi] == $etsittava)
+							return array("taulu" => $taulu, "indeksi" => $i);
+						else
+						{
+							array_push($this->_virheet, "found &lt;/" . $tietue[$this->_nimi] . "&gt;, " . "&lt;/" . $etsittava . "&gt; expected");
+		
+							$taulu[$this->_nimi] == $etsittava;
+							
+							return array("taulu" => $taulu, "indeksi" => $i);
+						}
+					}
+		
+					break;
+				case 4:
+					array_push($taulu, $tietue);
+					break;
+				default:
+					break;
 				}
-			        $i = $j;
-			  }
+			}
+		}
+		return $taulu;
+	}
 
-			  if($temp_atrb_nimi != "") 
-			  {
-				$temp_array = array($temp_atrb_nimi => $temp_atrb_arvo);
-				$this->array_lisaa_samaan($parametrit, $temp_array);
-			  }
-		     }
-	     }
-	}
+	private function tarkista_tagi($tagi)
+	{
+		$tyyppi = 0;
+		$nimi = "";
+		$parametrit = array();
+		$parametritagi = false;
+		
+		// tyypit: 1 = tiedoston tyyppitagi
+		//	   2 = aloitustagi
+		//	   3 = lopetustagi
+		//	   4 = yksin?inen tagi
 	
-	if(empty($parametrit))
-		return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi);
-	else
-		return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi, 
-				$this->_parametrit => $parametrit);
-    }
+		for($i=strlen($tagi)-1; $i>0; $i--)
+		{
+			if($tagi[$i] == "/" && $i > 0)
+				$parametritagi = true;
+		}
+	
+		if($tagi[0] == "!" || $tagi[0] == "?")
+			$tyyppi = 1;
+		else
+		{
+			if($tagi[0] == "/")
+			{
+				$tyyppi = 3;
+		
+				for($i=0; $i < strlen($tagi); $i++)
+					if($tagi[$i] != "/") $nimi .= $tagi[$i];
+			}
+			else
+			{
+				if($parametritagi) $tyyppi = 4;
+				else $tyyppi = 2;
+		
+				for($i=0; $i < strlen($tagi); $i++)
+				{
+					if($i == 0)
+					{
+						for($j=$i; $j < strlen($tagi); $j++)
+						{
+							if($tagi[$j] != " " && ord($tagi[$j]) != 9 && ord($tagi[$j]) != 10 && ord($tagi[$j]) != 13)
+								$nimi .= $tagi[$j];
+							else break;
+		
+							$i = $j;
+						}
+					}
+		
+					$temp_atrb_nimi = "";
+					$temp_atrb_arvo = "";
+					
+					for($j=$i+2; $j < strlen($tagi); $j++)
+					{	
+						if($j >= strlen($tagi)-1) break;
+						
+						if($tagi[$j] != "=" && $tagi[$j] != " " && ord($tagi[$j]) != 9 && ord($tagi[$j]) != 10 && ord($tagi[$j]) != 13)
+							$temp_atrb_nimi .= $tagi[$j];
 
-    private function array_lisaa_samaan(&$array) 
-    {
-	$argumentit = func_get_args();
+						elseif($tagi[$j] == "=")
+						{
+							if($tagi[$j+1] == "\"") $indeksi = $j+2;
+							else $indeksi = $j+1;
+			
+							for($k=$indeksi; $k < strlen($tagi); $k++)
+							{
+								if($tagi[$k] != "\"")
+									$temp_atrb_arvo .= $tagi[$k];
+								else
+								{
+									$j = $k - 1;
+									break;
+								}
+							}
+			
+							$i = $j;
+							break;
+						}
+						$i = $j;
+					}
+		
+					if($temp_atrb_nimi != "")
+					{
+						$temp_array = array($temp_atrb_nimi => $temp_atrb_arvo);
+						$this->array_lisaa_samaan($parametrit, $temp_array);
+					}
+				}
+			}
+		}
+		
+		if(empty($parametrit))
+			return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi);
+		else
+			return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi, $this->_parametrit => $parametrit);
+	}
 
-	foreach($argumentit as $argumentti) 
+	private function array_lisaa_samaan(&$array)
 	{
-		if(is_array($argumentti)) 
+		$argumentit = func_get_args();
+	
+		foreach($argumentit as $argumentti)
 		{
-			foreach($argumentti as $avain => $arvo) 
+			if(is_array($argumentti))
 			{
-				$array[$avain] = $arvo;
-				$paluuarvo++;
+				foreach($argumentti as $avain => $arvo)
+				{
+					$array[$avain] = $arvo;
+					$paluuarvo++;
+				}
 			}
+			else $array[$argumentti] = "";
 		}
-	        else $array[$argumentti] = "";
+	
+		return $paluuarvo;
 	}
 
-	return $paluuarvo;
-    }
-
-    public function hae_arvot($kanta, $attribuutit = "")
-    {
-	if(sizeof($this->_virheet) > 0) return 0;
-
-	$this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
-	$this->esita_tiedot($esitettava_array, $attribuutit);
-    }
-
-    private function esita_tiedot($array, $tarkenne = "")
-    {
-	print "<table style=\"width: 100%\">
-		<tr>
-		<td><h2>" . $this->parsi_nimi($this->hae_tieto("computer", "hostname")) . "</h2></td>
-		<td>";
-
-	$this->nayta_quick_jump_valikko();
-
-	print "</td><td style=\"text-align: right\"><p>Script version: <i>" . $this->hae_tieto("script", "version") . "</i><br />" .
-		"Scanning date: <i>" . $this->hae_tieto("scanning", "date") . "</i></p></td>";
-
-	print "</td></tr></table>";
-
-	$this->_attribuutti_avattu = false;
-	$this->_attribuutti_laskuri = 0;
-
-	if(is_array($array))
+	private function esita_tiedot($array, $tarkenne = "")
 	{
-		$listatyyppi = false;
-
-		// k?y l?pi p??taulun kannasta l?htien
-		foreach($array as $avain => $arvo)
+		print "<table style=\"width: 100%\">
+			<tr>
+			<td><h2>" . $this->parsi_nimi($this->hae_tieto("computer", "hostname")) . "</h2></td>
+			<td>";
+	
+		$this->nayta_quick_jump_valikko();
+	
+		print "</td><td style=\"text-align: right\"><p>Script version: <i>" . $this->hae_tieto("script", "version") . "</i><br />" .
+			"Scanning date: <i>" . $this->hae_tieto("scanning", "date") . "</i></p></td>";
+	
+		print "</td></tr></table>";
+	
+		if(sizeof($this->_virheet) > 0)
 		{
-			if(is_array($arvo)) 
+			print "<p class=\"valitus\">";
+	
+			foreach($this->_virheet as $avain => $virhe)
+				print "Parse error: " . $virhe . "<br />";
+	
+			print "</p>";
+		}
+	
+		$this->_attribuutti_avattu = false;
+		$this->_attribuutti_laskuri = 0;
+	
+		if(is_array($array))
+		{
+			$listatyyppi = false;
+	
+			// k?y l?pi p??taulun kannasta l?htien
+			foreach($array as $avain => $arvo)
 			{
-				if($tarkenne != "") $this->esita_alitiedot($arvo, $listatyyppi, false, $tarkenne);
-				else $this->esita_alitiedot($arvo, $listatyyppi, false);
+				if(is_array($arvo)) 
+				{
+					if($tarkenne != "") $this->esita_alitiedot($arvo, $listatyyppi, false, $tarkenne);
+					else $this->esita_alitiedot($arvo, $listatyyppi, false);
+				}
 			}
 		}
 	}
-    }
 
-    private function esita_alitiedot($array, $listatyyppi = false, $attribuutti_avattu = false, $tarkenne = "", $paasy_alitauluihin = false, $attribuuttilaskuri = 0)
-    {
-	$div_avattu = false;
-	$attribuutti_suljettu = false;
-	$atrb = false;
-/*
-	if(is_array($array[$this->_parametrit]))
+	private function esita_alitiedot($array, $listatyyppi = false, $attribuutti_avattu = false, $tarkenne = "", $paasy_alitauluihin = false, $attribuuttilaskuri = 0)
 	{
-		$temp_array = $array[$this->_parametrit];
-		if($temp_array[$this->_lista] == "true")
-			$listatyyppi = true;
-	}
-*/
-	$listatyyppi = true;
-
-	foreach($array as $avain => $arvo)
-	{	
-		if($tarkenne != "" && $avain != $this->_tyyppi && $arvo == $tarkenne)
-			$paasy_alitauluihin = true;
-		elseif($tarkenne != "" && is_array($arvo)) 
-			$div = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne);
-
-		if($paasy_alitauluihin || $tarkenne == "")
+		$div_avattu = false;
+		$attribuutti_suljettu = false;
+		$atrb = false;
+		$listatyyppi = true;
+	
+		foreach($array as $avain => $arvo)
 		{	
-			if($arvo == "attribute")
-			{
-				if(is_array($array))
+			if($tarkenne != "" && $avain != $this->_tyyppi && $arvo == $tarkenne)
+				$paasy_alitauluihin = true;
+			elseif($tarkenne != "" && is_array($arvo)) 
+				$div = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne);
+	
+			if($paasy_alitauluihin || $tarkenne == "")
+			{	
+				if($arvo == "attribute")
 				{
-					if(!$listatyyppi)
+					if(is_array($array))
 					{
-						if(!$attribuutti_avattu) 
+						if(!$listatyyppi)
 						{
-							print "<table class=\"attribuutti\" cellspacing=\"10\"><tr>";
-							$attribuutti_avattu = true;
+							if(!$attribuutti_avattu) 
+							{
+								print "<table class=\"attribuutti\" cellspacing=\"10\"><tr>";
+								$attribuutti_avattu = true;
+							}
+					
+							if($attribuuttilaskuri > 0 && $attribuuttilaskuri % $this->_attribuutteja_rivilla == 0)
+								print "</tr><tr>";
+							
+							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_attribuutteja_rivilla, 1) . "%\">";
+			
+							$this->esita_attribuutit($array, $array);
+	
+							$attribuuttilaskuri++;
+			
+							print "</td>";
+			
+							break;
 						}
-				
-						if($attribuuttilaskuri > 0 && 
-						$attribuuttilaskuri % $this->_attribuutteja_rivilla == 0) 
-							print "</tr><tr>";
-						
-						print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_attribuutteja_rivilla, 1) . "%\">";
-		
-						$this->esita_attribuutit($array, $array);
-
-						$attribuuttilaskuri++;
-		
-						print "</td>";
-		
-						break;
-					}
-					else
-					{
-						if(!$attribuutti_avattu) 
+						else
 						{
-							print "<table class=\"lista_attribuutti\">";
-							$attribuutti_avattu = true;
+							if(!$attribuutti_avattu)
+							{
+								print "<table class=\"lista_attribuutti\">";
+								$attribuutti_avattu = true;
+							}
+	
+							print "<tr>";
+			
+							$this->esita_attribuutit($array, $array, $listatyyppi);
+			
+							print "</tr>";
+			
+							break;
 						}
-
-						print "<tr>";
-		
-						$this->esita_attribuutit($array, $array, $listatyyppi);
-		
-						print "</tr>";
-		
-						break;
 					}
 				}
-			}
-			else
-			{	
-				if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $arvo != "scanning" && $arvo != "script")
-				{	
-					if($avain == $this->_nimi)
-					{	
-						if($attribuutti_avattu) 
+				else
+				{
+					if($avain != $this->_tyyppi && !is_array($avain) && !is_array($arvo) && $arvo != "scanning" && $arvo != "script")
+					{
+						if($avain == $this->_nimi)
 						{
-							$attribuutti_avattu = false;
-							$attribuutti_suljettu = true;
-							$this->sulje_attribuutti($listatyyppi, $attribuuttilaskuri);
-							$attribuuttilaskuri = 0;
+							if($attribuutti_avattu) 
+							{
+								$attribuutti_avattu = false;
+								$attribuutti_suljettu = true;
+								$this->sulje_attribuutti($listatyyppi, $attribuuttilaskuri);
+								$attribuuttilaskuri = 0;
+							}
+	
+							print "<div class=\"kentta\" id=\"" . $arvo . "\">";
+							print "<h2>" . $this->parsi_nimi($arvo) . "</h2>";
+	
+							$div_avattu = true;
 						}
-
-						print "<div class=\"kentta\" id=\"" . $arvo . "\">";
-						print "<h2>" . $this->parsi_nimi($arvo) . "</h2>";
-
-						$div_avattu = true;
+						else
+							print "<b>" . $avain . ":</b> " . $arvo . "<br />";
 					}
-					else
+					elseif($arvo == "scanning" || $arvo == "script") break;
+	
+					if($arvo[$this->_nimi] == "value")
+						$this->esita_sisatiedot($listatyyppi, false, $arvo[$this->_sisalto]);
+					
+					if(is_array($arvo) && $arvo[$this->_nimi] != "value")
 					{
-						print "<b>" . $avain . ":</b> " . $arvo . "<br />";
+						if($tarkenne != "") 
+							$atrb = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne, true, $attribuuttilaskuri);
+						else 
+							$atrb = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, "", false, $attribuuttilaskuri);
+								
+						if($atrb) $attribuuttilaskuri++;
 					}
 				}
-				elseif($arvo == "scanning" || $arvo == "script") break;
-
-				if($arvo[$this->_nimi] == "value")
-					$this->esita_sisatiedot($listatyyppi, false, $arvo[$this->_sisalto]);
-				
-				if(is_array($arvo) && $arvo[$this->_nimi] != "value")
-				{
-					if($tarkenne != "") 
-						$atrb = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne, true, $attribuuttilaskuri);
-					else 
-						$atrb = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, "", false, $attribuuttilaskuri);
-							
-					if($atrb) $attribuuttilaskuri++;
-				}
+				if($atrb) { $attribuutti_avattu = true; $attribuutti_suljettu = true; }
 			}
-			if($atrb) { $attribuutti_avattu = true; $attribuutti_suljettu = true; }
 		}
+	
+		if($atrb && $attribuutti_suljettu) 
+		{ 
+			$this->sulje_attribuutti($listatyyppi, $attribuuttilaskuri);
+			$attribuutti_avattu = false;
+		}
+	
+		if($div_avattu) print "</div>";
+	
+		if($attribuutti_avattu && !$attribuutti_suljettu) return true;
+		else return false;
 	}
 
-	if($atrb && $attribuutti_suljettu) 
-	{ 
-		$this->sulje_attribuutti($listatyyppi, $attribuuttilaskuri);
-		$attribuutti_avattu = false;
-	}
-
-	if($div_avattu) print "</div>";
-
-	if($attribuutti_avattu && !$attribuutti_suljettu) return true;
-	else return false;
-    }
-
-    private function esita_attribuutit(&$palautus_array, $array, $listatyyppi = false)
-    {
-	$description_str = "";
-	$code_str = "";
-	$name_str = "";
-	$values = array();
-
-	foreach($array as $avain => $arvo)
+	private function esita_attribuutit(&$palautus_array, $array, $listatyyppi = false)
 	{
-		if($avain === $this->_parametrit)
+		$description_str = "";
+		$code_str = "";
+		$name_str = "";
+		$values = array();
+	
+		foreach($array as $avain => $arvo)
 		{
-			if($arvo['code'] != "") $code_str = $arvo['code'];
-			if($arvo['name'] != "") $name_str = $arvo['name'];
-		}
+			if($avain === $this->_parametrit)
+			{
+				if($arvo['code'] != "") $code_str = $arvo['code'];
+				if($arvo['name'] != "") $name_str = $arvo['name'];
+			}
+	
+			$paluutaulu = $this->hae_sisatiedot($arvo, $avain);
 
-		$paluutaulu = $this->hae_sisatiedot($arvo, $avain);
-		if($paluutaulu['description'] != "") 
-			$description_str = $paluutaulu['description'];
-
-		if($paluutaulu['value'] != "") {
-			array_push($values, $paluutaulu['value']);
+			if($paluutaulu['description'] != "") 
+				$description_str = $paluutaulu['description'];
+	
+			if($paluutaulu['value'] != "")
+				array_push($values, $paluutaulu['value']);
 		}
-	}
-
-	if($code_str != "")
-		$this->esita_sisatiedot($listatyyppi, $code_str, $values);
-	else {
-		if($description_str != "")
-			$this->esita_sisatiedot($listatyyppi, $description_str, $values);
-		else {
-			if($name_str != "")
-				$this->esita_sisatiedot($listatyyppi, $name_str, $values);
+	
+		if($code_str != "")
+			$this->esita_sisatiedot($listatyyppi, $code_str, $values);
+		else
+		{
+			if($description_str != "")
+				$this->esita_sisatiedot($listatyyppi, $description_str, $values);
+			else
+			{
+				if($name_str != "")
+					$this->esita_sisatiedot($listatyyppi, $name_str, $values);
+			}
 		}
 	}
-    }
 
-    private function esita_sisatiedot($listatyyppi, $eka_kentta = false, $arvot)
-    {
-	if($listatyyppi)
-	{	
-		if(is_array($arvot))
+	private function esita_sisatiedot($listatyyppi, $eka_kentta = false, $arvot)
+	{
+		if($listatyyppi)
 		{
-			if($eka_kentta)
-				print "<td valign=\"top\" class=\"lista_description\"><b>" . $eka_kentta . "</b></td>";
-	
-			print "<td class=\"lista_value\">";
-
-			if(sizeof($arvot) > 0) 
+			if(is_array($arvot))
 			{
-				print "<table class=\"value\">";
+				if($eka_kentta)
+					print "<td valign=\"top\" class=\"lista_description\"><b>" . $eka_kentta . "</b></td>";
+		
+				print "<td class=\"lista_value\">";
 	
-				foreach($arvot as $avain => $arvo)
-					print "<tr><td>" . $arvo . "</td></tr>";
+				if(sizeof($arvot) > 0)
+				{
+					print "<table class=\"value\">";
+		
+					foreach($arvot as $avain => $arvo)
+						print "<tr><td>" . $arvo . "</td></tr>";
+		
+					print "</table>";
+				}
+				else print "&nbsp;";
+			}
+			else print "<table><tr><td>" . $arvot . "</td></tr></table>";
 	
-				print "</table>";
-			}
-			else print "&nbsp;";
+			if($eka_kentta) print "</td>";
 		}
-		else print "<table><tr><td>" . $arvot . "</td></tr></table>";
-
-		if($eka_kentta) print "</td>";
-	}
-	else
-	{	
-		if(is_array($arvot))
+		else
 		{
-			if($eka_kentta)
-				print "<h3>" . $eka_kentta . "</h3>";
+			if(is_array($arvot))
+			{
+				if($eka_kentta) print "<h3>" . $eka_kentta . "</h3>";
+		
+				foreach($arvot as $avain => $arvo)
+					print "<p>" . $arvo . "</p>";
+		
+			}
+			else print "<p>" . $arvot . "</p>";
 	
-			foreach($arvot as $avain => $arvo)
-				print "<p>" . $arvo . "</p>";
-	
+			if($eka_kentta) print "</td>";
 		}
-		else print "<p>" . $arvot . "</p>";
-
-		if($eka_kentta) print "</td>";
 	}
-    }
 
-    private function hae_sisatiedot($array, $avain)
-    {
-	$description = "";
-	$value = "";
-
-	if(is_array($array) && $avain !== $this->_parametrit)
+	private function hae_sisatiedot($array, $avain)
 	{
-		$edellinen_arvo = "";
-
-		foreach($array as $avain2 => $arvo2)
+		$description = "";
+		$value = "";
+	
+		if(is_array($array) && $avain !== $this->_parametrit)
 		{
-			if(!is_array($arvo2))
+			$edellinen_arvo = "";
+	
+			foreach($array as $avain2 => $arvo2)
 			{
-				if($edellinen_arvo == "description")
-					$description = $arvo2;
-				else
+				if(!is_array($arvo2))
 				{
-					if($avain2 == $this->_sisalto)
-						$value = $arvo2;
+					if($edellinen_arvo == "description")
+						$description = $arvo2;
+					elseif($edellinen_arvo == "value")
+					{
+						if($avain2 == $this->_sisalto)
+							$value = $arvo2;
+					}
+	
+					$edellinen_arvo = $arvo2;
 				}
-
-				$edellinen_arvo = $arvo2;
 			}
 		}
+	
+		$palautus = array("value" => $value, "description" => $description);
+	
+		return $palautus;
 	}
 
-	$palautus = array("value" => $value, "description" => $description);
-
-	return $palautus;
-    }
-
-    private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
-    {
-	if(!$listatyyppi)
+	private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
 	{
-		for(; $attribuuttilaskuri % $this->_attribuutteja_rivilla != 0; $attribuuttilaskuri++)
-			print "<td>&nbsp;</td>";
-
-		print "</tr></table>";
+		if(!$listatyyppi)
+		{
+			for(; $attribuuttilaskuri % $this->_attribuutteja_rivilla != 0; $attribuuttilaskuri++)
+				print "<td>&nbsp;</td>";
+	
+			print "</tr></table>";
+		}
+		else
+			print "</table>";
 	}
-	else
-	{		
-		print "</table>";
-	}
-    }
 
-    private function hae_array($array, $etsittava, &$pal_array)
-    {
-   	foreach($array as $avain => $arvo)
+	private function hae_array($array, $etsittava, &$pal_array)
 	{
-		if($avain === $this->_nimi && ($avain == $etsittava || $arvo == $etsittava))
+		foreach($array as $avain => $arvo)
 		{
-			$pal_array = $array;
-			break;
+			if($avain === $this->_nimi && ($avain == $etsittava || $arvo == $etsittava))
+			{
+				$pal_array = $array;
+				break;
+			}
+			else
+				if(is_array($arvo)) $this->hae_array($arvo, $etsittava, $pal_array);
 		}
-		else
-			if(is_array($arvo)) $this->hae_array($arvo, $etsittava, $pal_array);
 	}
-    }
 
-    private function parsi_nimi($nimi)
-    {
-	$palautus = "";
-	for($i=0; $i < strlen($nimi); $i++)
+	private function parsi_nimi($nimi)
 	{
-		if($nimi[$i] == "_") $palautus .= " ";
-		else $palautus .= $nimi[$i];
+		$palautus = "";
+
+		for($i=0; $i < strlen($nimi); $i++)
+		{
+			if($nimi[$i] == "_") $palautus .= " ";
+			else $palautus .= $nimi[$i];
+		}
+		
+		return ucfirst($palautus);
 	}
-	
-	return ucfirst($palautus);
-    }
 
-    public function hae_tieto($ryhma, $nimi)
-    {	
-	if(sizeof($this->_virheet) > 0) return 0;
+	private function hae_array2($array, $etsittava_nimi, $etsittava_arvo)
+	{
+		$haettava_paikallistettu = false;
 
-	return $this->hae_array2($this->_tietotaulu, $ryhma, $nimi);
-    }
+		foreach($array as $avain => $arvo)
+		{
+			if($haettava_paikallistettu)
+			{
+				$loytyi = 0;
+	
+				if(is_array($arvo))
+					foreach($arvo as $avain2 => $arvo2)
+					{
+						$edellinen = "";
+	
+						if(is_array($arvo2))
+						{
+							foreach($arvo2 as $avain3 => $arvo3)
+							{
+								if($edellinen == "value" && $avain3 == $this->_sisalto)
+									if($loytyi) return $arvo3;
+	
+								if($avain3 == $this->_sisalto && $arvo3 === $etsittava_arvo)
+									$loytyi = 1;
+	
+								$edellinen = $arvo3;
+							}
+						}
+					}
+			}
+	
+			if($avain === $this->_nimi && $arvo == $etsittava_nimi)
+			{
+				$haettava_paikallistettu = true;
+	
+				if(is_array($array[$this->_parametrit]))
+					foreach($array[$this->_parametrit] as $avain2 => $arvo2)
+						if(strtolower($avain2)  == strtolower($etsittava_arvo))
+							return $arvo2;
+			}
+			else
+			{
+				if(is_array($arvo))
+				{
+					$palautus = $this->hae_array2($arvo, $etsittava_nimi, $etsittava_arvo);
 
-    private function hae_array2($array, $etsittava_nimi, $etsittava_arvo)
-    {
-	$haettava_paikallistettu = false;
+					if($palautus != "") return $palautus;
+				}
+			}
+		}
+	}
 
-   	foreach($array as $avain => $arvo)
+	private function hae_paataulut()
 	{
-		if($haettava_paikallistettu)
-		{
-			$loytyi = 0;
-
+		$taulut = array();
+	
+		foreach($this->_tietotaulu as $avain => $arvo)
 			if(is_array($arvo))
 				foreach($arvo as $avain2 => $arvo2)
-				{
-					$edellinen = "";
-
 					if(is_array($arvo2))
 						foreach($arvo2 as $avain3 => $arvo3)
-						{
-							if($edellinen == "value" && $avain3 == $this->_sisalto)
-								if($loytyi) return $arvo3;
+							if($avain3 == $this->_nimi && !is_array($arvo3))
+								array_push($taulut, $arvo3);
+	
+		return $taulut;
+	}
 
-							if($avain3 == $this->_sisalto && $arvo3 === $etsittava_arvo)
-								$loytyi = 1;
-
-							$edellinen = $arvo3;
-						}
+	private function nayta_quick_jump_valikko()
+	{
+		$taulut = $this->hae_paataulut();
+			
+		print "<script type=\"text/javascript\">
+			<!--
+	
+			document.write(\"Quick jump:\")
+	
+			function loadPage(pageURL)
+			{
+				if(pageURL.selectedIndex > 0)
+				{
+					sivu = \"" . $_SERVER['SCRIPT_NAME'] . "?" . $_SERVER['QUERY_STRING'] . "#\";
+					location.href = sivu + pageURL.options[pageURL.selectedIndex].value;
 				}
-		}
-
-		if($avain === $this->_nimi && $arvo == $etsittava_nimi)
-		{
-			$haettava_paikallistettu = true;
-
-			if(is_array($array[$this->_parametrit]))
-				foreach($array[$this->_parametrit] as $avain2 => $arvo2)
-					if(strtolower($avain2)  == strtolower($etsittava_arvo)) return $arvo2;
-		}
-		else
-		{
-			if(is_array($arvo)) 
-			{
-				$palautus = $this->hae_array2($arvo, $etsittava_nimi, $etsittava_arvo);
-				if($palautus != "") return $palautus;
 			}
-		}
+	
+			//-->
+			</script>
+			<noscript>
+			This feature requires JavaScript.
+			</noscript>";
+	
+		print "<form name=\"qj_form\">
+			<select name=\"quick_jump\">";
+	
+		foreach($taulut as $avain => $arvo)
+			print "<option name=\"quick_jump_header\" onclick=\"loadPage(document.qj_form.quick_jump); \" value=\"" . $arvo . "\">" . $this->parsi_nimi($arvo) . "</option>";
+	
+		print "</select>
+			</form>";
 	}
-    }
-
-    private function hae_paataulut()
-    {
-	$taulut = array();
-
-	// k?y l?pi p??taulun kannasta l?htien
-	foreach($this->_tietotaulu as $avain => $arvo)
-		if(is_array($arvo))
-			foreach($arvo as $avain2 => $arvo2)
-				if(is_array($arvo2))
-					foreach($arvo2 as $avain3 => $arvo3)
-						if($avain3 == $this->_nimi && !is_array($arvo3))
-							array_push($taulut, $arvo3);
-
-	return $taulut;
-    }
-
-    private function nayta_quick_jump_valikko()
-    {
-	$taulut = $this->hae_paataulut();
-		
-	print "<script type=\"text/javascript\">
-		<!--
-
-		document.write(\"Quick jump:\")
-
-		function loadPage(pageURL)
-		{
-			if(pageURL.selectedIndex > 0)
-			{
-				sivu = \"" . $_SERVER['SCRIPT_NAME'] . "?" . $_SERVER['QUERY_STRING'] . "#\";
-				location.href = sivu + pageURL.options[pageURL.selectedIndex].value;
-			}
-		}
-
-		//-->
-		</script>
-		<noscript>	
-		This feature requires JavaScript.
-		</noscript>";
-
-	print "<form name=\"qj_form\">
-		<select name=\"quick_jump\">";
-
-	foreach($taulut as $avain => $arvo)
-		print "<option name=\"quick_jump_header\" onclick=\"loadPage(document.qj_form.quick_jump); \" value=\"" . $arvo . "\">" . $this->parsi_nimi($arvo) . "</option>";
-
-	print "</select>
-		</form>";
-    }
 }
 
 ?>

Modified: trunk/osinfo/html/xmltyyli.css
===================================================================
--- trunk/osinfo/html/xmltyyli.css	2007-03-09 12:31:26 UTC (rev 698)
+++ trunk/osinfo/html/xmltyyli.css	2007-03-12 07:55:07 UTC (rev 699)
@@ -1,4 +1,4 @@
-td.lista_description, td.lista_value, div.kentta
+td.lista_description, td.lista_value, div.kentta, div.kentta2
 {
 	background-color: #e9fbf7;
 }
@@ -8,14 +8,23 @@
 	background-color: #8db7ae;
 }
 
-div.kentta
+div.kentta, div.kentta2
 {
 	font-size: 13px;
 	border: 1px dashed black;
 	margin-top: 10px;
+}
+
+div.kentta
+{
 	padding: 0px 10px 10px 10px;
 }
 
+div.kentta2
+{
+	padding: 0px 10px 5px 10px;
+}
+
 table.attribuutti, table.lista_attribuutti
 {
 	width: 100%;
@@ -38,3 +47,4 @@
 	padding: 0px;
 	margin: 0px;
 }
+



From lamikae at mail.berlios.de  Mon Mar 12 12:55:05 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 12:55:05 +0100
Subject: [Osinfo-commit] r701 - trunk/osinfo/html
Message-ID: <200703121155.l2CBt5iq011969@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 12:54:55 +0100 (Mon, 12 Mar 2007)
New Revision: 701

Modified:
   trunk/osinfo/html/index.php
   trunk/osinfo/html/xml-parseri.php
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 07:57:29 UTC (rev 700)
+++ trunk/osinfo/html/index.php	2007-03-12 11:54:55 UTC (rev 701)
@@ -1,7 +1,16 @@
 <?php
 
-$index = new Index();
+// luodaan Index-olio. Input-parametrit:
 
+// $xmlkansio, kansio jossa kaikki xml-tiedostot sijaitsevat
+// $r, divien taustav?rin punaisen arvo
+// $g, divien taustav?rin vihre?n arvo
+// $b, divien taustav?rin sinisen arvo
+// $fade_korkeus, sivuframen alla olevan fade-kuvan korkeus
+// $clienteja_rivilla, index viewin clienttien lukum??r? rivill?
+
+$index = new Index("hosts", 222, 197, 148, 150, 3);
+
 $index->tulosta_alkukoodi(true);
 $index->nayta_sivuframe();
 $index->nayta_paaframe($_GET['target']);
@@ -9,15 +18,28 @@
 
 class Index
 {
-	private $_DivResoluutiot = array("SivuFrame" => array('10px', '10px', '20%', '500'),
-					"P??Frame" => array('10px', '10px', '70%', '500'));
-	private $_xmlkansio = "hosts";
+	private $_xmlkansio;
 	private $_xmlparseri = "xml-parseri.php";
 	private $_parseri;
-	private $_clientteja_rivilla = 3;
+	private $_clientteja_rivilla;
+	private $_r;
+	private $_g;
+	private $_b;
+	private $_fade_korkeus;
 
-	public function __construct()
-    	{
+	public function __construct($xmlkansio, $r, $g, $b, $fade_korkeus, $clientteja_rivilla)
+	{
+		// sijoitetaan input-parametrit luokan j?senmuuttujiin
+
+		$this->_xmlkansio = $xmlkansio;
+		$this->_r = $r;
+		$this->_g = $g;
+		$this->_b = $b;
+		$this->_fade_korkeus = $fade_korkeus;
+		$this->_clientteja_rivilla = $clientteja_rivilla;
+
+		// tarkistetaan, xmlparseri on olemassa ja luodaan siit? olio
+
 		if(file_exists($this->_xmlparseri))
 		{
 			include($this->_xmlparseri);
@@ -29,6 +51,8 @@
 
 	public function tulosta_alkukoodi($tyylit = true)
 	{
+		// tekee sivulle alkukoodit
+	
 		print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
 
 		print "<html>\n";	
@@ -43,100 +67,42 @@
 
 	public function tulosta_loppukoodi()
 	{
+		// tekee sivulle loppukoodit
+
 		print "</body>\n";
 		print "</html>";
 	}
 	
 	private function tulosta_tyyli()
 	{
-		$varit = array(222, 197, 148);
-		$varisyote = "r=" . $varit[0] . "&g=" . $varit[1] . "&b=" . $varit[2];
+		// m??ritet??n ylim??r?iset tyyliasetukset divien v?rille
 
+		$varisyote = "r=" . $this->_r . "&g=" . $this->_g . "&b=" . $this->_b;
+
 		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
 		print "<style type=\"text/css\">
 
-		body
-		{
-			background-color: #eddcbc;
-		}
 		
-		div.SivuFrame, div.PaaFrame
-		{ 
-			float: left;
-		}
-		
 		div.SivuFrameSisalto, div.PaaFrame
 		{
-			background-color: rgb(" . $varit[0] . ", " . $varit[1] . ", " . $varit[2] . ");
+			background-color: rgb(" . $this->_r . ", " . $this->_g . ", " . $this->_b . ");
 		}
 
-		div.SivuFrame
-		{
-			margin-left: " . $this->_DivResoluutiot[SivuFrame][0] . ";
-			margin-top: " . $this->_DivResoluutiot[SivuFrame][1] . ";
-			margin-bottom: " . $this->_DivResoluutiot[SivuFrame][1] . ";
-			width: " . $this->_DivResoluutiot[SivuFrame][2] . ";
-			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
-			min-width: 200;
-			height: auto;
-		}
-
-		div.SivuFrameSisalto
-		{
-			padding: 10px;
-		}
-
 		div.SivuFrameFade
 		{
-			background-image: url('fade.php?w=1&h=150&" . $varisyote . "');
+			background-image: url('fade.php?w=1&h=". $this->_fade_korkeus . "&" . $varisyote . "');
 			background-repeat: repeat-x;
 			background-position: top;
-			height: 150px;
+			height: ". $this->_fade_korkeus . "px;
 		}
 
-		div.PaaFrame
-		{
-			border: 1px solid black;
-			padding: 5px;
-			padding: 0px 10px 10px 10px;
-			margin-left: " . $this->_DivResoluutiot[P??Frame][0] . ";
-			margin-top: " . $this->_DivResoluutiot[P??Frame][1] . ";
-			margin-bottom: " . $this->_DivResoluutiot[P??Frame][1] . ";
-			width: " . $this->_DivResoluutiot[P??Frame][2] . ";
-			min-height: " . $this->_DivResoluutiot[P??Frame][3] . ";
-			min-width: 600;
-			height: auto;
-			clear: none;
-		}
-
-		p.valitus
-		{
-			color: red;
-		}
-
-		ul.hostit
-		{
-			padding: 0px;
-			padding-left: 10px;
-		}
-
-		li.kuvaus
-		{
-			font-size: 12px;
-		}
-
-		a:link
-		{
-			color: rgb(0,0,255);
-		}
-
-		a:visited
-		{
-			color: rgb(0,0,200);
-		}
-
 		</style>";
 	}
+
+	// Listaa xml-tiedostokansion sis?ll?n sivu- ja p??framelle.
+	// Ottaa input-parametrina tiedon, onko kyse valikosta vai index viewist?
+	// $valikko = true --> valikko
+	// $valikko = false --> index view
 	
 	private function listaa_tiedostot($valikko = false)
 	{
@@ -144,21 +110,30 @@
 		{
 			$kansio = opendir($this->_xmlkansio);
 
-			$ul_avattu = false;
+			$xml_array = array();
 
-			$xml_array = array();
-		
 			for($i=0; $tiedosto = readdir($kansio); $i++)
 			{
+				// selvitt?? tiedostop??tteen
+
 				$p_array = explode(".", $tiedosto);
 				$paate = $p_array[sizeof($p_array)-1];
-		
+
 				if($i > 1 && ($paate == "xml"))
 				{
+					// parsii k?sitelt?v?n xml-tiedoston
+
 					$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $tiedosto);
 
+					// hakee parserista halutut tiedot taulukkoon
+
+					// hakualgoritmi etsii tiedon sen yl?otsikon kautta, joten funktiolle
+					// pit?? antaa kaksi parametria, sen l?hin yl?otsikko ja haettava tieto
+
 					if($valikko)
 					{
+						// n?m? arvot haetaan valikkoon
+
 						$temp_array = array("tiedosto" => $tiedosto,
 						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
 						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
@@ -168,6 +143,8 @@
 					}
 					else
 					{
+						// n?m? arvot haetaan index viewiin
+
 						$temp_array = array("tiedosto" => $tiedosto,
 						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
 						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
@@ -182,13 +159,18 @@
 						);
 					}
 
+					// lis?? tiedoston tiedot p??taulukkoon ja jatkaa tiedostojen l?pik?ymist?
 					array_push($xml_array, $temp_array);
 				}
 			}
 
+			// lajittelee koneet domaineittain
+
 			$domainit = $this->lajittele_array($xml_array, "domain");
 			$profilet = array();
 
+			// lajittelee koneet (alustavasti) profiileittain
+
 			foreach($domainit as $domain => $arvo)
 			{
 				$temp_array = array($domain => $this->lajittele_array($arvo, "profile"));
@@ -196,19 +178,27 @@
 			}
 
 			ksort($profilet);
-			
+
 			if($valikko)
 			{
 				foreach($profilet as $domain => $profiles)
 				{
+					// lajittelee koneet profiileittain
 					ksort($profiles);
+
+					// n?ytt?? tiedot valikossa domaineittain
+
 					print "<ul class=\"hostit\"><li>Domain: <i>" . $domain . "</i>";
-	
+
 					foreach($profiles as $profile => $hostnames)
 					{
+						// n?ytt?? tiedot valikossa profiileittain
+
 						print "<ul class=\"hostit\"><li>Profile: <i>" . $profile . 
 							"</i><ul class=\"hostit\">";
-	
+
+						// n?ytt?? halutut yksityiskohtaiset konetiedot valikossa
+
 						foreach($hostnames as $hostname => $arvot)
 						{
 							print "<li><b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
@@ -216,12 +206,14 @@
 								<li class=\"kuvaus\">" . $arvot["os"] . "</li>
 								<li class=\"kuvaus\">" . $arvot["cpu"] . "</li>
 								</ul></li>";
-	
+
 						}
-	
+
+						// sulkee profiilien tagit
 						print "</ul></li></ul>";
 					}
-	
+
+					// sulkee domainien tagit
 					print "</li></ul>";
 				}
 			}
@@ -229,16 +221,23 @@
 			{
 				foreach($profilet as $domain => $profiles)
 				{
+					// lajittelee koneet profiileittain
 					ksort($profiles);
+
+					// n?ytt?? tiedot valikossa domaineittain
 					print "<div class=\"kentta2\"><h3>Domain: <i>" . $domain . "</i>";
-	
+
 					foreach($profiles as $profile => $hostnames)
 					{
+						// n?ytt?? tiedot valikossa profiileittain
+
 						print "<div class=\"kentta2\"><h3>Profile: <i>" . $profile . 
 							"</i><table class=\"attribuutti\" cellspacing=\"10\">";
 
 						$laskuri = 0;
-	
+
+						// n?ytt?? kaikki yksityiskohtaiset konetiedot valikossa
+
 						foreach($hostnames as $hostname => $arvot)
 						{
 							if($laskuri == 0) 
@@ -280,6 +279,8 @@
 		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
 	}
 
+	// lajittelee taulukon halutun arvon mukaan, joka annetaan input-parametriin $nimi
+
 	private function lajittele_array($array, $nimi)
 	{
 		$nimet = array(" ");
@@ -308,15 +309,17 @@
 		return $nimet_lajiteltuna;
 	}
 
-	private function array_lisaa_samaan(&$array) 
+	// yleinen taulukon k?sittelyfunktio, joka php:st? itsest??n puuttuu
+
+	private function array_lisaa_samaan(&$array)
 	{
 		$argumentit = func_get_args();
 	
-		foreach($argumentit as $argumentti) 
+		foreach($argumentit as $argumentti)
 		{
-			if(is_array($argumentti)) 
+			if(is_array($argumentti))
 			{
-				foreach($argumentti as $avain => $arvo) 
+				foreach($argumentti as $avain => $arvo)
 				{
 					$array[$avain] = $arvo;
 					$paluuarvo++;
@@ -328,6 +331,8 @@
 		return $paluuarvo;
 	}
 
+	// k?y l?pi tiedostokansion ja palauttaa viimeksi muokatun tiedoston p?iv?m??r?n unixin aika-arvona
+
 	private function hae_viimeksi_paivitetty()
 	{
 		if(file_exists($this->_xmlkansio))
@@ -353,6 +358,8 @@
 			return $suurin;
 		}
 	}
+
+	// n?ytt?? sivuframen sis?ll?n
 	
 	public function nayta_sivuframe()
 	{
@@ -363,15 +370,22 @@
 			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
 			<hr />";
 
+		// listaa xml-tiedostokansion sis?ll?n sivuframelle
 		$this->listaa_tiedostot(true);
 	
 		print "<hr />";
 
+		$this->paivitys();
+
+		print "<hr />";
+
 		print "<p>Last update:</p>";
 
+		// hakee viimeksi p?ivitetyn tiedoston aika-arvon
 		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
 
 		if($viimeksi_paivitetty > 0)
+			// n?ytt?? viimeksi p?ivitetyn tiedoston p?iv?yksen ja ajan
 			print "<p><i>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</i></p>";
 	
 		print "</div>";
@@ -381,21 +395,29 @@
 		print "</div>";
 	}
 	
+	// n?ytt?? p??framen sis?ll?n
+
 	public function nayta_paaframe($sivu = "")
 	{
 		print "<div class=\"PaaFrame\">";
 		
+		// jos osoiterivin target-arvo on m??ritelty, kokeilee n?ytt?? sivun sis?ll?n p??frameen
+
 		if($sivu != "")
 		{
+			// tarkistaa ensin, ett? tiedosto on olemassa
 			if(file_exists($this->_xmlkansio . "/" . $sivu))
 			{
+				// parsii xml-tiedoston l?pi
 				$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $sivu);
-				
+
+				// n?ytt?? xml:st? "osinfo" tagien sis?ll? olevan tiedon
 				$this->_parseri->hae_arvot("osinfo");
 			}
 			else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
 		}
 		else
+			// jos osoiterivin target-arvoa ei ole m??ritelty, n?ytt?? index viewin
 			$this->nayta_index_view();
 
 		print "</div>";
@@ -405,8 +427,22 @@
 	{
 		print "<h3>index view</h3>";
 
+		// listaa xml-kansion tiedostot p??framelle
 		$this->listaa_tiedostot(false);
 	}
+
+	private function paivitys()
+	{
+		if($_POST['paivitettava_client'])
+			print "<p>-- update " . $_POST['paivitettava_client'] . " --</p>";
+
+		print "<form name=\"paivitysformi\" action=\"" . $PHP_SELF . "\" method=\"post\">
+			<p>Client: 
+				<input type=\"text\" name=\"paivitettava_client\" /><br /><br />
+				<input type=\"submit\" value=\"Update\" />
+			</p>
+			</form>";
+	}
 }
 
 ?> 
\ No newline at end of file

Modified: trunk/osinfo/html/xml-parseri.php
===================================================================
--- trunk/osinfo/html/xml-parseri.php	2007-03-12 07:57:29 UTC (rev 700)
+++ trunk/osinfo/html/xml-parseri.php	2007-03-12 11:54:55 UTC (rev 701)
@@ -2,18 +2,18 @@
 
 class xmlparseri
 {
-	private $_parsittava_tiedosto;
-	private $_tiedoston_sisalto;
-	private $_tietotaulu = array();
-	private $_attribuutteja_rivilla = 3;
+	private $_parsittava_tiedosto; // parsittavan tiedoston tiedostonimi
+	private $_tiedoston_sisalto; // parsitun tiedoston sis?lt?
+	private $_tietotaulu = array(); // taulukko, jossa on kaikki xml-tiedostosta otetut tiedot
+	private $_attribuutteja_rivilla = 3; // "laatikko"-n?kym?ss? olevien attribuuttien m??r? rivill?
 
-	// "koodit"
+	// tagien "koodit" tietotaulussa
 	private $_nimi = "--nimi--";
 	private $_parametrit = "--parametrit--";
 	private $_tyyppi = "--tyyppi--";
 	private $_sisalto = "--sisalto--";
 
-	private $_virheet = array();
+	private $_virheet = array(); // taulukko, jossa on parserin havaitsemat virheet
 
 	public function __construct()
 	{
@@ -26,26 +26,34 @@
 
 		if(file_exists($tiedoston_nimi))
 		{
+			// sijoittaa parsittavan tiedoston nimi luokan j?senmuuttujaan
 			$this->_parsittava_tiedosto = $tiedoston_nimi;
+
+			// lukee tiedoston sis?ll?n luokan _tiedoston_sisalto -j?senmuuttujaan
 			$this->lue_tiedoston_sisalto();
-		
+
+			// aloittaa tietotaulun muodostamisen aloittamalla ensimm?isest? merkist?
 			$this->_tietotaulu = $this->etsi_tagi("", 0);
 		}
 		else
+			// jos parsittavaa tiedostoa ei ole, annetaan siit? k?ytt?j?lle ilmoitus
 			print "<p class=\"valitus\">File " . $tiedoston_nimi . " not found</p>";
 	}
 
+	// public-funktio, jolla n?ytet??n tiedot halutusta kohdasta
 	public function hae_arvot($kanta, $attribuutit = "")
 	{
 		$this->hae_array($this->_tietotaulu, $kanta, $esitettava_array);
 		$this->esita_tiedot($esitettava_array, $attribuutit);
 	}
 
+	// funktio, jolla voidaan hakea yksitt?inen tieto ulos
 	public function hae_tieto($ryhma, $nimi)
 	{
 		return $this->hae_array2($this->_tietotaulu, $ryhma, $nimi);
 	}
 
+	// testausk?ytt??n tarkoitettu funktio, joka n?ytt?? koko tietotaulun rakenteen
 	public function nayta_tietotaulu()
 	{
 		print "<p>--------- KOKO TIETOTAULU:---------</p>";
@@ -54,6 +62,7 @@
 		print "</pre>";
 	}
 
+	// lukee tiedston sis?ll?n merkki merkilt? l?pi
 	private function lue_tiedoston_sisalto()
 	{
 		$fp = fopen($this->_parsittava_tiedosto, "r");
@@ -64,17 +73,25 @@
 			$this->_tiedoston_sisalto .= $char;
 	}
 
+	// funktio, joka k?y l?pi tiedostosta haettua sis?lt?? rekursiivisesti.
+	// $taso-muuttuja oli vain testik?ytt?? varten, mutta on j?tetty paikoilleen jos tarvitsee
+	// tehd? muutoksia.
 	private function etsi_tagi($etsittava, $indeksi, $taso = -1)
 	{
 		$taulu = array();
 		$taso++;
 
+		// k?y sis?lt?? l?pi indeksist? alkavasta kohdasta
 		for($i=$indeksi; $i < strlen($this->_tiedoston_sisalto); $i++)
 		{
+			// tarkistaa, onko aloittavaa tagia olemassa
 			if($this->_tiedoston_sisalto[$i] == "<")
 			{
 				$tagi = "";
-		
+
+				// jos on tagin aloituskohta on l?ytynyt, luetaan niin kauan kunnes
+				// lopettava tagi l?ytyy, tai xml:n syntaksissa on virheit?
+				// ( tai tiedoston sis?lt? on loppunut )
 				for($j=$i+1; $j < strlen($this->_tiedoston_sisalto); $j++)
 				{
 					if($this->_tiedoston_sisalto[$j] == "<") break;
@@ -82,45 +99,64 @@
 						$tagi .= $this->_tiedoston_sisalto[$j];
 					else break;
 				}
-			
+
+				// vied??n tagimerkkien sis?lt? tarkistusfunktiolle, joka tunnistaa sen tyypin
 				$tietue = $this->tarkista_tagi($tagi);
-		
+
+				// tekee haarautumisen tagin tyypist? riippuen
 				switch($tietue[$this->_tyyppi])
 				{
 				case 1:
+					// tagin tyyppi on xml:n metatietoa, mik? lis?t??n tietotauluun suoraan
 					array_push($taulu, $tietue);
 					break;
 				case 2:
+					// tagin tyyppi on aloittava tagi, jolloin kutsutaan funktiota rekursiivisesti
+					// ja otetaan paluuarvot talteen
 					$paluuarvot = $this->etsi_tagi($tietue[$this->_nimi], $j+1, $taso);
 					
 					if($paluuarvot['indeksi'] > $i)
 						$i = $paluuarvot['indeksi'];
 
+					// lis?? haettuun taulukkoon alataulukon tiedot
 					$this->array_lisaa_samaan($tietue, $paluuarvot['taulu']);
 					$sisalto = "";
-			
+
+					// hakee tagien v?lisen tiedon, esim. "value" ja "description" -arvot
 					for($j += 1; $j < strlen($this->_tiedoston_sisalto); $j++)
 					{
 						$char = ord($this->_tiedoston_sisalto[$j]);
 		
-						if($char != 10 && $char != 13 && $char != 9 && 				$this->_tiedoston_sisalto[$j] != "<")
+						if($char != 10 && $char != 13 && $char != 9 && $this->_tiedoston_sisalto[$j] != "<")
 							$sisalto .= $this->_tiedoston_sisalto[$j];
 						elseif($this->_tiedoston_sisalto[$j] == "<") break;
 					}
-		
+
+					// jos tagien v?lill? on tietoa, lis?t??n se tietotaulukkoon
 					if(!empty($sisalto))
 					{
 						$temp_array = array($this->_sisalto => $sisalto);
 						$this->array_lisaa_samaan($tietue, $temp_array);
 					}
-		
+
+					// lis?? tietotauluun haetun taulukon sis?lt?
 					array_push($taulu, $tietue);
 					break;
 				case 3:
+					// tagin tyyppi on lopettava tagi
 					if($etsittava != "")
 					{
+						// jos lopetustagin arvo on sama kuin aloittava tagi,
+						// palautetaan funktiosta taulukko ja indeksi
 						if($tietue[$this->_nimi] == $etsittava)
 							return array("taulu" => $taulu, "indeksi" => $i);
+
+						// jos lopetustagin arvo ei ole sama kuin aloittava tagi,
+						// xml-tiedostossa on virhe ja virhesanoma lis?t??n my?hemp??
+						// k?sittely? varten
+
+						// parseri kuitenkin toipuu virheest?, ja lis?? oletettavan
+						// lopetuksen itsest??n
 						else
 						{
 							array_push($this->_virheet, "found &lt;/" . $tietue[$this->_nimi] . "&gt;, " . "&lt;/" . $etsittava . "&gt; expected");
@@ -133,6 +169,8 @@
 		
 					break;
 				case 4:
+					// tagin tyyppi on jotakin muuta kuin k?sitelt?v?t tyypit, jolloin
+					// sen arvot lis?t??n suoraan tietotauluun
 					array_push($taulu, $tietue);
 					break;
 				default:
@@ -154,17 +192,20 @@
 		//	   2 = aloitustagi
 		//	   3 = lopetustagi
 		//	   4 = yksin?inen tagi
-	
+
+		// tarkistaa, onko tagin tyyppi yksin?inen tagi
 		for($i=strlen($tagi)-1; $i>0; $i--)
 		{
 			if($tagi[$i] == "/" && $i > 0)
 				$parametritagi = true;
 		}
-	
+
+		// tarkistaa, onko tagin tyyppi tiedoston tyyppitagi, ns. metatieto
 		if($tagi[0] == "!" || $tagi[0] == "?")
 			$tyyppi = 1;
 		else
 		{
+			// tarkistaa, onko tagin tyyppi lopettava tagi
 			if($tagi[0] == "/")
 			{
 				$tyyppi = 3;
@@ -174,8 +215,11 @@
 			}
 			else
 			{
+				// tarkistaa, onko tagin tyyppi aloittava tagi
 				if($parametritagi) $tyyppi = 4;
 				else $tyyppi = 2;
+
+				// parsii merkki kerrallaan tagin sis?ll?n ja ottaa mahdolliset attribuutit talteen
 		
 				for($i=0; $i < strlen($tagi); $i++)
 				{
@@ -231,6 +275,8 @@
 				}
 			}
 		}
+
+		// palauttaa taulukkona tagin nimen ja mahdolliset attribuutit
 		
 		if(empty($parametrit))
 			return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi);
@@ -238,6 +284,8 @@
 			return array($this->_tyyppi => $tyyppi, $this->_nimi => $nimi, $this->_parametrit => $parametrit);
 	}
 
+	// yleinen taulukon k?sittelyfunktio, joka php:st? itsest??n puuttuu
+
 	private function array_lisaa_samaan(&$array)
 	{
 		$argumentit = func_get_args();
@@ -258,20 +306,27 @@
 		return $paluuarvo;
 	}
 
+	// n?ytt?? parserin antamat tiedot sivulle
+
 	private function esita_tiedot($array, $tarkenne = "")
 	{
+		// hakee koneen nimen ja n?ytt?? sen otsikossa
+
 		print "<table style=\"width: 100%\">
 			<tr>
 			<td><h2>" . $this->parsi_nimi($this->hae_tieto("computer", "hostname")) . "</h2></td>
 			<td>";
-	
+
+		// n?ytt?? quick jump -valikon
 		$this->nayta_quick_jump_valikko();
-	
+
+		// n?ytt?? skriptin versiotiedon ja skannausp?iv?n
 		print "</td><td style=\"text-align: right\"><p>Script version: <i>" . $this->hae_tieto("script", "version") . "</i><br />" .
 			"Scanning date: <i>" . $this->hae_tieto("scanning", "date") . "</i></p></td>";
 	
 		print "</td></tr></table>";
-	
+
+		// jos xml-tiedostoa parsiessa on havaittu virheit?, ne n?ytet??n k?ytt?j?lle
 		if(sizeof($this->_virheet) > 0)
 		{
 			print "<p class=\"valitus\">";
@@ -282,12 +337,10 @@
 			print "</p>";
 		}
 	
-		$this->_attribuutti_avattu = false;
-		$this->_attribuutti_laskuri = 0;
-	
 		if(is_array($array))
 		{
-			$listatyyppi = false;
+			// jos attribuutit halutaan n?ytt?? "laatikoissa", $listatyyppi = false;
+			$listatyyppi = true;
 	
 			// k?y l?pi p??taulun kannasta l?htien
 			foreach($array as $avain => $arvo)
@@ -301,22 +354,22 @@
 		}
 	}
 
+	// funktio, joka esitt?? alitiedot annetusta taulukosta
 	private function esita_alitiedot($array, $listatyyppi = false, $attribuutti_avattu = false, $tarkenne = "", $paasy_alitauluihin = false, $attribuuttilaskuri = 0)
 	{
 		$div_avattu = false;
 		$attribuutti_suljettu = false;
 		$atrb = false;
-		$listatyyppi = true;
-	
+
 		foreach($array as $avain => $arvo)
-		{	
+		{
 			if($tarkenne != "" && $avain != $this->_tyyppi && $arvo == $tarkenne)
 				$paasy_alitauluihin = true;
 			elseif($tarkenne != "" && is_array($arvo)) 
 				$div = $this->esita_alitiedot($arvo, $listatyyppi, $attribuutti_avattu, $tarkenne);
-	
+
 			if($paasy_alitauluihin || $tarkenne == "")
-			{	
+			{
 				if($arvo == "attribute")
 				{
 					if(is_array($array))
@@ -328,16 +381,16 @@
 								print "<table class=\"attribuutti\" cellspacing=\"10\"><tr>";
 								$attribuutti_avattu = true;
 							}
-					
+
 							if($attribuuttilaskuri > 0 && $attribuuttilaskuri % $this->_attribuutteja_rivilla == 0)
 								print "</tr><tr>";
-							
+
 							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_attribuutteja_rivilla, 1) . "%\">";
-			
+
 							$this->esita_attribuutit($array, $array);
-	
+
 							$attribuuttilaskuri++;
-			
+
 							print "</td>";
 			
 							break;
@@ -349,13 +402,13 @@
 								print "<table class=\"lista_attribuutti\">";
 								$attribuutti_avattu = true;
 							}
-	
+
 							print "<tr>";
-			
+
 							$this->esita_attribuutit($array, $array, $listatyyppi);
-			
+
 							print "</tr>";
-			
+
 							break;
 						}
 					}
@@ -413,6 +466,7 @@
 		else return false;
 	}
 
+	// n?ytt?? attribuutin sis?lt?m?n datan
 	private function esita_attribuutit(&$palautus_array, $array, $listatyyppi = false)
 	{
 		$description_str = "";
@@ -450,7 +504,8 @@
 			}
 		}
 	}
-
+	
+	// esitt?? attribute-tagin sis?tiedot
 	private function esita_sisatiedot($listatyyppi, $eka_kentta = false, $arvot)
 	{
 		if($listatyyppi)
@@ -493,6 +548,7 @@
 		}
 	}
 
+	// hakee attribute-tagin sis?tiedot ja antaa ne paluuarvoina takaisin
 	private function hae_sisatiedot($array, $avain)
 	{
 		$description = "";
@@ -524,6 +580,8 @@
 		return $palautus;
 	}
 
+	// sulkee avatun attribuutin, kun sellainen havaitaan loppuvan.
+	// funktio generoi tyhj?t <td>-tagit, jotta taulukko pysyy oikean XHTML-syntaksin mukaisena
 	private function sulje_attribuutti($listatyyppi = false, $attribuuttilaskuri = 0)
 	{
 		if(!$listatyyppi)
@@ -551,6 +609,8 @@
 		}
 	}
 
+	// parsii n?ytett?v?n nimen parempaan muotoon. t?ss? muuttaa _ -merkin v?lily?nniksi ja muuttaa
+	// ensimm?isen kirjaimen isoksi
 	private function parsi_nimi($nimi)
 	{
 		$palautus = "";
@@ -564,6 +624,8 @@
 		return ucfirst($palautus);
 	}
 
+	// hakee halutun tiedon kohdasta, jossa $etsittava_nimi on haettavan tiedon l?hin yl?otsikko ja
+	// $etsittava_arvo haettavan tiedon nimi
 	private function hae_array2($array, $etsittava_nimi, $etsittava_arvo)
 	{
 		$haettava_paikallistettu = false;
@@ -616,6 +678,7 @@
 		}
 	}
 
+	// hakee tietotaulusta kaikki p??otsikot ja palauttaa ne taulukkona
 	private function hae_paataulut()
 	{
 		$taulut = array();
@@ -631,9 +694,14 @@
 		return $taulut;
 	}
 
+	// n?ytt?? pikahyppyvalikon, josta p??st??n nopesti siirtym??n haluttuun p??otsikkoon
 	private function nayta_quick_jump_valikko()
 	{
+
+		// hakee p??taulut
 		$taulut = $this->hae_paataulut();
+
+		// generoi sivulle javascriptin, jolla hyppy totetutetaan
 			
 		print "<script type=\"text/javascript\">
 			<!--



From lamikae at mail.berlios.de  Mon Mar 12 12:56:38 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 12:56:38 +0100
Subject: [Osinfo-commit] r702 - trunk/osinfo/html
Message-ID: <200703121156.l2CBucYn013845@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 12:56:36 +0100 (Mon, 12 Mar 2007)
New Revision: 702

Added:
   trunk/osinfo/html/tyylit.css
Log:
p?\195?\164ivitys

Added: trunk/osinfo/html/tyylit.css
===================================================================
--- trunk/osinfo/html/tyylit.css	2007-03-12 11:54:55 UTC (rev 701)
+++ trunk/osinfo/html/tyylit.css	2007-03-12 11:56:36 UTC (rev 702)
@@ -0,0 +1,117 @@
+body
+{
+	background-color: #eddcbc;
+}
+
+div.SivuFrame, div.PaaFrame
+{
+	float: left;
+}
+
+div.SivuFrameSisalto
+{
+	padding: 10px;
+}
+
+div.SivuFrame
+{
+	margin-left: 10px;
+	margin-top: 10px;
+	margin-bottom: 10px;
+	width: 20%;
+	min-height: 500;
+	min-width: 200;
+	height: auto;
+}
+
+div.PaaFrame
+{
+	border: 1px solid black;
+	padding: 5px;
+	padding: 0px 10px 10px 10px;
+	margin-left: 10px;
+	margin-top: 10px;
+	margin-bottom: 10px;
+	width: 70%;
+	min-height: 500;
+	min-width: 600;
+	height: auto;
+	clear: none;
+}
+
+p.valitus
+{
+	color: red;
+}
+
+ul.hostit
+{
+	padding: 0px;
+	padding-left: 10px;
+}
+
+li.kuvaus
+{
+	font-size: 12px;
+}
+
+a:link
+{
+	color: rgb(0,0,255);
+}
+
+a:visited
+{
+	color: rgb(0,0,200);
+}
+
+td.lista_description, td.lista_value, div.kentta, div.kentta2
+{
+	background-color: #e9fbf7;
+}
+
+td.attribuutti_td, table.lista_attribuutti
+{
+	background-color: #8db7ae;
+}
+
+div.kentta, div.kentta2
+{
+	font-size: 13px;
+	border: 1px dashed black;
+	margin-top: 10px;
+}
+
+div.kentta
+{
+	padding: 0px 10px 10px 10px;
+}
+
+div.kentta2
+{
+	padding: 0px 10px 5px 10px;
+}
+
+table.attribuutti, table.lista_attribuutti
+{
+	width: 100%;
+}
+
+td.attribuutti_td
+{
+	margin: 5px 5px 5px 5px;
+	border: 1px dotted black;
+	padding: 7px;
+}
+
+td.lista_description
+{
+	width: 30%;
+}
+
+table.value
+{
+	padding: 0px;
+	margin: 0px;
+}
+



From lamikae at mail.berlios.de  Mon Mar 12 12:58:46 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 12:58:46 +0100
Subject: [Osinfo-commit] r703 - trunk/osinfo/html
Message-ID: <200703121158.l2CBwkJ4017155@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 12:58:42 +0100 (Mon, 12 Mar 2007)
New Revision: 703

Added:
   trunk/osinfo/html/index.php
Removed:
   trunk/osinfo/html/index.php
Log:
p?\195?\164ivitys

Deleted: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 11:56:36 UTC (rev 702)
+++ trunk/osinfo/html/index.php	2007-03-12 11:58:42 UTC (rev 703)
@@ -1,448 +0,0 @@
-<?php
-
-// luodaan Index-olio. Input-parametrit:
-
-// $xmlkansio, kansio jossa kaikki xml-tiedostot sijaitsevat
-// $r, divien taustav?rin punaisen arvo
-// $g, divien taustav?rin vihre?n arvo
-// $b, divien taustav?rin sinisen arvo
-// $fade_korkeus, sivuframen alla olevan fade-kuvan korkeus
-// $clienteja_rivilla, index viewin clienttien lukum??r? rivill?
-
-$index = new Index("hosts", 222, 197, 148, 150, 3);
-
-$index->tulosta_alkukoodi(true);
-$index->nayta_sivuframe();
-$index->nayta_paaframe($_GET['target']);
-$index->tulosta_loppukoodi();
-
-class Index
-{
-	private $_xmlkansio;
-	private $_xmlparseri = "xml-parseri.php";
-	private $_parseri;
-	private $_clientteja_rivilla;
-	private $_r;
-	private $_g;
-	private $_b;
-	private $_fade_korkeus;
-
-	public function __construct($xmlkansio, $r, $g, $b, $fade_korkeus, $clientteja_rivilla)
-	{
-		// sijoitetaan input-parametrit luokan j?senmuuttujiin
-
-		$this->_xmlkansio = $xmlkansio;
-		$this->_r = $r;
-		$this->_g = $g;
-		$this->_b = $b;
-		$this->_fade_korkeus = $fade_korkeus;
-		$this->_clientteja_rivilla = $clientteja_rivilla;
-
-		// tarkistetaan, xmlparseri on olemassa ja luodaan siit? olio
-
-		if(file_exists($this->_xmlparseri))
-		{
-			include($this->_xmlparseri);
-
-			$this->_parseri = new xmlparseri();
-		}
-		else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
-	}
-
-	public function tulosta_alkukoodi($tyylit = true)
-	{
-		// tekee sivulle alkukoodit
-	
-		print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
-
-		print "<html>\n";	
-		print "<head>\n";	
-		print "<title>OS info</title>\n\n";
-
-		if($tyylit) $this->tulosta_tyyli();
-
-		print "\n\n</head>\n\n";
-		print "<body>\n\n";
-	}
-
-	public function tulosta_loppukoodi()
-	{
-		// tekee sivulle loppukoodit
-
-		print "</body>\n";
-		print "</html>";
-	}
-	
-	private function tulosta_tyyli()
-	{
-		// m??ritet??n ylim??r?iset tyyliasetukset divien v?rille
-
-		$varisyote = "r=" . $this->_r . "&g=" . $this->_g . "&b=" . $this->_b;
-
-		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
-		print "<style type=\"text/css\">
-
-		
-		div.SivuFrameSisalto, div.PaaFrame
-		{
-			background-color: rgb(" . $this->_r . ", " . $this->_g . ", " . $this->_b . ");
-		}
-
-		div.SivuFrameFade
-		{
-			background-image: url('fade.php?w=1&h=". $this->_fade_korkeus . "&" . $varisyote . "');
-			background-repeat: repeat-x;
-			background-position: top;
-			height: ". $this->_fade_korkeus . "px;
-		}
-
-		</style>";
-	}
-
-	// Listaa xml-tiedostokansion sis?ll?n sivu- ja p??framelle.
-	// Ottaa input-parametrina tiedon, onko kyse valikosta vai index viewist?
-	// $valikko = true --> valikko
-	// $valikko = false --> index view
-	
-	private function listaa_tiedostot($valikko = false)
-	{
-		if(file_exists($this->_xmlkansio))
-		{
-			$kansio = opendir($this->_xmlkansio);
-
-			$xml_array = array();
-
-			for($i=0; $tiedosto = readdir($kansio); $i++)
-			{
-				// selvitt?? tiedostop??tteen
-
-				$p_array = explode(".", $tiedosto);
-				$paate = $p_array[sizeof($p_array)-1];
-
-				if($i > 1 && ($paate == "xml"))
-				{
-					// parsii k?sitelt?v?n xml-tiedoston
-
-					$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $tiedosto);
-
-					// hakee parserista halutut tiedot taulukkoon
-
-					// hakualgoritmi etsii tiedon sen yl?otsikon kautta, joten funktiolle
-					// pit?? antaa kaksi parametria, sen l?hin yl?otsikko ja haettava tieto
-
-					if($valikko)
-					{
-						// n?m? arvot haetaan valikkoon
-
-						$temp_array = array("tiedosto" => $tiedosto,
-						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
-						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
-						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
-						"os" => $this->_parseri->hae_tieto("computer", "os"),
-						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"));
-					}
-					else
-					{
-						// n?m? arvot haetaan index viewiin
-
-						$temp_array = array("tiedosto" => $tiedosto,
-						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
-						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
-						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
-						"os" => $this->_parseri->hae_tieto("computer", "os"),
-						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"),
-						"script_version" => $this->_parseri->hae_tieto("script", "version"),
-						"ram" => $this->_parseri->hae_tieto("ram", "Physical RAM"),
-						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive"),
-						"device" => $this->_parseri->hae_tieto("iface", "Device"),
-						"ip" => $this->_parseri->hae_tieto("iface", "IPv4")
-						);
-					}
-
-					// lis?? tiedoston tiedot p??taulukkoon ja jatkaa tiedostojen l?pik?ymist?
-					array_push($xml_array, $temp_array);
-				}
-			}
-
-			// lajittelee koneet domaineittain
-
-			$domainit = $this->lajittele_array($xml_array, "domain");
-			$profilet = array();
-
-			// lajittelee koneet (alustavasti) profiileittain
-
-			foreach($domainit as $domain => $arvo)
-			{
-				$temp_array = array($domain => $this->lajittele_array($arvo, "profile"));
-				$this->array_lisaa_samaan($profilet, $temp_array);
-			}
-
-			ksort($profilet);
-
-			if($valikko)
-			{
-				foreach($profilet as $domain => $profiles)
-				{
-					// lajittelee koneet profiileittain
-					ksort($profiles);
-
-					// n?ytt?? tiedot valikossa domaineittain
-
-					print "<ul class=\"hostit\"><li>Domain: <i>" . $domain . "</i>";
-
-					foreach($profiles as $profile => $hostnames)
-					{
-						// n?ytt?? tiedot valikossa profiileittain
-
-						print "<ul class=\"hostit\"><li>Profile: <i>" . $profile . 
-							"</i><ul class=\"hostit\">";
-
-						// n?ytt?? halutut yksityiskohtaiset konetiedot valikossa
-
-						foreach($hostnames as $hostname => $arvot)
-						{
-							print "<li><b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
-								$arvot["hostname"] . "</a></b><ul class=\"hostit\">
-								<li class=\"kuvaus\">" . $arvot["os"] . "</li>
-								<li class=\"kuvaus\">" . $arvot["cpu"] . "</li>
-								</ul></li>";
-
-						}
-
-						// sulkee profiilien tagit
-						print "</ul></li></ul>";
-					}
-
-					// sulkee domainien tagit
-					print "</li></ul>";
-				}
-			}
-			else
-			{
-				foreach($profilet as $domain => $profiles)
-				{
-					// lajittelee koneet profiileittain
-					ksort($profiles);
-
-					// n?ytt?? tiedot valikossa domaineittain
-					print "<div class=\"kentta2\"><h3>Domain: <i>" . $domain . "</i>";
-
-					foreach($profiles as $profile => $hostnames)
-					{
-						// n?ytt?? tiedot valikossa profiileittain
-
-						print "<div class=\"kentta2\"><h3>Profile: <i>" . $profile . 
-							"</i><table class=\"attribuutti\" cellspacing=\"10\">";
-
-						$laskuri = 0;
-
-						// n?ytt?? kaikki yksityiskohtaiset konetiedot valikossa
-
-						foreach($hostnames as $hostname => $arvot)
-						{
-							if($laskuri == 0) 
-								print "<tr>";
-							elseif($laskuri % $this->_clientteja_rivilla == 0)
- 								print "</tr><tr>";
-
-							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
-
-							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
-								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
-
-							foreach($arvot as $tyyppi => $arvo)
-							{
-								if($tyyppi != "hostname" && $tyyppi != "domain" && $tyyppi != "profile" && $tyyppi != "tiedosto" && $arvo != "")
-								{
-									print "<li class=\"kuvaus\">" . $arvo . "</li>";
-								}
-							}
-
-							print "</ul></td>";
-
-							$laskuri++;
-						}
-
-						while($laskuri % $this->_clientteja_rivilla != 0)
-						{
-							print "<td>&nbsp;</td>";
-							$laskuri++;
-						}
-	
-						print "</table></h3></div>";
-					}
-	
-					print "</h3></div>";
-				}
-			}
-		}
-		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
-	}
-
-	// lajittelee taulukon halutun arvon mukaan, joka annetaan input-parametriin $nimi
-
-	private function lajittele_array($array, $nimi)
-	{
-		$nimet = array(" ");
-		$nimet_lajiteltuna = array();
-
-		foreach($array as $avain => $arvo)
-		{
-			if(is_array($arvo))
-			{
-				$loytyi = false;
-
-				for($i=0; $i < sizeof($nimet); $i++)
-					if($arvo[$nimi] == $nimet[$i]) $loytyi = true;
-
-				if(!$loytyi)
-				{
-					$temp_array = array($arvo[$nimi] => array());
-					$this->array_lisaa_samaan($nimet_lajiteltuna, $temp_array);
-					array_push($nimet, $arvo[$nimi]);
-				}
-				
-				array_push($nimet_lajiteltuna[$arvo[$nimi]], $arvo);
-			}
-		}
-
-		return $nimet_lajiteltuna;
-	}
-
-	// yleinen taulukon k?sittelyfunktio, joka php:st? itsest??n puuttuu
-
-	private function array_lisaa_samaan(&$array)
-	{
-		$argumentit = func_get_args();
-	
-		foreach($argumentit as $argumentti)
-		{
-			if(is_array($argumentti))
-			{
-				foreach($argumentti as $avain => $arvo)
-				{
-					$array[$avain] = $arvo;
-					$paluuarvo++;
-				}
-			}
-			else $array[$argumentti] = "";
-		}
-	
-		return $paluuarvo;
-	}
-
-	// k?y l?pi tiedostokansion ja palauttaa viimeksi muokatun tiedoston p?iv?m??r?n unixin aika-arvona
-
-	private function hae_viimeksi_paivitetty()
-	{
-		if(file_exists($this->_xmlkansio))
-		{
-			$kansio = opendir($this->_xmlkansio);
-	
-			$suurin = 0;
-		
-			for($i=0; $tiedosto = readdir($kansio); $i++)
-			{
-				$p_array = explode(".", $tiedosto);
-				$paate = $p_array[sizeof($p_array)-1];
-		
-				if($i > 1 && ($paate == "xml"))
-				{
-					$aika = filemtime($this->_xmlkansio . "/" . $tiedosto);
-	
-					if($aika > $suurin)
-						$suurin = $aika;
-				}
-			}
-			
-			return $suurin;
-		}
-	}
-
-	// n?ytt?? sivuframen sis?ll?n
-	
-	public function nayta_sivuframe()
-	{
-		print "<div class=\"SivuFrame\">";
-		print "<div class=\"SivuFrameSisalto\">";
-
-		print "<h3>OS info</h3>
-			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
-			<hr />";
-
-		// listaa xml-tiedostokansion sis?ll?n sivuframelle
-		$this->listaa_tiedostot(true);
-	
-		print "<hr />";
-
-		$this->paivitys();
-
-		print "<hr />";
-
-		print "<p>Last update:</p>";
-
-		// hakee viimeksi p?ivitetyn tiedoston aika-arvon
-		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
-
-		if($viimeksi_paivitetty > 0)
-			// n?ytt?? viimeksi p?ivitetyn tiedoston p?iv?yksen ja ajan
-			print "<p><i>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</i></p>";
-	
-		print "</div>";
-
-		print "<div class=\"SivuFrameFade\"></div>";
-
-		print "</div>";
-	}
-	
-	// n?ytt?? p??framen sis?ll?n
-
-	public function nayta_paaframe($sivu = "")
-	{
-		print "<div class=\"PaaFrame\">";
-		
-		// jos osoiterivin target-arvo on m??ritelty, kokeilee n?ytt?? sivun sis?ll?n p??frameen
-
-		if($sivu != "")
-		{
-			// tarkistaa ensin, ett? tiedosto on olemassa
-			if(file_exists($this->_xmlkansio . "/" . $sivu))
-			{
-				// parsii xml-tiedoston l?pi
-				$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $sivu);
-
-				// n?ytt?? xml:st? "osinfo" tagien sis?ll? olevan tiedon
-				$this->_parseri->hae_arvot("osinfo");
-			}
-			else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
-		}
-		else
-			// jos osoiterivin target-arvoa ei ole m??ritelty, n?ytt?? index viewin
-			$this->nayta_index_view();
-
-		print "</div>";
-	}
-
-	private function nayta_index_view()
-	{
-		print "<h3>index view</h3>";
-
-		// listaa xml-kansion tiedostot p??framelle
-		$this->listaa_tiedostot(false);
-	}
-
-	private function paivitys()
-	{
-		if($_POST['paivitettava_client'])
-			print "<p>-- update " . $_POST['paivitettava_client'] . " --</p>";
-
-		print "<form name=\"paivitysformi\" action=\"" . $PHP_SELF . "\" method=\"post\">
-			<p>Client: 
-				<input type=\"text\" name=\"paivitettava_client\" /><br /><br />
-				<input type=\"submit\" value=\"Update\" />
-			</p>
-			</form>";
-	}
-}
-
-?> 
\ No newline at end of file

Added: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 11:56:36 UTC (rev 702)
+++ trunk/osinfo/html/index.php	2007-03-12 11:58:42 UTC (rev 703)
@@ -0,0 +1,448 @@
+<?php
+
+// luodaan Index-olio. Input-parametrit:
+
+// $xmlkansio, kansio jossa kaikki xml-tiedostot sijaitsevat
+// $r, divien taustav?rin punaisen arvo
+// $g, divien taustav?rin vihre?n arvo
+// $b, divien taustav?rin sinisen arvo
+// $fade_korkeus, sivuframen alla olevan fade-kuvan korkeus
+// $clienteja_rivilla, index viewin clienttien lukum??r? rivill?
+
+$index = new Index("hosts", 222, 197, 148, 150, 3);
+
+$index->tulosta_alkukoodi(true);
+$index->nayta_sivuframe();
+$index->nayta_paaframe($_GET['target']);
+$index->tulosta_loppukoodi();
+
+class Index
+{
+	private $_xmlkansio;
+	private $_xmlparseri = "xml-parseri.php";
+	private $_parseri;
+	private $_clientteja_rivilla;
+	private $_r;
+	private $_g;
+	private $_b;
+	private $_fade_korkeus;
+
+	public function __construct($xmlkansio, $r, $g, $b, $fade_korkeus, $clientteja_rivilla)
+	{
+		// sijoitetaan input-parametrit luokan j?senmuuttujiin
+
+		$this->_xmlkansio = $xmlkansio;
+		$this->_r = $r;
+		$this->_g = $g;
+		$this->_b = $b;
+		$this->_fade_korkeus = $fade_korkeus;
+		$this->_clientteja_rivilla = $clientteja_rivilla;
+
+		// tarkistetaan, xmlparseri on olemassa ja luodaan siit? olio
+
+		if(file_exists($this->_xmlparseri))
+		{
+			include($this->_xmlparseri);
+
+			$this->_parseri = new xmlparseri();
+		}
+		else print "<p class=\"valitus\">Cannot find file \"" . $this->_xmlparseri . "\"</p>";
+	}
+
+	public function tulosta_alkukoodi($tyylit = true)
+	{
+		// tekee sivulle alkukoodit
+	
+		print "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n\n";
+
+		print "<html>\n";	
+		print "<head>\n";	
+		print "<title>OS info</title>\n\n";
+
+		if($tyylit) $this->tulosta_tyyli();
+
+		print "\n\n</head>\n\n";
+		print "<body>\n\n";
+	}
+
+	public function tulosta_loppukoodi()
+	{
+		// tekee sivulle loppukoodit
+
+		print "</body>\n";
+		print "</html>";
+	}
+	
+	private function tulosta_tyyli()
+	{
+		// m??ritet??n ylim??r?iset tyyliasetukset divien v?rille
+
+		$varisyote = "r=" . $this->_r . "&g=" . $this->_g . "&b=" . $this->_b;
+
+		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
+		print "<style type=\"text/css\">
+
+		
+		div.SivuFrameSisalto, div.PaaFrame
+		{
+			background-color: rgb(" . $this->_r . ", " . $this->_g . ", " . $this->_b . ");
+		}
+
+		div.SivuFrameFade
+		{
+			background-image: url('fade.php?w=1&h=". $this->_fade_korkeus . "&" . $varisyote . "');
+			background-repeat: repeat-x;
+			background-position: top;
+			height: ". $this->_fade_korkeus . "px;
+		}
+
+		</style>";
+	}
+
+	// Listaa xml-tiedostokansion sis?ll?n sivu- ja p??framelle.
+	// Ottaa input-parametrina tiedon, onko kyse valikosta vai index viewist?
+	// $valikko = true --> valikko
+	// $valikko = false --> index view
+	
+	private function listaa_tiedostot($valikko = false)
+	{
+		if(file_exists($this->_xmlkansio))
+		{
+			$kansio = opendir($this->_xmlkansio);
+
+			$xml_array = array();
+
+			for($i=0; $tiedosto = readdir($kansio); $i++)
+			{
+				// selvitt?? tiedostop??tteen
+
+				$p_array = explode(".", $tiedosto);
+				$paate = $p_array[sizeof($p_array)-1];
+
+				if($i > 1 && ($paate == "xml"))
+				{
+					// parsii k?sitelt?v?n xml-tiedoston
+
+					$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $tiedosto);
+
+					// hakee parserista halutut tiedot taulukkoon
+
+					// hakualgoritmi etsii tiedon sen yl?otsikon kautta, joten funktiolle
+					// pit?? antaa kaksi parametria, sen l?hin yl?otsikko ja haettava tieto
+
+					if($valikko)
+					{
+						// n?m? arvot haetaan valikkoon
+
+						$temp_array = array("tiedosto" => $tiedosto,
+						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
+						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
+						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
+						"os" => $this->_parseri->hae_tieto("computer", "os"),
+						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"));
+					}
+					else
+					{
+						// n?m? arvot haetaan index viewiin
+
+						$temp_array = array("tiedosto" => $tiedosto,
+						"hostname" => $this->_parseri->hae_tieto("computer", "hostname"),
+						"domain" => $this->_parseri->hae_tieto("computer", "domain"),
+						"profile" => $this->_parseri->hae_tieto("computer", "profile"),
+						"os" => $this->_parseri->hae_tieto("computer", "os"),
+						"cpu" => $this->_parseri->hae_tieto("computer", "cpu"),
+						"script_version" => $this->_parseri->hae_tieto("script", "version"),
+						"ram" => $this->_parseri->hae_tieto("ram", "Physical RAM"),
+						"drive" => $this->_parseri->hae_tieto("drive", "SATA/SCSI drive"),
+						"device" => $this->_parseri->hae_tieto("iface", "Device"),
+						"ip" => $this->_parseri->hae_tieto("iface", "IPv4")
+						);
+					}
+
+					// lis?? tiedoston tiedot p??taulukkoon ja jatkaa tiedostojen l?pik?ymist?
+					array_push($xml_array, $temp_array);
+				}
+			}
+
+			// lajittelee koneet domaineittain
+
+			$domainit = $this->lajittele_array($xml_array, "domain");
+			$profilet = array();
+
+			// lajittelee koneet (alustavasti) profiileittain
+
+			foreach($domainit as $domain => $arvo)
+			{
+				$temp_array = array($domain => $this->lajittele_array($arvo, "profile"));
+				$this->array_lisaa_samaan($profilet, $temp_array);
+			}
+
+			ksort($profilet);
+
+			if($valikko)
+			{
+				foreach($profilet as $domain => $profiles)
+				{
+					// lajittelee koneet profiileittain
+					ksort($profiles);
+
+					// n?ytt?? tiedot valikossa domaineittain
+
+					print "<ul class=\"hostit\"><li>Domain: <i>" . $domain . "</i>";
+
+					foreach($profiles as $profile => $hostnames)
+					{
+						// n?ytt?? tiedot valikossa profiileittain
+
+						print "<ul class=\"hostit\"><li>Profile: <i>" . $profile . 
+							"</i><ul class=\"hostit\">";
+
+						// n?ytt?? halutut yksityiskohtaiset konetiedot valikossa
+
+						foreach($hostnames as $hostname => $arvot)
+						{
+							print "<li><b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
+								$arvot["hostname"] . "</a></b><ul class=\"hostit\">
+								<li class=\"kuvaus\">" . $arvot["os"] . "</li>
+								<li class=\"kuvaus\">" . $arvot["cpu"] . "</li>
+								</ul></li>";
+
+						}
+
+						// sulkee profiilien tagit
+						print "</ul></li></ul>";
+					}
+
+					// sulkee domainien tagit
+					print "</li></ul>";
+				}
+			}
+			else
+			{
+				foreach($profilet as $domain => $profiles)
+				{
+					// lajittelee koneet profiileittain
+					ksort($profiles);
+
+					// n?ytt?? tiedot valikossa domaineittain
+					print "<div class=\"kentta2\"><h3>Domain: <i>" . $domain . "</i>";
+
+					foreach($profiles as $profile => $hostnames)
+					{
+						// n?ytt?? tiedot valikossa profiileittain
+
+						print "<div class=\"kentta2\"><h3>Profile: <i>" . $profile . 
+							"</i><table class=\"attribuutti\" cellspacing=\"10\">";
+
+						$laskuri = 0;
+
+						// n?ytt?? kaikki yksityiskohtaiset konetiedot valikossa
+
+						foreach($hostnames as $hostname => $arvot)
+						{
+							if($laskuri == 0) 
+								print "<tr>";
+							elseif($laskuri % $this->_clientteja_rivilla == 0)
+ 								print "</tr><tr>";
+
+							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
+
+							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
+								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
+
+							foreach($arvot as $tyyppi => $arvo)
+							{
+								if($tyyppi != "hostname" && $tyyppi != "domain" && $tyyppi != "profile" && $tyyppi != "tiedosto" && $arvo != "")
+								{
+									print "<li class=\"kuvaus\">" . $arvo . "</li>";
+								}
+							}
+
+							print "</ul></td>";
+
+							$laskuri++;
+						}
+
+						while($laskuri % $this->_clientteja_rivilla != 0)
+						{
+							print "<td>&nbsp;</td>";
+							$laskuri++;
+						}
+	
+						print "</table></h3></div>";
+					}
+	
+					print "</h3></div>";
+				}
+			}
+		}
+		else print "<p class=\"valitus\">Directory \"" . $this->_xmlkansio . "\" does not exist</p>";
+	}
+
+	// lajittelee taulukon halutun arvon mukaan, joka annetaan input-parametriin $nimi
+
+	private function lajittele_array($array, $nimi)
+	{
+		$nimet = array(" ");
+		$nimet_lajiteltuna = array();
+
+		foreach($array as $avain => $arvo)
+		{
+			if(is_array($arvo))
+			{
+				$loytyi = false;
+
+				for($i=0; $i < sizeof($nimet); $i++)
+					if($arvo[$nimi] == $nimet[$i]) $loytyi = true;
+
+				if(!$loytyi)
+				{
+					$temp_array = array($arvo[$nimi] => array());
+					$this->array_lisaa_samaan($nimet_lajiteltuna, $temp_array);
+					array_push($nimet, $arvo[$nimi]);
+				}
+				
+				array_push($nimet_lajiteltuna[$arvo[$nimi]], $arvo);
+			}
+		}
+
+		return $nimet_lajiteltuna;
+	}
+
+	// yleinen taulukon k?sittelyfunktio, joka php:st? itsest??n puuttuu
+
+	private function array_lisaa_samaan(&$array)
+	{
+		$argumentit = func_get_args();
+	
+		foreach($argumentit as $argumentti)
+		{
+			if(is_array($argumentti))
+			{
+				foreach($argumentti as $avain => $arvo)
+				{
+					$array[$avain] = $arvo;
+					$paluuarvo++;
+				}
+			}
+			else $array[$argumentti] = "";
+		}
+	
+		return $paluuarvo;
+	}
+
+	// k?y l?pi tiedostokansion ja palauttaa viimeksi muokatun tiedoston p?iv?m??r?n unixin aika-arvona
+
+	private function hae_viimeksi_paivitetty()
+	{
+		if(file_exists($this->_xmlkansio))
+		{
+			$kansio = opendir($this->_xmlkansio);
+	
+			$suurin = 0;
+		
+			for($i=0; $tiedosto = readdir($kansio); $i++)
+			{
+				$p_array = explode(".", $tiedosto);
+				$paate = $p_array[sizeof($p_array)-1];
+		
+				if($i > 1 && ($paate == "xml"))
+				{
+					$aika = filemtime($this->_xmlkansio . "/" . $tiedosto);
+	
+					if($aika > $suurin)
+						$suurin = $aika;
+				}
+			}
+			
+			return $suurin;
+		}
+	}
+
+	// n?ytt?? sivuframen sis?ll?n
+	
+	public function nayta_sivuframe()
+	{
+		print "<div class=\"SivuFrame\">";
+		print "<div class=\"SivuFrameSisalto\">";
+
+		print "<h3>OS info</h3>
+			<p><a href=\"" . $_SERVER["SCRIPT_NAME"] . "\">index view</a></p>
+			<hr />";
+
+		// listaa xml-tiedostokansion sis?ll?n sivuframelle
+		$this->listaa_tiedostot(true);
+	
+		print "<hr />";
+
+		$this->paivitys();
+
+		print "<hr />";
+
+		print "<p>Last update:</p>";
+
+		// hakee viimeksi p?ivitetyn tiedoston aika-arvon
+		$viimeksi_paivitetty = $this->hae_viimeksi_paivitetty();
+
+		if($viimeksi_paivitetty > 0)
+			// n?ytt?? viimeksi p?ivitetyn tiedoston p?iv?yksen ja ajan
+			print "<p><i>" . date("F d Y H:i:s", $viimeksi_paivitetty) . "</i></p>";
+	
+		print "</div>";
+
+		print "<div class=\"SivuFrameFade\"></div>";
+
+		print "</div>";
+	}
+	
+	// n?ytt?? p??framen sis?ll?n
+
+	public function nayta_paaframe($sivu = "")
+	{
+		print "<div class=\"PaaFrame\">";
+		
+		// jos osoiterivin target-arvo on m??ritelty, kokeilee n?ytt?? sivun sis?ll?n p??frameen
+
+		if($sivu != "")
+		{
+			// tarkistaa ensin, ett? tiedosto on olemassa
+			if(file_exists($this->_xmlkansio . "/" . $sivu))
+			{
+				// parsii xml-tiedoston l?pi
+				$this->_parseri->parsi_tiedosto($this->_xmlkansio . "/" . $sivu);
+
+				// n?ytt?? xml:st? "osinfo" tagien sis?ll? olevan tiedon
+				$this->_parseri->hae_arvot("osinfo");
+			}
+			else print "<p class=\"valitus\">File \"" . $sivu . "\" not found</p>";
+		}
+		else
+			// jos osoiterivin target-arvoa ei ole m??ritelty, n?ytt?? index viewin
+			$this->nayta_index_view();
+
+		print "</div>";
+	}
+
+	private function nayta_index_view()
+	{
+		print "<h3>index view</h3>";
+
+		// listaa xml-kansion tiedostot p??framelle
+		$this->listaa_tiedostot(false);
+	}
+
+	private function paivitys()
+	{
+		if($_POST['paivitettava_client'])
+			print "<p>-- update " . $_POST['paivitettava_client'] . " --</p>";
+
+		print "<form name=\"paivitysformi\" action=\"" . $PHP_SELF . "\" method=\"post\">
+			<p>Client: 
+				<input type=\"text\" name=\"paivitettava_client\" /><br /><br />
+				<input type=\"submit\" value=\"Update\" />
+			</p>
+			</form>";
+	}
+}
+
+?> 
\ No newline at end of file



From lamikae at mail.berlios.de  Mon Mar 12 13:11:30 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 13:11:30 +0100
Subject: [Osinfo-commit] r704 - trunk/osinfo/html
Message-ID: <200703121211.l2CCBUC2031343@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 13:11:28 +0100 (Mon, 12 Mar 2007)
New Revision: 704

Added:
   trunk/osinfo/html/tyylit.css
Removed:
   trunk/osinfo/html/tyylit.css
   trunk/osinfo/html/xmltyyli.css
Modified:
   trunk/osinfo/html/index.php
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 11:58:42 UTC (rev 703)
+++ trunk/osinfo/html/index.php	2007-03-12 12:11:28 UTC (rev 704)
@@ -79,7 +79,7 @@
 
 		$varisyote = "r=" . $this->_r . "&g=" . $this->_g . "&b=" . $this->_b;
 
-		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"xmltyyli.css\" />";
+		print "<link rel=\"stylesheet\" type=\"text/css\" href=\"tyylit.css\" />";
 		print "<style type=\"text/css\">
 
 		

Deleted: trunk/osinfo/html/tyylit.css
===================================================================
--- trunk/osinfo/html/tyylit.css	2007-03-12 11:58:42 UTC (rev 703)
+++ trunk/osinfo/html/tyylit.css	2007-03-12 12:11:28 UTC (rev 704)
@@ -1,117 +0,0 @@
-body
-{
-	background-color: #eddcbc;
-}
-
-div.SivuFrame, div.PaaFrame
-{
-	float: left;
-}
-
-div.SivuFrameSisalto
-{
-	padding: 10px;
-}
-
-div.SivuFrame
-{
-	margin-left: 10px;
-	margin-top: 10px;
-	margin-bottom: 10px;
-	width: 20%;
-	min-height: 500;
-	min-width: 200;
-	height: auto;
-}
-
-div.PaaFrame
-{
-	border: 1px solid black;
-	padding: 5px;
-	padding: 0px 10px 10px 10px;
-	margin-left: 10px;
-	margin-top: 10px;
-	margin-bottom: 10px;
-	width: 70%;
-	min-height: 500;
-	min-width: 600;
-	height: auto;
-	clear: none;
-}
-
-p.valitus
-{
-	color: red;
-}
-
-ul.hostit
-{
-	padding: 0px;
-	padding-left: 10px;
-}
-
-li.kuvaus
-{
-	font-size: 12px;
-}
-
-a:link
-{
-	color: rgb(0,0,255);
-}
-
-a:visited
-{
-	color: rgb(0,0,200);
-}
-
-td.lista_description, td.lista_value, div.kentta, div.kentta2
-{
-	background-color: #e9fbf7;
-}
-
-td.attribuutti_td, table.lista_attribuutti
-{
-	background-color: #8db7ae;
-}
-
-div.kentta, div.kentta2
-{
-	font-size: 13px;
-	border: 1px dashed black;
-	margin-top: 10px;
-}
-
-div.kentta
-{
-	padding: 0px 10px 10px 10px;
-}
-
-div.kentta2
-{
-	padding: 0px 10px 5px 10px;
-}
-
-table.attribuutti, table.lista_attribuutti
-{
-	width: 100%;
-}
-
-td.attribuutti_td
-{
-	margin: 5px 5px 5px 5px;
-	border: 1px dotted black;
-	padding: 7px;
-}
-
-td.lista_description
-{
-	width: 30%;
-}
-
-table.value
-{
-	padding: 0px;
-	margin: 0px;
-}
-

Added: trunk/osinfo/html/tyylit.css
===================================================================
--- trunk/osinfo/html/tyylit.css	2007-03-12 11:58:42 UTC (rev 703)
+++ trunk/osinfo/html/tyylit.css	2007-03-12 12:11:28 UTC (rev 704)
@@ -0,0 +1,117 @@
+body
+{
+	background-color: #eddcbc;
+}
+
+div.SivuFrame, div.PaaFrame
+{
+	float: left;
+}
+
+div.SivuFrameSisalto
+{
+	padding: 10px;
+}
+
+div.SivuFrame
+{
+	margin-left: 10px;
+	margin-top: 10px;
+	margin-bottom: 10px;
+	width: 20%;
+	min-height: 500;
+	min-width: 200;
+	height: auto;
+}
+
+div.PaaFrame
+{
+	border: 1px solid black;
+	padding: 5px;
+	padding: 0px 10px 10px 10px;
+	margin-left: 10px;
+	margin-top: 10px;
+	margin-bottom: 10px;
+	width: 70%;
+	min-height: 500;
+	min-width: 600;
+	height: auto;
+	clear: none;
+}
+
+p.valitus
+{
+	color: red;
+}
+
+ul.hostit
+{
+	padding: 0px;
+	padding-left: 10px;
+}
+
+li.kuvaus
+{
+	font-size: 12px;
+}
+
+a:link
+{
+	color: rgb(0,0,255);
+}
+
+a:visited
+{
+	color: rgb(0,0,200);
+}
+
+td.lista_description, td.lista_value, div.kentta, div.kentta2
+{
+	background-color: #e9fbf7;
+}
+
+td.attribuutti_td, table.lista_attribuutti
+{
+	background-color: #8db7ae;
+}
+
+div.kentta, div.kentta2
+{
+	font-size: 13px;
+	border: 1px dashed black;
+	margin-top: 10px;
+}
+
+div.kentta
+{
+	padding: 0px 10px 10px 10px;
+}
+
+div.kentta2
+{
+	padding: 0px 10px 5px 10px;
+}
+
+table.attribuutti, table.lista_attribuutti
+{
+	width: 100%;
+}
+
+td.attribuutti_td
+{
+	margin: 5px 5px 5px 5px;
+	border: 1px dotted black;
+	padding: 7px;
+}
+
+td.lista_description
+{
+	width: 30%;
+}
+
+table.value
+{
+	padding: 0px;
+	margin: 0px;
+}
+

Deleted: trunk/osinfo/html/xmltyyli.css
===================================================================
--- trunk/osinfo/html/xmltyyli.css	2007-03-12 11:58:42 UTC (rev 703)
+++ trunk/osinfo/html/xmltyyli.css	2007-03-12 12:11:28 UTC (rev 704)
@@ -1,50 +0,0 @@
-td.lista_description, td.lista_value, div.kentta, div.kentta2
-{
-	background-color: #e9fbf7;
-}
-
-td.attribuutti_td, table.lista_attribuutti
-{
-	background-color: #8db7ae;
-}
-
-div.kentta, div.kentta2
-{
-	font-size: 13px;
-	border: 1px dashed black;
-	margin-top: 10px;
-}
-
-div.kentta
-{
-	padding: 0px 10px 10px 10px;
-}
-
-div.kentta2
-{
-	padding: 0px 10px 5px 10px;
-}
-
-table.attribuutti, table.lista_attribuutti
-{
-	width: 100%;
-}
-
-td.attribuutti_td
-{
-	margin: 5px 5px 5px 5px;
-	border: 1px dotted black;
-	padding: 7px;
-}
-
-td.lista_description
-{
-	width: 30%;
-}
-
-table.value
-{
-	padding: 0px;
-	margin: 0px;
-}
-



From lamikae at mail.berlios.de  Mon Mar 12 13:24:59 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 13:24:59 +0100
Subject: [Osinfo-commit] r705 - trunk/osinfo/html
Message-ID: <200703121224.l2CCOxcu012406@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 13:24:57 +0100 (Mon, 12 Mar 2007)
New Revision: 705

Modified:
   trunk/osinfo/html/index.php
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 12:11:28 UTC (rev 704)
+++ trunk/osinfo/html/index.php	2007-03-12 12:24:57 UTC (rev 705)
@@ -280,7 +280,6 @@
 	}
 
 	// lajittelee taulukon halutun arvon mukaan, joka annetaan input-parametriin $nimi
-
 	private function lajittele_array($array, $nimi)
 	{
 		$nimet = array(" ");
@@ -310,7 +309,6 @@
 	}
 
 	// yleinen taulukon k?sittelyfunktio, joka php:st? itsest??n puuttuu
-
 	private function array_lisaa_samaan(&$array)
 	{
 		$argumentit = func_get_args();
@@ -332,7 +330,6 @@
 	}
 
 	// k?y l?pi tiedostokansion ja palauttaa viimeksi muokatun tiedoston p?iv?m??r?n unixin aika-arvona
-
 	private function hae_viimeksi_paivitetty()
 	{
 		if(file_exists($this->_xmlkansio))
@@ -359,8 +356,7 @@
 		}
 	}
 
-	// n?ytt?? sivuframen sis?ll?n
-	
+	// n?ytt?? sivuframen sis?ll?n	
 	public function nayta_sivuframe()
 	{
 		print "<div class=\"SivuFrame\">";
@@ -396,7 +392,6 @@
 	}
 	
 	// n?ytt?? p??framen sis?ll?n
-
 	public function nayta_paaframe($sivu = "")
 	{
 		print "<div class=\"PaaFrame\">";
@@ -431,6 +426,7 @@
 		$this->listaa_tiedostot(false);
 	}
 
+	// t?m?n funktion alle tulisi xml-tiedostojen p?ivitys
 	private function paivitys()
 	{
 		if($_POST['paivitettava_client'])



From lamikae at mail.berlios.de  Mon Mar 12 13:46:29 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 13:46:29 +0100
Subject: [Osinfo-commit] r706 - trunk/osinfo/html
Message-ID: <200703121246.l2CCkTZ3015337@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 13:46:28 +0100 (Mon, 12 Mar 2007)
New Revision: 706

Modified:
   trunk/osinfo/html/index.php
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 12:24:57 UTC (rev 705)
+++ trunk/osinfo/html/index.php	2007-03-12 12:46:28 UTC (rev 706)
@@ -119,7 +119,7 @@
 				$p_array = explode(".", $tiedosto);
 				$paate = $p_array[sizeof($p_array)-1];
 
-				if($i > 1 && ($paate == "xml"))
+				if($i > 1 && $tiedosto != ".xml" && $paate == "xml")
 				{
 					// parsii k?sitelt?v?n xml-tiedoston
 



From lamikae at mail.berlios.de  Mon Mar 12 14:43:24 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Mon, 12 Mar 2007 14:43:24 +0100
Subject: [Osinfo-commit] r707 - trunk/osinfo/html
Message-ID: <200703121343.l2CDhOxE022277@sheep.berlios.de>

Author: lamikae
Date: 2007-03-12 14:43:23 +0100 (Mon, 12 Mar 2007)
New Revision: 707

Modified:
   trunk/osinfo/html/index.php
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 12:46:28 UTC (rev 706)
+++ trunk/osinfo/html/index.php	2007-03-12 13:43:23 UTC (rev 707)
@@ -248,8 +248,12 @@
 							print "<td valign=\"top\" class=\"attribuutti_td\" style=\"width: " . round(100 / $this->_clientteja_rivilla, 1) . "%\">";
 
 							print "<b><a href=\"?target=". $arvot["tiedosto"] . "\">" .
-								$arvot["hostname"] . "</a></b><ul class=\"hostit\">";
+								$arvot["hostname"] . "</a></b><p>";
 
+							$this->paivitys($arvot["tiedosto"]);
+
+							print "</p><ul class=\"hostit\">";
+
 							foreach($arvot as $tyyppi => $arvo)
 							{
 								if($tyyppi != "hostname" && $tyyppi != "domain" && $tyyppi != "profile" && $tyyppi != "tiedosto" && $arvo != "")
@@ -371,10 +375,6 @@
 	
 		print "<hr />";
 
-		$this->paivitys();
-
-		print "<hr />";
-
 		print "<p>Last update:</p>";
 
 		// hakee viimeksi p?ivitetyn tiedoston aika-arvon
@@ -427,16 +427,18 @@
 	}
 
 	// t?m?n funktion alle tulisi xml-tiedostojen p?ivitys
-	private function paivitys()
+	private function paivitys($tiedosto)
 	{
 		if($_POST['paivitettava_client'])
-			print "<p>-- update " . $_POST['paivitettava_client'] . " --</p>";
+		{
+			// t?h?n tulee suoritettava osa sy?tteest?...
 
-		print "<form name=\"paivitysformi\" action=\"" . $PHP_SELF . "\" method=\"post\">
-			<p>Client: 
-				<input type=\"text\" name=\"paivitettava_client\" /><br /><br />
-				<input type=\"submit\" value=\"Update\" />
-			</p>
+			//print "<p>-- update " . $_POST['paivitettava_client'] . " --</p>";
+		}
+
+		print "<form name=\"paivitysformi[" . $tiedosto . "]\" action=\"" . $PHP_SELF . "\" method=\"post\">
+			<input type=\"submit\" value=\"Update\" />
+			<input type=\"submit\" value=\"Delete\" />
 			</form>";
 	}
 }



From lamikae at mail.berlios.de  Fri Mar 23 12:29:27 2007
From: lamikae at mail.berlios.de (lamikae at mail.berlios.de)
Date: Fri, 23 Mar 2007 12:29:27 +0100
Subject: [Osinfo-commit] r708 - trunk/osinfo/html
Message-ID: <200703231129.l2NBTRYV027499@sheep.berlios.de>

Author: lamikae
Date: 2007-03-23 12:29:25 +0100 (Fri, 23 Mar 2007)
New Revision: 708

Modified:
   trunk/osinfo/html/index.php
Log:
p?\195?\164ivitys

Modified: trunk/osinfo/html/index.php
===================================================================
--- trunk/osinfo/html/index.php	2007-03-12 13:43:23 UTC (rev 707)
+++ trunk/osinfo/html/index.php	2007-03-23 11:29:25 UTC (rev 708)
@@ -38,6 +38,9 @@
 		$this->_fade_korkeus = $fade_korkeus;
 		$this->_clientteja_rivilla = $clientteja_rivilla;
 
+		// p?ivitys- ja poistotoiminnot
+		$this->kasittele_lomakkeet();
+
 		// tarkistetaan, xmlparseri on olemassa ja luodaan siit? olio
 
 		if(file_exists($this->_xmlparseri))
@@ -426,20 +429,42 @@
 		$this->listaa_tiedostot(false);
 	}
 
-	// t?m?n funktion alle tulisi xml-tiedostojen p?ivitys
 	private function paivitys($tiedosto)
 	{
+		print "<form name=\"formi\" action=\"" . $PHP_SELF . "\" method=\"post\">
+			<input name=\"paivitettava_client[" . $tiedosto . "]\" type=\"submit\" value=\"Update\" />
+			<input name=\"poistettava_client[" . $tiedosto . "]\" type=\"submit\" value=\"Delete\" />
+			</form>";
+	}
+
+	private function kasittele_lomakkeet()
+	{
+		// $_POST-arvossa on tullut p?ivitett?v?n clientin nimi
 		if($_POST['paivitettava_client'])
 		{
-			// t?h?n tulee suoritettava osa sy?tteest?...
+			foreach($_POST['paivitettava_client'] as $avain => $arvo)
+			{
+				$tiedosto = $this->_xmlkansio . "/" . $avain;
 
-			//print "<p>-- update " . $_POST['paivitettava_client'] . " --</p>";
+				// t?h?n tulee p?ivitys
+				print "update: " . $tiedosto . "<br />";
+			}
 		}
 
-		print "<form name=\"paivitysformi[" . $tiedosto . "]\" action=\"" . $PHP_SELF . "\" method=\"post\">
-			<input type=\"submit\" value=\"Update\" />
-			<input type=\"submit\" value=\"Delete\" />
-			</form>";
+		// $_POST-arvossa on tullut poistettavan clientin nimi
+		if($_POST['poistettava_client'])
+		{
+			foreach($_POST['poistettava_client'] as $avain => $arvo)
+			{
+				$tiedosto = $this->_xmlkansio . "/" . $avain;
+
+				// jos tiedosto on olemassa, yritet??n poistaa se
+				if(file_exists($tiedosto))
+					if(unlink($tiedosto))
+						print $tiedosto . " deleted.<br />";
+					else print "<p class=\"valitus\">Couldn't remove \"" . $tiedosto . "\"</p>";
+			}
+		}
 	}
 }
 



